<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
 <!--<![endif]-->
 <head>
  <meta content="noindex" name="robots"/>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   torch.utils.cpp_extension — PyTorch 2.7 documentation
  </title>
  <link href="https://pytorch.org/docs/stable/_modules/torch/utils/cpp_extension.html" rel="canonical"/>
  <link href="../../../_static/css/theme.css" rel="stylesheet" type="text/css"/>
  <!-- <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" /> -->
  <link href="../../../_static/pygments.css" rel="stylesheet" type="text/css"/>
  <link href="../../../_static/css/theme.css" rel="stylesheet" type="text/css"/>
  <link href="../../../_static/copybutton.css" rel="stylesheet" type="text/css"/>
  <link href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" rel="stylesheet" type="text/css"/>
  <link href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" rel="stylesheet" type="text/css"/>
  <link href="../../../_static/katex-math.css" rel="stylesheet" type="text/css"/>
  <link href="../../../_static/sphinx-dropdown.css" rel="stylesheet" type="text/css"/>
  <link href="../../../_static/panels-bootstrap.min.css" rel="stylesheet" type="text/css"/>
  <link href="../../../_static/css/jit.css" rel="stylesheet" type="text/css"/>
  <link href="../../../_static/css/custom.css" rel="stylesheet" type="text/css"/>
  <link href="../../../genindex.html" rel="index" title="Index"/>
  <link href="../../../search.html" rel="search" title="Search"/>
  <!-- Google Tag Manager -->
  <script>
   (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-T8XT4PS');
  </script>
  <!-- End Google Tag Manager -->
  <script src="../../../_static/js/modernizr.min.js">
  </script>
  <!-- Preload the theme fonts -->
  <link as="font" crossorigin="anonymous" href="../../../_static/fonts/FreightSans/freight-sans-book.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="../../../_static/fonts/FreightSans/freight-sans-medium.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="../../../_static/fonts/FreightSans/freight-sans-bold.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" rel="preload" type="font/woff2"/>
  <!-- Preload the katex fonts -->
  <link as="font" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" rel="preload" type="font/woff2"/>
  <link as="font" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" rel="preload" type="font/woff2"/>
  <link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" rel="stylesheet"/>
 </head>
 <div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
   <div class="header-container">
    <a aria-label="PyTorch" class="header-logo" href="https://pytorch.org/">
    </a>
    <div class="main-menu">
     <ul>
      <li class="main-menu-item">
       <div class="resources-dropdown" data-toggle="resources-dropdown" id="resourcesDropdownButton">
        <a class="with-down-arrow">
         Learn
        </a>
        <div class="resources-dropdown-menu">
         <a class="nav-dropdown-item" href="https://pytorch.org/get-started">
          <span class="dropdown-title">
           Get Started
          </span>
          <p>
           Run PyTorch locally or get started quickly with one of the supported cloud platforms
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/tutorials">
          <span class="dropdown-title">
           Tutorials
          </span>
          <p>
           Whats new in PyTorch tutorials
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/basics/intro.html">
          <span class="dropdown-title">
           Learn the Basics
          </span>
          <p>
           Familiarize yourself with PyTorch concepts and modules
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/recipes/recipes_index.html">
          <span class="dropdown-title">
           PyTorch Recipes
          </span>
          <p>
           Bite-size, ready-to-deploy PyTorch code examples
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/tutorials/beginner/introyt.html">
          <span class="dropdown-title">
           Intro to PyTorch - YouTube Series
          </span>
          <p>
           Master PyTorch basics with our engaging YouTube tutorial series
          </p>
         </a>
        </div>
       </div>
      </li>
      <li>
       <div class="resources-dropdown" data-toggle="resources-dropdown" id="resourcesDropdownButton">
        <a class="with-down-arrow">
         Ecosystem
        </a>
        <div class="resources-dropdown-menu">
         <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem">
          <span class="dropdown-title">
           Tools
          </span>
          <p>
           Learn about the tools and frameworks in the PyTorch Ecosystem
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
          <span class="dropdown-title">
           Community
          </span>
          <p>
           Join the PyTorch developer community to contribute, learn, and get your questions answered
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
          <span class="dropdown-title">
           Forums
          </span>
          <p>
           A place to discuss PyTorch code, issues, install, research
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/resources">
          <span class="dropdown-title">
           Developer Resources
          </span>
          <p>
           Find resources and get questions answered
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/ecosystem/contributor-awards-2024">
          <span class="dropdown-title">
           Contributor Awards - 2024
          </span>
          <p>
           Award winners announced at this year's PyTorch Conference
          </p>
         </a>
        </div>
       </div>
      </li>
      <li>
       <div class="resources-dropdown" data-toggle="resources-dropdown" id="resourcesDropdownButton">
        <a class="with-down-arrow">
         Edge
        </a>
        <div class="resources-dropdown-menu">
         <a class="nav-dropdown-item" href="https://pytorch.org/edge">
          <span class="dropdown-title">
           About PyTorch Edge
          </span>
          <p>
           Build innovative and privacy-aware AI experiences for edge devices
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/executorch-overview">
          <span class="dropdown-title">
           ExecuTorch
          </span>
          <p>
           End-to-end solution for enabling on-device inference capabilities across mobile and edge devices
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/executorch/stable/index.html">
          <span class="dropdown-title">
           ExecuTorch Docs
          </span>
         </a>
        </div>
       </div>
      </li>
      <li class="main-menu-item">
       <div class="resources-dropdown" data-toggle="resources-dropdown" id="resourcesDropdownButton">
        <a class="with-down-arrow">
         Docs
        </a>
        <div class="resources-dropdown-menu">
         <a class="nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
          <span class="dropdown-title">
           PyTorch
          </span>
          <p>
           Explore the documentation for comprehensive guidance on how to use PyTorch
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/pytorch-domains">
          <span class="dropdown-title">
           PyTorch Domains
          </span>
          <p>
           Read the PyTorch Domains documentation to learn more about domain-specific libraries
          </p>
         </a>
        </div>
       </div>
      </li>
      <li>
       <div class="resources-dropdown" data-toggle="resources-dropdown" id="resourcesDropdownButton">
        <a class="with-down-arrow">
         Blogs &amp; News
        </a>
        <div class="resources-dropdown-menu">
         <a class="nav-dropdown-item" href="https://pytorch.org/blog/">
          <span class="dropdown-title">
           PyTorch Blog
          </span>
          <p>
           Catch up on the latest technical news and happenings
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/community-blog">
          <span class="dropdown-title">
           Community Blog
          </span>
          <p>
           Stories from the PyTorch ecosystem
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/videos">
          <span class="dropdown-title">
           Videos
          </span>
          <p>
           Learn about the latest PyTorch tutorials, new, and more
          </p>
          <a class="nav-dropdown-item" href="https://pytorch.org/community-stories">
           <span class="dropdown-title">
            Community Stories
           </span>
           <p>
            Learn how our community solves real, everyday machine learning problems with PyTorch
           </p>
          </a>
          <a class="nav-dropdown-item" href="https://pytorch.org/events">
           <span class="dropdown-title">
            Events
           </span>
           <p>
            Find events, webinars, and podcasts
           </p>
          </a>
          <a class="nav-dropdown-item" href="https://pytorch.org/newsletter">
           <span class="dropdown-title">
            Newsletter
           </span>
           <p>
            Stay up-to-date with the latest updates
           </p>
          </a>
         </a>
        </div>
       </div>
      </li>
      <li>
       <div class="resources-dropdown" data-toggle="resources-dropdown" id="resourcesDropdownButton">
        <a class="with-down-arrow">
         About
        </a>
        <div class="resources-dropdown-menu">
         <a class="nav-dropdown-item" href="https://pytorch.org/foundation">
          <span class="dropdown-title">
           PyTorch Foundation
          </span>
          <p>
           Learn more about the PyTorch Foundation
          </p>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/governing-board">
          <span class="dropdown-title">
           Governing Board
          </span>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/credits">
          <span class="dropdown-title">
           Cloud Credit Program
          </span>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/tac">
          <span class="dropdown-title">
           Technical Advisory Council
          </span>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/staff">
          <span class="dropdown-title">
           Staff
          </span>
         </a>
         <a class="nav-dropdown-item" href="https://pytorch.org/contact-us">
          <span class="dropdown-title">
           Contact Us
          </span>
         </a>
        </div>
       </div>
      </li>
      <li class="main-menu-item">
       <div class="no-dropdown">
        <a data-cta="join" href="https://pytorch.org/join">
         Become a Member
        </a>
       </div>
      </li>
      <li>
       <div class="main-menu-item">
        <a class="github-icon" href="https://github.com/pytorch/pytorch">
        </a>
       </div>
      </li>
      <!--- TODO: This block adds the search icon to the nav bar. We will enable it later. 
          <li>
            <div class="main-menu-item">
             <a href="https://github.com/pytorch/pytorch" class="search-icon">
             </a>
            </div>
          </li>
          --->
     </ul>
    </div>
    <a class="main-menu-open-button" data-behavior="open-mobile-menu" href="#">
    </a>
   </div>
  </div>
 </div>
 <body class="pytorch-body">
  <div class="table-of-contents-link-wrapper">
   <span>
    Table of Contents
   </span>
   <a class="toggle-table-of-contents" data-behavior="toggle-table-of-contents" href="#">
   </a>
  </div>
  <nav class="pytorch-left-menu" data-toggle="wy-nav-shift" id="pytorch-left-menu">
   <div class="pytorch-side-scroll">
    <div aria-label="main navigation" class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation">
     <div class="pytorch-left-menu-search">
      <div class="version">
       <a href="https://pytorch.org/docs/versions.html">
        2.7 ▼
       </a>
      </div>
      <div id="searchBox">
       <div class="searchbox" id="googleSearchBox">
        <script async="" src="https://cse.google.com/cse.js?cx=e65585f8c3ea1440e">
        </script>
        <div class="gcse-search">
        </div>
       </div>
       <div id="sphinxSearchBox" style="display: none;">
        <div role="search">
         <form action="../../../search.html" class="wy-form" id="rtd-search-form" method="get">
          <input name="q" placeholder="Search Docs" type="text"/>
          <input name="check_keywords" type="hidden" value="yes"/>
          <input name="area" type="hidden" value="default"/>
         </form>
        </div>
       </div>
      </div>
      <form id="searchForm">
       <label style="margin-bottom: 1rem">
        <input checked="" name="searchType" type="radio" value="google"/>
        Google Search
       </label>
       <label style="margin-bottom: 1rem">
        <input name="searchType" type="radio" value="sphinx"/>
        Classic Search
       </label>
      </form>
      <script>
       document.addEventListener('DOMContentLoaded', function() {
      const searchForm = document.getElementById('searchForm');
      const googleSearchBox = document.getElementById('googleSearchBox');
      const sphinxSearchBox = document.getElementById('sphinxSearchBox');
      // Function to toggle search box visibility
      function toggleSearchBox(searchType) {
        googleSearchBox.style.display = searchType === 'google' ? 'block' : 'none';
        sphinxSearchBox.style.display = searchType === 'sphinx' ? 'block' : 'none';
      }
      // Determine the default search type
      let defaultSearchType;
      const currentUrl = window.location.href;
      if (currentUrl.startsWith('https://pytorch.org/docs/stable')) {
        // For the stable documentation, default to Google
        defaultSearchType = localStorage.getItem('searchType') || 'google';
      } else {
        // For any other version, including docs-preview, default to Sphinx
        defaultSearchType = 'sphinx';
      }
      // Set the default search type
      document.querySelector(`input[name="searchType"][value="${defaultSearchType}"]`).checked = true;
      toggleSearchBox(defaultSearchType);
      // Event listener for changes in search type
      searchForm.addEventListener('change', function(event) {
        const selectedSearchType = event.target.value;
        localStorage.setItem('searchType', selectedSearchType);
        toggleSearchBox(selectedSearchType);
      });
      // Set placeholder text for Google search box
      window.onload = function() {
        var placeholderText = "Search Docs";
        var googleSearchboxText = document.querySelector("#gsc-i-id1");
        if (googleSearchboxText) {
          googleSearchboxText.placeholder = placeholderText;
          googleSearchboxText.style.fontFamily = 'FreightSans';
          googleSearchboxText.style.fontSize = "1.2rem";
          googleSearchboxText.style.color = '#262626';
        }
      };
    });
      </script>
     </div>
     <p class="caption" role="heading">
      <span class="caption-text">
       Community
      </span>
     </p>
     <ul>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../community/build_ci_governance.html">
        PyTorch Governance | Build + CI
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../community/contribution_guide.html">
        PyTorch Contribution Guide
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../community/design.html">
        PyTorch Design Philosophy
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../community/governance.html">
        PyTorch Governance | Mechanics
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../community/persons_of_interest.html">
        PyTorch Governance | Maintainers
       </a>
      </li>
     </ul>
     <p class="caption" role="heading">
      <span class="caption-text">
       Developer Notes
      </span>
     </p>
     <ul>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/amp_examples.html">
        Automatic Mixed Precision examples
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/autograd.html">
        Autograd mechanics
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/broadcasting.html">
        Broadcasting semantics
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/cpu_threading_torchscript_inference.html">
        CPU threading and TorchScript inference
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/cuda.html">
        CUDA semantics
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/custom_operators.html">
        PyTorch Custom Operators Landing Page
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/ddp.html">
        Distributed Data Parallel
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/extending.html">
        Extending PyTorch
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/extending.func.html">
        Extending torch.func with autograd.Function
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/faq.html">
        Frequently Asked Questions
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/fsdp.html">
        FSDP Notes
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/get_start_xpu.html">
        Getting Started on Intel GPU
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/gradcheck.html">
        Gradcheck mechanics
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/hip.html">
        HIP (ROCm) semantics
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/large_scale_deployments.html">
        Features for large-scale deployments
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/libtorch_stable_abi.html">
        LibTorch Stable ABI
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/modules.html">
        Modules
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/mps.html">
        MPS backend
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/multiprocessing.html">
        Multiprocessing best practices
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/numerical_accuracy.html">
        Numerical accuracy
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/randomness.html">
        Reproducibility
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/serialization.html">
        Serialization semantics
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../notes/windows.html">
        Windows FAQ
       </a>
      </li>
     </ul>
     <p class="caption" role="heading">
      <span class="caption-text">
       Language Bindings
      </span>
     </p>
     <ul>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../cpp_index.html">
        C++
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference external" href="https://pytorch.org/javadoc/">
        Javadoc
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../deploy.html">
        torch::deploy
       </a>
      </li>
     </ul>
     <p class="caption" role="heading">
      <span class="caption-text">
       Python API
      </span>
     </p>
     <ul>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../torch.html">
        torch
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../nn.html">
        torch.nn
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../nn.functional.html">
        torch.nn.functional
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../tensors.html">
        torch.Tensor
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../tensor_attributes.html">
        Tensor Attributes
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../tensor_view.html">
        Tensor Views
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../amp.html">
        torch.amp
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../autograd.html">
        torch.autograd
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../library.html">
        torch.library
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../accelerator.html">
        torch.accelerator
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../cpu.html">
        torch.cpu
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../cuda.html">
        torch.cuda
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../torch_cuda_memory.html">
        Understanding CUDA Memory Usage
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../torch_cuda_memory.html#generating-a-snapshot">
        Generating a Snapshot
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../torch_cuda_memory.html#using-the-visualizer">
        Using the visualizer
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../torch_cuda_memory.html#snapshot-api-reference">
        Snapshot API Reference
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../mps.html">
        torch.mps
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../xpu.html">
        torch.xpu
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../mtia.html">
        torch.mtia
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../mtia.memory.html">
        torch.mtia.memory
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../meta.html">
        Meta device
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../backends.html">
        torch.backends
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../export.html">
        torch.export
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributed.html">
        torch.distributed
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributed.tensor.html">
        torch.distributed.tensor
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributed.algorithms.join.html">
        torch.distributed.algorithms.join
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributed.elastic.html">
        torch.distributed.elastic
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../fsdp.html">
        torch.distributed.fsdp
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributed.fsdp.fully_shard.html">
        torch.distributed.fsdp.fully_shard
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributed.tensor.parallel.html">
        torch.distributed.tensor.parallel
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributed.optim.html">
        torch.distributed.optim
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributed.pipelining.html">
        torch.distributed.pipelining
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributed.checkpoint.html">
        torch.distributed.checkpoint
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../distributions.html">
        torch.distributions
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../torch.compiler.html">
        torch.compiler
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../fft.html">
        torch.fft
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../func.html">
        torch.func
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../futures.html">
        torch.futures
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../fx.html">
        torch.fx
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../fx.experimental.html">
        torch.fx.experimental
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../hub.html">
        torch.hub
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../jit.html">
        torch.jit
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../linalg.html">
        torch.linalg
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../monitor.html">
        torch.monitor
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../signal.html">
        torch.signal
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../special.html">
        torch.special
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../torch.overrides.html">
        torch.overrides
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../package.html">
        torch.package
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../profiler.html">
        torch.profiler
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../nn.init.html">
        torch.nn.init
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../nn.attention.html">
        torch.nn.attention
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../onnx.html">
        torch.onnx
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../optim.html">
        torch.optim
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../complex_numbers.html">
        Complex Numbers
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../ddp_comm_hooks.html">
        DDP Communication Hooks
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../quantization.html">
        Quantization
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../rpc.html">
        Distributed RPC Framework
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../random.html">
        torch.random
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../masked.html">
        torch.masked
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../nested.html">
        torch.nested
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../size.html">
        torch.Size
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../sparse.html">
        torch.sparse
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../storage.html">
        torch.Storage
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../testing.html">
        torch.testing
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../utils.html">
        torch.utils
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../benchmark_utils.html">
        torch.utils.benchmark
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../bottleneck.html">
        torch.utils.bottleneck
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../checkpoint.html">
        torch.utils.checkpoint
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../cpp_extension.html">
        torch.utils.cpp_extension
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../data.html">
        torch.utils.data
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../deterministic.html">
        torch.utils.deterministic
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../jit_utils.html">
        torch.utils.jit
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../dlpack.html">
        torch.utils.dlpack
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../mobile_optimizer.html">
        torch.utils.mobile_optimizer
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../model_zoo.html">
        torch.utils.model_zoo
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../tensorboard.html">
        torch.utils.tensorboard
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../module_tracker.html">
        torch.utils.module_tracker
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../type_info.html">
        Type Info
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../named_tensor.html">
        Named Tensors
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../name_inference.html">
        Named Tensors operator coverage
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../config_mod.html">
        torch.__config__
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../future_mod.html">
        torch.__future__
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../logging.html">
        torch._logging
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference internal" href="../../../torch_environment_variables.html">
        Torch Environment Variables
       </a>
      </li>
     </ul>
     <p class="caption" role="heading">
      <span class="caption-text">
       Libraries
      </span>
     </p>
     <ul>
      <li class="toctree-l1">
       <a class="reference external" href="https://pytorch.org/audio/stable">
        torchaudio
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference external" href="https://pytorch.org/data">
        TorchData
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference external" href="https://pytorch.org/torchrec">
        TorchRec
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference external" href="https://pytorch.org/serve">
        TorchServe
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference external" href="https://pytorch.org/text/stable">
        torchtext
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference external" href="https://pytorch.org/vision/stable">
        torchvision
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference external" href="https://pytorch.org/xla/">
        PyTorch on XLA Devices
       </a>
      </li>
      <li class="toctree-l1">
       <a class="reference external" href="https://pytorch.org/ao">
        torchao
       </a>
      </li>
     </ul>
    </div>
   </div>
  </nav>
  <div class="pytorch-container">
   <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
    <div class="pytorch-breadcrumbs-wrapper">
     <div aria-label="breadcrumbs navigation" role="navigation">
      <ul class="pytorch-breadcrumbs">
       <li>
        <a href="../../../index.html">
         Docs
        </a>
        &gt;
       </li>
       <li>
        <a href="../../index.html">
         Module code
        </a>
        &gt;
       </li>
       <li>
        <a href="../../torch.html">
         torch
        </a>
        &gt;
       </li>
       <li>
        <a href="../utils.html">
         torch.utils
        </a>
        &gt;
       </li>
       <li>
        torch.utils.cpp_extension
       </li>
       <li class="pytorch-breadcrumbs-aside">
       </li>
      </ul>
     </div>
    </div>
    <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
     Shortcuts
    </div>
   </div>
   <section class="pytorch-content-wrap" data-toggle="wy-nav-shift" id="pytorch-content-wrap">
    <div class="pytorch-content-left">
     <!-- Google Tag Manager (noscript) -->
     <noscript>
      <iframe height="0" src="https://www.googletagmanager.com/ns.html?id=GTM-T8XT4PS" style="display:none;visibility:hidden" width="0">
      </iframe>
     </noscript>
     <!-- End Google Tag Manager (noscript) -->
     <div class="rst-content">
      <div class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
       <article class="pytorch-article" id="pytorch-article" itemprop="articleBody">
        <h1>
         Source code for torch.utils.cpp_extension
        </h1>
        <div class="highlight">
         <pre>
<span></span><span class="c1"># mypy: allow-untyped-defs</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">importlib.abc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">setuptools</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">sysconfig</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">errno</span>

<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch._appdirs</span>
<span class="kn">from</span> <span class="nn">.file_baton</span> <span class="kn">import</span> <span class="n">FileBaton</span>
<span class="kn">from</span> <span class="nn">._cpp_extension_versioner</span> <span class="kn">import</span> <span class="n">ExtensionVersioner</span>
<span class="kn">from</span> <span class="nn">.hipify</span> <span class="kn">import</span> <span class="n">hipify_python</span>
<span class="kn">from</span> <span class="nn">.hipify.hipify_python</span> <span class="kn">import</span> <span class="n">GeneratedFileCleaner</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">torch.torch_version</span> <span class="kn">import</span> <span class="n">TorchVersion</span><span class="p">,</span> <span class="n">Version</span>

<span class="kn">from</span> <span class="nn">setuptools.command.build_ext</span> <span class="kn">import</span> <span class="n">build_ext</span>

<span class="n">IS_WINDOWS</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">'win32'</span>
<span class="n">IS_MACOS</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'darwin'</span><span class="p">)</span>
<span class="n">IS_LINUX</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'linux'</span><span class="p">)</span>
<span class="n">LIB_EXT</span> <span class="o">=</span> <span class="s1">'.pyd'</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="s1">'.so'</span>
<span class="n">EXEC_EXT</span> <span class="o">=</span> <span class="s1">'.exe'</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="s1">''</span>
<span class="n">CLIB_PREFIX</span> <span class="o">=</span> <span class="s1">''</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="s1">'lib'</span>
<span class="n">CLIB_EXT</span> <span class="o">=</span> <span class="s1">'.dll'</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="s1">'.so'</span>
<span class="n">SHARED_FLAG</span> <span class="o">=</span> <span class="s1">'/DLL'</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="s1">'-shared'</span>

<span class="n">_HERE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
<span class="n">_TORCH_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">_HERE</span><span class="p">))</span>
<span class="n">TORCH_LIB_PATH</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TORCH_PATH</span><span class="p">,</span> <span class="s1">'lib'</span><span class="p">)</span>


<span class="n">SUBPROCESS_DECODE_ARGS</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'oem'</span><span class="p">,)</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="p">()</span>
<span class="n">MINIMUM_GCC_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">MINIMUM_MSVC_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">19</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">24215</span><span class="p">)</span>

<span class="n">VersionRange</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>
<span class="n">VersionMap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VersionRange</span><span class="p">]</span>
<span class="c1"># The following values were taken from the following GitHub gist that</span>
<span class="c1"># summarizes the minimum valid major versions of g++/clang++ for each supported</span>
<span class="c1"># CUDA version: https://gist.github.com/ax3l/9489132</span>
<span class="c1"># Or from include/crt/host_config.h in the CUDA SDK</span>
<span class="c1"># The second value is the exclusive(!) upper bound, i.e. min &lt;= version &lt; max</span>
<span class="n">CUDA_GCC_VERSIONS</span><span class="p">:</span> <span class="n">VersionMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'11.0'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_GCC_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.1'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_GCC_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.2'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_GCC_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.3'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_GCC_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.4'</span><span class="p">:</span> <span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.5'</span><span class="p">:</span> <span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.6'</span><span class="p">:</span> <span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.7'</span><span class="p">:</span> <span class="p">((</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
<span class="p">}</span>

<span class="n">MINIMUM_CLANG_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">CUDA_CLANG_VERSIONS</span><span class="p">:</span> <span class="n">VersionMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'11.1'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_CLANG_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.2'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_CLANG_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.3'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_CLANG_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.4'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_CLANG_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.5'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_CLANG_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.6'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_CLANG_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
    <span class="s1">'11.7'</span><span class="p">:</span> <span class="p">(</span><span class="n">MINIMUM_CLANG_VERSION</span><span class="p">,</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span>
<span class="p">}</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"get_default_build_root"</span><span class="p">,</span> <span class="s2">"check_compiler_ok_for_platform"</span><span class="p">,</span> <span class="s2">"get_compiler_abi_compatibility_and_version"</span><span class="p">,</span> <span class="s2">"BuildExtension"</span><span class="p">,</span>
           <span class="s2">"CppExtension"</span><span class="p">,</span> <span class="s2">"CUDAExtension"</span><span class="p">,</span> <span class="s2">"SyclExtension"</span><span class="p">,</span> <span class="s2">"include_paths"</span><span class="p">,</span> <span class="s2">"library_paths"</span><span class="p">,</span> <span class="s2">"load"</span><span class="p">,</span> <span class="s2">"load_inline"</span><span class="p">,</span> <span class="s2">"is_ninja_available"</span><span class="p">,</span>
           <span class="s2">"verify_ninja_availability"</span><span class="p">,</span> <span class="s2">"remove_extension_h_precompiler_headers"</span><span class="p">,</span> <span class="s2">"get_cxx_compiler"</span><span class="p">,</span> <span class="s2">"check_compiler_is_gcc"</span><span class="p">]</span>
<span class="c1"># Taken directly from python stdlib &lt; 3.9</span>
<span class="c1"># See https://github.com/pytorch/pytorch/issues/48617</span>
<span class="k">def</span> <span class="nf">_nt_quote_args</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Quote command-line arguments for DOS/Windows conventions.</span>

<span class="sd">    Just wraps every argument which contains blanks in double quotes, and</span>
<span class="sd">    returns a new argument list.</span>
<span class="sd">    """</span>
    <span class="c1"># Cover None-type</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'"</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s1">"'</span> <span class="k">if</span> <span class="s1">' '</span> <span class="ow">in</span> <span class="n">arg</span> <span class="k">else</span> <span class="n">arg</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_find_cuda_home</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Find the CUDA install path."""</span>
    <span class="c1"># Guess #1</span>
    <span class="n">cuda_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'CUDA_HOME'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'CUDA_PATH'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cuda_home</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Guess #2</span>
        <span class="n">nvcc_path</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">"nvcc"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nvcc_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cuda_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">nvcc_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Guess #3</span>
            <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
                <span class="n">cuda_homes</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                    <span class="s1">'C:/Program Files/NVIDIA GPU Computing Toolkit/CUDA/v*.*'</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cuda_homes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cuda_home</span> <span class="o">=</span> <span class="s1">''</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cuda_home</span> <span class="o">=</span> <span class="n">cuda_homes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cuda_home</span> <span class="o">=</span> <span class="s1">'/usr/local/cuda'</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cuda_home</span><span class="p">):</span>
                <span class="n">cuda_home</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">cuda_home</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No CUDA runtime is found, using CUDA_HOME='</span><span class="si">{</span><span class="n">cuda_home</span><span class="si">}</span><span class="s2">'"</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cuda_home</span>

<span class="k">def</span> <span class="nf">_find_rocm_home</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""Find the ROCm install path."""</span>
    <span class="c1"># Guess #1</span>
    <span class="n">rocm_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ROCM_HOME'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ROCM_PATH'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rocm_home</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Guess #2</span>
        <span class="n">hipcc_path</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">'hipcc'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hipcc_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rocm_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">hipcc_path</span><span class="p">)))</span>
            <span class="c1"># can be either &lt;ROCM_HOME&gt;/hip/bin/hipcc or &lt;ROCM_HOME&gt;/bin/hipcc</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">rocm_home</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'hip'</span><span class="p">:</span>
                <span class="n">rocm_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">rocm_home</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Guess #3</span>
            <span class="n">fallback_path</span> <span class="o">=</span> <span class="s1">'/opt/rocm'</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fallback_path</span><span class="p">):</span>
                <span class="n">rocm_home</span> <span class="o">=</span> <span class="n">fallback_path</span>
    <span class="k">if</span> <span class="n">rocm_home</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">hip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"No ROCm runtime is found, using ROCM_HOME='</span><span class="si">{</span><span class="n">rocm_home</span><span class="si">}</span><span class="s2">'"</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rocm_home</span>

<span class="k">def</span> <span class="nf">_find_sycl_home</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">sycl_home</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">icpx_path</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s1">'icpx'</span><span class="p">)</span>
    <span class="c1"># Guess 1: for source code build developer/user, we'll have icpx in PATH,</span>
    <span class="c1"># which will tell us the SYCL_HOME location.</span>
    <span class="k">if</span> <span class="n">icpx_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sycl_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">icpx_path</span><span class="p">)))</span>

    <span class="c1"># Guess 2: for users install Pytorch with XPU support, the sycl runtime is</span>
    <span class="c1"># inside intel-sycl-rt, which is automatically installed via pip dependency.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s1">'intel-sycl-rt'</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">"libsycl.so"</span><span class="p">:</span>
                    <span class="n">sycl_home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">locate</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
                    <span class="k">break</span>
        <span class="k">except</span> <span class="n">importlib</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">PackageNotFoundError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"Trying to find SYCL_HOME from intel-sycl-rt package, but it is not installed."</span><span class="p">,</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sycl_home</span>

<span class="k">def</span> <span class="nf">_join_rocm_home</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Join paths with ROCM_HOME, or raises an error if it ROCM_HOME is not set.</span>

<span class="sd">    This is basically a lazy way of raising an error for missing $ROCM_HOME</span>
<span class="sd">    only once we need to get any ROCm-specific path.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">ROCM_HOME</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'ROCM_HOME environment variable is not set. '</span>
                      <span class="s1">'Please set it to your ROCm install root.'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'Building PyTorch extensions using '</span>
                      <span class="s1">'ROCm and Windows is not supported.'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ROCM_HOME</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_join_sycl_home</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Join paths with SYCL_HOME, or raises an error if it SYCL_HOME is not found.</span>

<span class="sd">    This is basically a lazy way of raising an error for missing SYCL_HOME</span>
<span class="sd">    only once we need to get any SYCL-specific path.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">SYCL_HOME</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'SYCL runtime is not dected. Please setup the pytorch '</span>
                      <span class="s1">'prerequisites for Intel GPU following the instruction in '</span>
                      <span class="s1">'https://github.com/pytorch/pytorch?tab=readme-ov-file#intel-gpu-support '</span>
                      <span class="s1">'or install intel-sycl-rt via pip.'</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">SYCL_HOME</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span>



<span class="n">ABI_INCOMPATIBILITY_WARNING</span> <span class="o">=</span> <span class="s1">'''</span>

<span class="s1">                               !! WARNING !!</span>

<span class="s1">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<span class="s1">Your compiler (</span><span class="si">{}</span><span class="s1">) may be ABI-incompatible with PyTorch!</span>
<span class="s1">Please use a compiler that is ABI-compatible with GCC 5.0 and above.</span>
<span class="s1">See https://gcc.gnu.org/onlinedocs/libstdc++/manual/abi.html.</span>

<span class="s1">See https://gist.github.com/goldsborough/d466f43e8ffc948ff92de7486c5216d6</span>
<span class="s1">for instructions on how to install GCC 5 or higher.</span>
<span class="s1">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>

<span class="s1">                              !! WARNING !!</span>
<span class="s1">'''</span>
<span class="n">WRONG_COMPILER_WARNING</span> <span class="o">=</span> <span class="s1">'''</span>

<span class="s1">                               !! WARNING !!</span>

<span class="s1">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<span class="s1">Your compiler (</span><span class="si">{user_compiler}</span><span class="s1">) is not compatible with the compiler Pytorch was</span>
<span class="s1">built with for this platform, which is </span><span class="si">{pytorch_compiler}</span><span class="s1"> on </span><span class="si">{platform}</span><span class="s1">. Please</span>
<span class="s1">use </span><span class="si">{pytorch_compiler}</span><span class="s1"> to to compile your extension. Alternatively, you may</span>
<span class="s1">compile PyTorch from source using </span><span class="si">{user_compiler}</span><span class="s1">, and then you can also use</span>
<span class="si">{user_compiler}</span><span class="s1"> to compile your extension.</span>

<span class="s1">See https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md for help</span>
<span class="s1">with compiling PyTorch from source.</span>
<span class="s1">!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>

<span class="s1">                              !! WARNING !!</span>
<span class="s1">'''</span>
<span class="n">CUDA_MISMATCH_MESSAGE</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">The detected CUDA version (</span><span class="si">{0}</span><span class="s1">) mismatches the version that was used to compile</span>
<span class="s1">PyTorch (</span><span class="si">{1}</span><span class="s1">). Please make sure to use the same CUDA versions.</span>
<span class="s1">'''</span>
<span class="n">CUDA_MISMATCH_WARN</span> <span class="o">=</span> <span class="s2">"The detected CUDA version (</span><span class="si">{0}</span><span class="s2">) has a minor version mismatch with the version that was used to compile PyTorch (</span><span class="si">{1}</span><span class="s2">). Most likely this shouldn't be a problem."</span>
<span class="n">CUDA_NOT_FOUND_MESSAGE</span> <span class="o">=</span> <span class="s1">'''</span>
<span class="s1">CUDA was not found on the system, please set the CUDA_HOME or the CUDA_PATH</span>
<span class="s1">environment variable or add NVCC to your system PATH. The extension compilation will fail.</span>
<span class="s1">'''</span>
<span class="n">ROCM_HOME</span> <span class="o">=</span> <span class="n">_find_rocm_home</span><span class="p">()</span>
<span class="n">HIP_HOME</span> <span class="o">=</span> <span class="n">_join_rocm_home</span><span class="p">(</span><span class="s1">'hip'</span><span class="p">)</span> <span class="k">if</span> <span class="n">ROCM_HOME</span> <span class="k">else</span> <span class="kc">None</span>
<span class="n">IS_HIP_EXTENSION</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">((</span><span class="n">ROCM_HOME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">hip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span> <span class="k">else</span> <span class="kc">False</span>
<span class="n">ROCM_VERSION</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">hip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">ROCM_VERSION</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">hip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>

<span class="n">CUDA_HOME</span> <span class="o">=</span> <span class="n">_find_cuda_home</span><span class="p">()</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">_is_compiled</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>
<span class="n">CUDNN_HOME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'CUDNN_HOME'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'CUDNN_PATH'</span><span class="p">)</span>
<span class="n">SYCL_HOME</span> <span class="o">=</span> <span class="n">_find_sycl_home</span><span class="p">()</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">xpu</span><span class="o">.</span><span class="n">_is_compiled</span><span class="p">()</span> <span class="k">else</span> <span class="kc">None</span>

<span class="c1"># PyTorch releases have the version pattern major.minor.patch, whereas when</span>
<span class="c1"># PyTorch is built from source, we append the git commit hash, which gives</span>
<span class="c1"># it the below pattern.</span>
<span class="n">BUILT_FROM_SOURCE_VERSION_PATTERN</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">'\d+\.\d+\.\d+\w+\+\w+'</span><span class="p">)</span>

<span class="n">COMMON_MSVC_FLAGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'/MD'</span><span class="p">,</span> <span class="s1">'/wd4819'</span><span class="p">,</span> <span class="s1">'/wd4251'</span><span class="p">,</span> <span class="s1">'/wd4244'</span><span class="p">,</span> <span class="s1">'/wd4267'</span><span class="p">,</span> <span class="s1">'/wd4275'</span><span class="p">,</span> <span class="s1">'/wd4018'</span><span class="p">,</span> <span class="s1">'/wd4190'</span><span class="p">,</span> <span class="s1">'/wd4624'</span><span class="p">,</span> <span class="s1">'/wd4067'</span><span class="p">,</span> <span class="s1">'/wd4068'</span><span class="p">,</span> <span class="s1">'/EHsc'</span><span class="p">]</span>

<span class="n">MSVC_IGNORE_CUDAFE_WARNINGS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'base_class_has_different_dll_interface'</span><span class="p">,</span>
    <span class="s1">'field_without_dll_interface'</span><span class="p">,</span>
    <span class="s1">'dll_interface_conflict_none_assumed'</span><span class="p">,</span>
    <span class="s1">'dll_interface_conflict_dllexport_assumed'</span>
<span class="p">]</span>

<span class="n">COMMON_NVCC_FLAGS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'-D__CUDA_NO_HALF_OPERATORS__'</span><span class="p">,</span>
    <span class="s1">'-D__CUDA_NO_HALF_CONVERSIONS__'</span><span class="p">,</span>
    <span class="s1">'-D__CUDA_NO_BFLOAT16_CONVERSIONS__'</span><span class="p">,</span>
    <span class="s1">'-D__CUDA_NO_HALF2_OPERATORS__'</span><span class="p">,</span>
    <span class="s1">'--expt-relaxed-constexpr'</span>
<span class="p">]</span>

<span class="n">COMMON_HIP_FLAGS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'-fPIC'</span><span class="p">,</span>
    <span class="s1">'-D__HIP_PLATFORM_AMD__=1'</span><span class="p">,</span>
    <span class="s1">'-DUSE_ROCM=1'</span><span class="p">,</span>
    <span class="s1">'-DHIPBLAS_V2'</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">COMMON_HIPCC_FLAGS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'-DCUDA_HAS_FP16=1'</span><span class="p">,</span>
    <span class="s1">'-D__HIP_NO_HALF_OPERATORS__=1'</span><span class="p">,</span>
    <span class="s1">'-D__HIP_NO_HALF_CONVERSIONS__=1'</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">_COMMON_SYCL_FLAGS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'-fsycl'</span><span class="p">,</span>
    <span class="s1">'-fsycl-targets=spir64_gen,spir64'</span><span class="p">,</span>
<span class="p">]</span>

<span class="k">def</span> <span class="nf">_get_sycl_arch_list</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">'TORCH_XPU_ARCH_LIST'</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'TORCH_XPU_ARCH_LIST'</span><span class="p">)</span>
    <span class="n">arch_list</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">xpu</span><span class="o">.</span><span class="n">get_arch_list</span><span class="p">()</span>
    <span class="c1"># Dropping dg2-* archs since they lack hardware support for fp64 and require</span>
    <span class="c1"># special consideration from the user. If needed these platforms can</span>
    <span class="c1"># be requested thru TORCH_XPU_ARCH_LIST environment variable.</span>
    <span class="n">arch_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">arch_list</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'dg2-'</span><span class="p">)]</span>
    <span class="k">return</span> <span class="s1">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arch_list</span><span class="p">)</span>

<span class="n">_SYCL_DLINK_FLAGS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">*</span><span class="n">_COMMON_SYCL_FLAGS</span><span class="p">,</span>
    <span class="s1">'-fsycl-link'</span><span class="p">,</span>
    <span class="s1">'--offload-compress'</span><span class="p">,</span>
    <span class="sa">f</span><span class="s1">'-Xs "-device </span><span class="si">{</span><span class="n">_get_sycl_arch_list</span><span class="p">()</span><span class="si">}</span><span class="s1">"'</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">JIT_EXTENSION_VERSIONER</span> <span class="o">=</span> <span class="n">ExtensionVersioner</span><span class="p">()</span>

<span class="n">PLAT_TO_VCVARS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'win32'</span> <span class="p">:</span> <span class="s1">'x86'</span><span class="p">,</span>
    <span class="s1">'win-amd64'</span> <span class="p">:</span> <span class="s1">'x86_amd64'</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">min_supported_cpython</span> <span class="o">=</span> <span class="s2">"0x03090000"</span>  <span class="c1"># Python 3.9 hexcode</span>

<span class="k">def</span> <span class="nf">get_cxx_compiler</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'CXX'</span><span class="p">,</span> <span class="s1">'cl'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'CXX'</span><span class="p">,</span> <span class="s1">'c++'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">compiler</span>

<span class="k">def</span> <span class="nf">_is_binary_build</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">BUILT_FROM_SOURCE_VERSION_PATTERN</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_accepted_compilers_for_platform</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># gnu-c++ and gnu-cc are the conda gcc compilers</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">'clang++'</span><span class="p">,</span> <span class="s1">'clang'</span><span class="p">]</span> <span class="k">if</span> <span class="n">IS_MACOS</span> <span class="k">else</span> <span class="p">[</span><span class="s1">'g++'</span><span class="p">,</span> <span class="s1">'gcc'</span><span class="p">,</span> <span class="s1">'gnu-c++'</span><span class="p">,</span> <span class="s1">'gnu-cc'</span><span class="p">,</span> <span class="s1">'clang++'</span><span class="p">,</span> <span class="s1">'clang'</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">_maybe_write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">new_content</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">'''</span>
<span class="sd">    Equivalent to writing the content into the file but will not touch the file</span>
<span class="sd">    if it already had the right content (to avoid triggering recompile).</span>
<span class="sd">    '''</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">content</span> <span class="o">==</span> <span class="n">new_content</span><span class="p">:</span>
            <span class="c1"># The file already contains the right thing!</span>
            <span class="k">return</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">source_file</span><span class="p">:</span>
        <span class="n">source_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_default_build_root</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Return the path to the root folder under which extensions will built.</span>

<span class="sd">    For each extension module built, there will be one folder underneath the</span>
<span class="sd">    folder returned by this function. For example, if ``p`` is the path</span>
<span class="sd">    returned by this function and ``ext`` the name of an extension, the build</span>
<span class="sd">    folder for the extension will be ``p/ext``.</span>

<span class="sd">    This directory is **user-specific** so that multiple users on the same</span>
<span class="sd">    machine won't meet permission issues.</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_appdirs</span><span class="o">.</span><span class="n">user_cache_dir</span><span class="p">(</span><span class="n">appname</span><span class="o">=</span><span class="s1">'torch_extensions'</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">check_compiler_ok_for_platform</span><span class="p">(</span><span class="n">compiler</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Verify that the compiler is the expected one for the current platform.</span>

<span class="sd">    Args:</span>
<span class="sd">        compiler (str): The compiler executable to check.</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if the compiler is gcc/g++ on Linux or clang/clang++ on macOS,</span>
<span class="sd">        and always True for Windows.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="n">compiler_path</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">compiler_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Use os.path.realpath to resolve any symlinks, in particular from 'c++' to e.g. 'g++'.</span>
    <span class="n">compiler_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">compiler_path</span><span class="p">)</span>
    <span class="c1"># Check the compiler name</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">compiler_path</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_accepted_compilers_for_platform</span><span class="p">()):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="c1"># If compiler wrapper is used try to infer the actual compiler by invoking it with -v flag</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="s1">'LC_ALL'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'C'</span>  <span class="c1"># Don't localize output</span>
    <span class="n">version_string</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">compiler</span><span class="p">,</span> <span class="s1">'-v'</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">SUBPROCESS_DECODE_ARGS</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IS_LINUX</span><span class="p">:</span>
        <span class="c1"># Check for 'gcc' or 'g++' for sccache wrapper</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">"^COLLECT_GCC=(.*)$"</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">version_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Clang is also a supported compiler on Linux</span>
            <span class="c1"># Though on Ubuntu it's sometimes called "Ubuntu clang version"</span>
            <span class="k">return</span> <span class="s1">'clang version'</span> <span class="ow">in</span> <span class="n">version_string</span>
        <span class="n">compiler_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="c1"># On RHEL/CentOS c++ is a gcc compiler wrapper</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">compiler_path</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'c++'</span> <span class="ow">and</span> <span class="s1">'gcc version'</span> <span class="ow">in</span> <span class="n">version_string</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">compiler_path</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_accepted_compilers_for_platform</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">IS_MACOS</span><span class="p">:</span>
        <span class="c1"># Check for 'clang' or 'clang++'</span>
        <span class="k">return</span> <span class="n">version_string</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"Apple clang"</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="get_compiler_abi_compatibility_and_version"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.get_compiler_abi_compatibility_and_version">[docs]</a><span class="k">def</span> <span class="nf">get_compiler_abi_compatibility_and_version</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">TorchVersion</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Determine if the given compiler is ABI-compatible with PyTorch alongside its version.</span>

<span class="sd">    Args:</span>
<span class="sd">        compiler (str): The compiler executable name to check (e.g. ``g++``).</span>
<span class="sd">            Must be executable in a shell process.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple that contains a boolean that defines if the compiler is (likely) ABI-incompatible with PyTorch,</span>
<span class="sd">        followed by a `TorchVersion` string that contains the compiler version separated by dots.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_binary_build</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="s1">'0.0.0'</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'TORCH_DONT_CHECK_COMPILER_ABI'</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'ON'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'YES'</span><span class="p">,</span> <span class="s1">'TRUE'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="s1">'0.0.0'</span><span class="p">))</span>

    <span class="c1"># First check if the compiler is one of the expected ones for the particular platform.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_compiler_ok_for_platform</span><span class="p">(</span><span class="n">compiler</span><span class="p">):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">WRONG_COMPILER_WARNING</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">user_compiler</span><span class="o">=</span><span class="n">compiler</span><span class="p">,</span>
            <span class="n">pytorch_compiler</span><span class="o">=</span><span class="n">_accepted_compilers_for_platform</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">platform</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="s1">'0.0.0'</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">IS_MACOS</span><span class="p">:</span>
        <span class="c1"># There is no particular minimum version we need for clang, so we're good here.</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="s1">'0.0.0'</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">IS_LINUX</span><span class="p">:</span>
            <span class="n">minimum_required_version</span> <span class="o">=</span> <span class="n">MINIMUM_GCC_VERSION</span>
            <span class="n">versionstr</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">compiler</span><span class="p">,</span> <span class="s1">'-dumpfullversion'</span><span class="p">,</span> <span class="s1">'-dumpversion'</span><span class="p">])</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">versionstr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">SUBPROCESS_DECODE_ARGS</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">minimum_required_version</span> <span class="o">=</span> <span class="n">MINIMUM_MSVC_VERSION</span>
            <span class="n">compiler_info</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'(\d+)\.(\d+)\.(\d+)'</span><span class="p">,</span> <span class="n">compiler_info</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">SUBPROCESS_DECODE_ARGS</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">version</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'0'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">]</span> <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Error checking compiler version for </span><span class="si">{</span><span class="n">compiler</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="s1">'0.0.0'</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="n">minimum_required_version</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>

    <span class="n">compiler</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">compiler</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="s2">"."</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">version</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">ABI_INCOMPATIBILITY_WARNING</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">compiler</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span></div>


<span class="k">def</span> <span class="nf">_check_cuda_version</span><span class="p">(</span><span class="n">compiler_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">compiler_version</span><span class="p">:</span> <span class="n">TorchVersion</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">CUDA_HOME</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">CUDA_NOT_FOUND_MESSAGE</span><span class="p">)</span>

    <span class="n">nvcc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUDA_HOME</span><span class="p">,</span> <span class="s1">'bin'</span><span class="p">,</span> <span class="s1">'nvcc'</span><span class="p">)</span>
    <span class="n">cuda_version_str</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">nvcc</span><span class="p">,</span> <span class="s1">'--version'</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">SUBPROCESS_DECODE_ARGS</span><span class="p">)</span>
    <span class="n">cuda_version</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">'release (\d+[.]\d+)'</span><span class="p">,</span> <span class="n">cuda_version_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cuda_version</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">cuda_str_version</span> <span class="o">=</span> <span class="n">cuda_version</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cuda_ver</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">cuda_str_version</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">torch_cuda_version</span> <span class="o">=</span> <span class="n">Version</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cuda_ver</span> <span class="o">!=</span> <span class="n">torch_cuda_version</span><span class="p">:</span>
        <span class="c1"># major/minor attributes are only available in setuptools&gt;=49.4.0</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">cuda_ver</span><span class="p">,</span> <span class="s2">"major"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"setuptools&gt;=49.4.0 is required"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cuda_ver</span><span class="o">.</span><span class="n">major</span> <span class="o">!=</span> <span class="n">torch_cuda_version</span><span class="o">.</span><span class="n">major</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">CUDA_MISMATCH_MESSAGE</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cuda_str_version</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span><span class="p">))</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">CUDA_MISMATCH_WARN</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cuda_str_version</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'linux'</span><span class="p">)</span> <span class="ow">and</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'TORCH_DONT_CHECK_COMPILER_ABI'</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'ON'</span><span class="p">,</span> <span class="s1">'1'</span><span class="p">,</span> <span class="s1">'YES'</span><span class="p">,</span> <span class="s1">'TRUE'</span><span class="p">,</span> <span class="s1">'Y'</span><span class="p">]</span> <span class="ow">and</span>
            <span class="n">_is_binary_build</span><span class="p">()):</span>
        <span class="k">return</span>

    <span class="n">cuda_compiler_bounds</span><span class="p">:</span> <span class="n">VersionMap</span> <span class="o">=</span> <span class="n">CUDA_CLANG_VERSIONS</span> <span class="k">if</span> <span class="n">compiler_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'clang'</span><span class="p">)</span> <span class="k">else</span> <span class="n">CUDA_GCC_VERSIONS</span>

    <span class="k">if</span> <span class="n">cuda_str_version</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cuda_compiler_bounds</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">'There are no </span><span class="si">{</span><span class="n">compiler_name</span><span class="si">}</span><span class="s1"> version bounds defined for CUDA version </span><span class="si">{</span><span class="n">cuda_str_version</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_compiler_version</span><span class="p">,</span> <span class="n">max_excl_compiler_version</span> <span class="o">=</span> <span class="n">cuda_compiler_bounds</span><span class="p">[</span><span class="n">cuda_str_version</span><span class="p">]</span>
        <span class="c1"># Special case for 11.4.0, which has lower compiler bounds than 11.4.1</span>
        <span class="k">if</span> <span class="s2">"V11.4.48"</span> <span class="ow">in</span> <span class="n">cuda_version_str</span> <span class="ow">and</span> <span class="n">cuda_compiler_bounds</span> <span class="o">==</span> <span class="n">CUDA_GCC_VERSIONS</span><span class="p">:</span>
            <span class="n">max_excl_compiler_version</span> <span class="o">=</span> <span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">min_compiler_version_str</span> <span class="o">=</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">min_compiler_version</span><span class="p">))</span>
        <span class="n">max_excl_compiler_version_str</span> <span class="o">=</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">max_excl_compiler_version</span><span class="p">))</span>

        <span class="n">version_bound_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'&gt;=</span><span class="si">{</span><span class="n">min_compiler_version_str</span><span class="si">}</span><span class="s1">, &lt;</span><span class="si">{</span><span class="n">max_excl_compiler_version_str</span><span class="si">}</span><span class="s1">'</span>

        <span class="k">if</span> <span class="n">compiler_version</span> <span class="o">&lt;</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="n">min_compiler_version_str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">'The current installed version of </span><span class="si">{</span><span class="n">compiler_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">compiler_version</span><span class="si">}</span><span class="s1">) is less '</span>
                <span class="sa">f</span><span class="s1">'than the minimum required version by CUDA </span><span class="si">{</span><span class="n">cuda_str_version</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">min_compiler_version_str</span><span class="si">}</span><span class="s1">). '</span>
                <span class="sa">f</span><span class="s1">'Please make sure to use an adequate version of </span><span class="si">{</span><span class="n">compiler_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">version_bound_str</span><span class="si">}</span><span class="s1">).'</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">compiler_version</span> <span class="o">&gt;=</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="n">max_excl_compiler_version_str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">'The current installed version of </span><span class="si">{</span><span class="n">compiler_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">compiler_version</span><span class="si">}</span><span class="s1">) is greater '</span>
                <span class="sa">f</span><span class="s1">'than the maximum required version by CUDA </span><span class="si">{</span><span class="n">cuda_str_version</span><span class="si">}</span><span class="s1">. '</span>
                <span class="sa">f</span><span class="s1">'Please make sure to use an adequate version of </span><span class="si">{</span><span class="n">compiler_name</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">version_bound_str</span><span class="si">}</span><span class="s1">).'</span>
            <span class="p">)</span>


<span class="k">def</span> <span class="nf">_append_sycl_std_if_no_std_present</span><span class="p">(</span><span class="n">cflags</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'-sycl-std='</span><span class="p">)</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">cflags</span><span class="p">):</span>
        <span class="n">cflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-sycl-std=2020'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_wrap_sycl_host_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">):</span>
    <span class="n">host_cxx</span> <span class="o">=</span> <span class="n">get_cxx_compiler</span><span class="p">()</span>
    <span class="n">host_cflags</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s1">'-fsycl-host-compiler=</span><span class="si">{</span><span class="n">host_cxx</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span>
        <span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-fsycl-host-compiler-options=</span><span class="si">{</span><span class="n">cflags</span><span class="si">}</span><span class="s1">'</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">host_cflags</span>


<div class="viewcode-block" id="BuildExtension"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.BuildExtension">[docs]</a><span class="k">class</span> <span class="nc">BuildExtension</span><span class="p">(</span><span class="n">build_ext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    A custom :mod:`setuptools` build extension .</span>

<span class="sd">    This :class:`setuptools.build_ext` subclass takes care of passing the</span>
<span class="sd">    minimum required compiler flags (e.g. ``-std=c++17``) as well as mixed</span>
<span class="sd">    C++/CUDA/SYCL compilation (and support for CUDA/SYCL files in general).</span>

<span class="sd">    When using :class:`BuildExtension`, it is allowed to supply a dictionary</span>
<span class="sd">    for ``extra_compile_args`` (rather than the usual list) that maps from</span>
<span class="sd">    languages/compilers (the only expected values are ``cxx``, ``nvcc`` or</span>
<span class="sd">    ``sycl``) to a list of additional compiler flags to supply to the compiler.</span>
<span class="sd">    This makes it possible to supply different flags to the C++, CUDA and SYCL</span>
<span class="sd">    compiler during mixed compilation.</span>

<span class="sd">    ``use_ninja`` (bool): If ``use_ninja`` is ``True`` (default), then we</span>
<span class="sd">    attempt to build using the Ninja backend. Ninja greatly speeds up</span>
<span class="sd">    compilation compared to the standard ``setuptools.build_ext``.</span>
<span class="sd">    Fallbacks to the standard distutils backend if Ninja is not available.</span>

<span class="sd">    .. note::</span>
<span class="sd">        By default, the Ninja backend uses #CPUS + 2 workers to build the</span>
<span class="sd">        extension. This may use up too many resources on some systems. One</span>
<span class="sd">        can control the number of workers by setting the `MAX_JOBS` environment</span>
<span class="sd">        variable to a non-negative number.</span>
<span class="sd">    """</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">with_options</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
<span class="w">        </span><span class="sd">"""Return a subclass with alternative constructor that extends any original keyword arguments to the original constructor with the given options."""</span>
        <span class="k">class</span> <span class="nc">cls_with_options</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>  <span class="c1"># type: ignore[misc, valid-type]</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cls_with_options</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_python_abi_suffix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"no_python_abi_suffix"</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_ninja</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'use_ninja'</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ninja</span><span class="p">:</span>
            <span class="c1"># Test if we can use ninja. Fallback otherwise.</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'Attempted to use ninja as the BuildExtension backend but '</span>
                   <span class="s1">'</span><span class="si">{}</span><span class="s1">. Falling back to using the slow distutils backend.'</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ninja_available</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'we could not find ninja.'</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">use_ninja</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">finalize_options</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">finalize_options</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ninja</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">force</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">build_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">compiler_name</span><span class="p">,</span> <span class="n">compiler_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_abi</span><span class="p">()</span>

        <span class="n">cuda_ext</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sycl_ext</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">extension_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">)</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">extension_iter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cuda_ext</span> <span class="ow">and</span> <span class="n">sycl_ext</span><span class="p">)</span> <span class="ow">and</span> <span class="n">extension</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">extension</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">'.cu'</span><span class="p">:</span>
                    <span class="n">cuda_ext</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">'.sycl'</span><span class="p">:</span>
                    <span class="n">sycl_ext</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># This check accounts on a case when cuda and sycl sources</span>
                <span class="c1"># are mixed in the same extension. We can stop checking</span>
                <span class="c1"># sources if both are found or there is no more sources.</span>
                <span class="k">if</span> <span class="n">cuda_ext</span> <span class="ow">and</span> <span class="n">sycl_ext</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="n">extension</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">extension_iter</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sycl_ext</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ninja</span><span class="p">,</span> <span class="s2">"ninja is required to build sycl extensions."</span>

        <span class="k">if</span> <span class="n">cuda_ext</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
            <span class="n">_check_cuda_version</span><span class="p">(</span><span class="n">compiler_name</span><span class="p">,</span> <span class="n">compiler_version</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
            <span class="c1"># Ensure at least an empty list of flags for 'cxx', 'nvcc' and 'sycl' when</span>
            <span class="c1"># extra_compile_args is a dict. Otherwise, default torch flags do</span>
            <span class="c1"># not get passed. Necessary when only one of 'cxx', 'nvcc' or 'sycl' is</span>
            <span class="c1"># passed to extra_compile_args in CUDAExtension or SyclExtension, i.e.</span>
            <span class="c1">#   CUDAExtension(..., extra_compile_args={'cxx': [...]})</span>
            <span class="c1"># or</span>
            <span class="c1">#   CUDAExtension(..., extra_compile_args={'nvcc': [...]})</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'cxx'</span><span class="p">,</span> <span class="s1">'nvcc'</span><span class="p">,</span> <span class="s1">'sycl'</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">:</span>
                        <span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_add_compile_flag</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="s1">'-DTORCH_API_INCLUDE_EXTENSION_H'</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hipify_compile_flags</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">extension</span><span class="o">.</span><span class="n">py_limited_api</span><span class="p">:</span>
                <span class="c1"># compile any extension that has passed in py_limited_api to the</span>
                <span class="c1"># Extension constructor with the Py_LIMITED_API flag set to our</span>
                <span class="c1"># min supported CPython version.</span>
                <span class="c1"># See https://docs.python.org/3/c-api/stable.html#c.Py_LIMITED_API</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_compile_flag</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'-DPy_LIMITED_API=</span><span class="si">{</span><span class="n">min_supported_cpython</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># pybind11 is not CPython API stable so don't add these flags used when</span>
                <span class="c1"># compiling pybind11 when pybind11 is not even used. otherwise, the build</span>
                <span class="c1"># logs are confusing.</span>
                <span class="c1"># See note [Pybind11 ABI constants]</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"COMPILER_TYPE"</span><span class="p">,</span> <span class="s2">"STDLIB"</span><span class="p">,</span> <span class="s2">"BUILD_ABI"</span><span class="p">]:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"_PYBIND11_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_add_compile_flag</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'-DPYBIND11_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">="</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s1">"'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_define_torch_extension_name</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_gnu_cpp_abi_flag</span><span class="p">(</span><span class="n">extension</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">'nvcc_dlink'</span> <span class="ow">in</span> <span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ninja</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"With dlink=True, ninja is required to build cuda extension </span><span class="si">{</span><span class="n">extension</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">."</span>

        <span class="c1"># Register .cu, .cuh, .hip, .mm and .sycl as valid source extensions.</span>
        <span class="c1"># NOTE: At the moment .sycl is not a standard extension for SYCL supported</span>
        <span class="c1"># by compiler. Here we introduce a torch level convention that SYCL sources</span>
        <span class="c1"># should have .sycl file extension.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">src_extensions</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'.cu'</span><span class="p">,</span> <span class="s1">'.cuh'</span><span class="p">,</span> <span class="s1">'.hip'</span><span class="p">,</span> <span class="s1">'.sycl'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">mps</span><span class="o">.</span><span class="n">is_built</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">src_extensions</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'.mm'</span><span class="p">]</span>
        <span class="c1"># Save the original _compile method for later.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compiler_type</span> <span class="o">==</span> <span class="s1">'msvc'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">_cpp_extensions</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'.cu'</span><span class="p">,</span> <span class="s1">'.cuh'</span><span class="p">]</span>
            <span class="n">original_compile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compile</span>
            <span class="n">original_spawn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">spawn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">original_compile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">_compile</span>

        <span class="k">def</span> <span class="nf">append_std17_if_no_std_present</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># NVCC does not allow multiple -std to be passed, so we avoid</span>
            <span class="c1"># overriding the option if the user explicitly passed it.</span>
            <span class="n">cpp_format_prefix</span> <span class="o">=</span> <span class="s1">'/</span><span class="si">{}</span><span class="s1">:'</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compiler_type</span> <span class="o">==</span> <span class="s1">'msvc'</span> <span class="k">else</span> <span class="s1">'-</span><span class="si">{}</span><span class="s1">='</span>
            <span class="n">cpp_flag_prefix</span> <span class="o">=</span> <span class="n">cpp_format_prefix</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">'std'</span><span class="p">)</span>
            <span class="n">cpp_flag</span> <span class="o">=</span> <span class="n">cpp_flag_prefix</span> <span class="o">+</span> <span class="s1">'c++17'</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">cpp_flag_prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">cflags</span><span class="p">):</span>
                <span class="n">cflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cpp_flag</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">unix_cuda_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">):</span>
            <span class="n">cflags</span> <span class="o">=</span> <span class="p">(</span><span class="n">COMMON_NVCC_FLAGS</span> <span class="o">+</span>
                      <span class="p">[</span><span class="s1">'--compiler-options'</span><span class="p">,</span> <span class="s2">"'-fPIC'"</span><span class="p">]</span> <span class="o">+</span>
                      <span class="n">cflags</span> <span class="o">+</span> <span class="n">_get_cuda_arch_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">))</span>

            <span class="c1"># NVCC does not allow multiple -ccbin/--compiler-bindir to be passed, so we avoid</span>
            <span class="c1"># overriding the option if the user explicitly passed it.</span>
            <span class="n">_ccbin</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"CC"</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">_ccbin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">'-ccbin'</span><span class="p">,</span> <span class="s1">'--compiler-bindir'</span><span class="p">))</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">cflags</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">cflags</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">'-ccbin'</span><span class="p">,</span> <span class="n">_ccbin</span><span class="p">])</span>

            <span class="k">return</span> <span class="n">cflags</span>

        <span class="k">def</span> <span class="nf">convert_to_absolute_paths_inplace</span><span class="p">(</span><span class="n">paths</span><span class="p">):</span>
            <span class="c1"># Helper function. See Note [Absolute include_dirs]</span>
            <span class="k">if</span> <span class="n">paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                        <span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">unix_wrap_single_compile</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">cc_args</span><span class="p">,</span> <span class="n">extra_postargs</span><span class="p">,</span> <span class="n">pp_opts</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Copy before we make any modifications.</span>
            <span class="n">cflags</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">original_compiler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compiler_so</span>
                <span class="k">if</span> <span class="n">_is_cuda_file</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                    <span class="n">nvcc</span> <span class="o">=</span> <span class="p">[</span><span class="n">_join_rocm_home</span><span class="p">(</span><span class="s1">'bin'</span><span class="p">,</span> <span class="s1">'hipcc'</span><span class="p">)</span> <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span> <span class="k">else</span> <span class="n">_join_cuda_home</span><span class="p">(</span><span class="s1">'bin'</span><span class="p">,</span> <span class="s1">'nvcc'</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">set_executable</span><span class="p">(</span><span class="s1">'compiler_so'</span><span class="p">,</span> <span class="n">nvcc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cflags</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">cflags</span> <span class="o">=</span> <span class="n">cflags</span><span class="p">[</span><span class="s1">'nvcc'</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
                        <span class="n">cflags</span> <span class="o">=</span> <span class="n">COMMON_HIPCC_FLAGS</span> <span class="o">+</span> <span class="n">cflags</span> <span class="o">+</span> <span class="n">_get_rocm_arch_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cflags</span> <span class="o">=</span> <span class="n">unix_cuda_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cflags</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">cflags</span> <span class="o">=</span> <span class="n">cflags</span><span class="p">[</span><span class="s1">'cxx'</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
                    <span class="n">cflags</span> <span class="o">=</span> <span class="n">COMMON_HIP_FLAGS</span> <span class="o">+</span> <span class="n">cflags</span>
                <span class="n">append_std17_if_no_std_present</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span>

                <span class="n">original_compile</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">cc_args</span><span class="p">,</span> <span class="n">cflags</span><span class="p">,</span> <span class="n">pp_opts</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># Put the original compiler back in place.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">set_executable</span><span class="p">(</span><span class="s1">'compiler_so'</span><span class="p">,</span> <span class="n">original_compiler</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">unix_wrap_ninja_compile</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
                                    <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">macros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">include_dirs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">extra_preargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">extra_postargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">depends</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">            </span><span class="sa">r</span><span class="sd">"""Compiles sources by outputting a ninja file and running it."""</span>
            <span class="c1"># NB: I copied some lines from self.compiler (which is an instance</span>
            <span class="c1"># of distutils.UnixCCompiler). See the following link.</span>
            <span class="c1"># https://github.com/python/cpython/blob/f03a8f8d5001963ad5b5b28dbd95497e9cc15596/Lib/distutils/ccompiler.py#L564-L567</span>
            <span class="c1"># This can be fragile, but a lot of other repos also do this</span>
            <span class="c1"># (see https://github.com/search?q=_setup_compile&amp;type=Code)</span>
            <span class="c1"># so it is probably OK; we'll also get CI signal if/when</span>
            <span class="c1"># we update our python version (which is when distutils can be</span>
            <span class="c1"># upgraded)</span>

            <span class="c1"># Use absolute path for output_dir so that the object file paths</span>
            <span class="c1"># (`objects`) get generated with absolute paths.</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

            <span class="c1"># See Note [Absolute include_dirs]</span>
            <span class="n">convert_to_absolute_paths_inplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">include_dirs</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">extra_postargs</span><span class="p">,</span> <span class="n">pp_opts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">_setup_compile</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">macros</span><span class="p">,</span>
                                             <span class="n">include_dirs</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span>
                                             <span class="n">depends</span><span class="p">,</span> <span class="n">extra_postargs</span><span class="p">)</span>
            <span class="n">common_cflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">_get_cc_args</span><span class="p">(</span><span class="n">pp_opts</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">extra_preargs</span><span class="p">)</span>
            <span class="n">extra_cc_cflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compiler_so</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">with_cuda</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_cuda_file</span><span class="p">,</span> <span class="n">sources</span><span class="p">))</span>
            <span class="n">with_sycl</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_sycl_file</span><span class="p">,</span> <span class="n">sources</span><span class="p">))</span>

            <span class="c1"># extra_postargs can be either:</span>
            <span class="c1"># - a dict mapping cxx/nvcc/sycl to extra flags</span>
            <span class="c1"># - a list of extra flags.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">post_cflags</span> <span class="o">=</span> <span class="n">extra_postargs</span><span class="p">[</span><span class="s1">'cxx'</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post_cflags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
                <span class="n">post_cflags</span> <span class="o">=</span> <span class="n">COMMON_HIP_FLAGS</span> <span class="o">+</span> <span class="n">post_cflags</span>
            <span class="n">append_std17_if_no_std_present</span><span class="p">(</span><span class="n">post_cflags</span><span class="p">)</span>

            <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cuda_cflags</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
                <span class="n">cuda_cflags</span> <span class="o">=</span> <span class="n">common_cflags</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="n">extra_postargs</span><span class="p">[</span><span class="s1">'nvcc'</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
                    <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="n">cuda_post_cflags</span> <span class="o">+</span> <span class="n">_get_rocm_arch_flags</span><span class="p">(</span><span class="n">cuda_post_cflags</span><span class="p">)</span>
                    <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="n">COMMON_HIP_FLAGS</span> <span class="o">+</span> <span class="n">COMMON_HIPCC_FLAGS</span> <span class="o">+</span> <span class="n">cuda_post_cflags</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="n">unix_cuda_flags</span><span class="p">(</span><span class="n">cuda_post_cflags</span><span class="p">)</span>
                <span class="n">append_std17_if_no_std_present</span><span class="p">(</span><span class="n">cuda_post_cflags</span><span class="p">)</span>
                <span class="n">cuda_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cuda_cflags</span><span class="p">]</span>
                <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">cuda_post_cflags</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">'nvcc_dlink'</span> <span class="ow">in</span> <span class="n">extra_postargs</span><span class="p">:</span>
                <span class="n">cuda_dlink_post_cflags</span> <span class="o">=</span> <span class="n">unix_cuda_flags</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">[</span><span class="s1">'nvcc_dlink'</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cuda_dlink_post_cflags</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">sycl_post_cflags</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sycl_cflags</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sycl_dlink_post_cflags</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">with_sycl</span><span class="p">:</span>
                <span class="n">sycl_cflags</span> <span class="o">=</span> <span class="n">extra_cc_cflags</span> <span class="o">+</span> <span class="n">common_cflags</span> <span class="o">+</span> <span class="n">_COMMON_SYCL_FLAGS</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">sycl_post_cflags</span> <span class="o">=</span> <span class="n">extra_postargs</span><span class="p">[</span><span class="s1">'sycl'</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sycl_post_cflags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">)</span>
                <span class="n">append_std17_if_no_std_present</span><span class="p">(</span><span class="n">sycl_cflags</span><span class="p">)</span>
                <span class="n">_append_sycl_std_if_no_std_present</span><span class="p">(</span><span class="n">sycl_cflags</span><span class="p">)</span>
                <span class="n">host_cflags</span> <span class="o">=</span> <span class="n">extra_cc_cflags</span> <span class="o">+</span> <span class="n">common_cflags</span> <span class="o">+</span> <span class="n">post_cflags</span>
                <span class="n">append_std17_if_no_std_present</span><span class="p">(</span><span class="n">host_cflags</span><span class="p">)</span>
                <span class="c1"># escaping quoted arguments to pass them thru SYCL compiler</span>
                <span class="n">host_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'"'</span><span class="p">,</span> <span class="s1">'</span><span class="se">\\\\</span><span class="s1">"'</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">host_cflags</span><span class="p">]</span>
                <span class="n">host_cflags</span> <span class="o">=</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">host_cflags</span><span class="p">)</span>
                <span class="c1"># Note the order: shlex.quote sycl_flags first, _wrap_sycl_host_flags</span>
                <span class="c1"># second. Reason is that sycl host flags are quoted, space containing</span>
                <span class="c1"># strings passed to SYCL compiler.</span>
                <span class="n">sycl_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sycl_cflags</span><span class="p">]</span>
                <span class="n">sycl_cflags</span> <span class="o">+=</span> <span class="n">_wrap_sycl_host_flags</span><span class="p">(</span><span class="n">host_cflags</span><span class="p">)</span>
                <span class="n">sycl_dlink_post_cflags</span> <span class="o">=</span> <span class="n">_SYCL_DLINK_FLAGS</span>
                <span class="n">sycl_post_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">sycl_post_cflags</span><span class="p">]</span>

            <span class="n">_write_ninja_file_and_compile_objects</span><span class="p">(</span>
                <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
                <span class="n">objects</span><span class="o">=</span><span class="n">objects</span><span class="p">,</span>
                <span class="n">cflags</span><span class="o">=</span><span class="p">[</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">extra_cc_cflags</span> <span class="o">+</span> <span class="n">common_cflags</span><span class="p">],</span>
                <span class="n">post_cflags</span><span class="o">=</span><span class="p">[</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">post_cflags</span><span class="p">],</span>
                <span class="n">cuda_cflags</span><span class="o">=</span><span class="n">cuda_cflags</span><span class="p">,</span>
                <span class="n">cuda_post_cflags</span><span class="o">=</span><span class="n">cuda_post_cflags</span><span class="p">,</span>
                <span class="n">cuda_dlink_post_cflags</span><span class="o">=</span><span class="n">cuda_dlink_post_cflags</span><span class="p">,</span>
                <span class="n">sycl_cflags</span><span class="o">=</span><span class="n">sycl_cflags</span><span class="p">,</span>
                <span class="n">sycl_post_cflags</span><span class="o">=</span><span class="n">sycl_post_cflags</span><span class="p">,</span>
                <span class="n">sycl_dlink_post_cflags</span><span class="o">=</span><span class="n">sycl_dlink_post_cflags</span><span class="p">,</span>
                <span class="n">build_directory</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">with_cuda</span><span class="o">=</span><span class="n">with_cuda</span><span class="p">,</span>
                <span class="n">with_sycl</span><span class="o">=</span><span class="n">with_sycl</span><span class="p">)</span>

            <span class="c1"># Return *all* object filenames, not just the ones we just built.</span>
            <span class="k">return</span> <span class="n">objects</span>

        <span class="k">def</span> <span class="nf">win_cuda_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">COMMON_NVCC_FLAGS</span> <span class="o">+</span>
                    <span class="n">cflags</span> <span class="o">+</span> <span class="n">_get_cuda_arch_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">win_wrap_single_compile</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
                                    <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">macros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">include_dirs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">extra_preargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">extra_postargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">depends</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cflags</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">)</span>
            <span class="n">extra_postargs</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">def</span> <span class="nf">spawn</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
                <span class="c1"># Using regex to match src, obj and include files</span>
                <span class="n">src_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">'/T(p|c)(.*)'</span><span class="p">)</span>
                <span class="n">src_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">src_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span>
                <span class="p">]</span>

                <span class="n">obj_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">'/Fo(.*)'</span><span class="p">)</span>
                <span class="n">obj_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">obj_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span>
                <span class="p">]</span>

                <span class="n">include_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">'((\-|\/)I.*)'</span><span class="p">)</span>
                <span class="n">include_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">include_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">)</span> <span class="k">if</span> <span class="n">m</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">src_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_list</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="n">src_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">obj_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">_is_cuda_file</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
                        <span class="n">nvcc</span> <span class="o">=</span> <span class="n">_join_cuda_home</span><span class="p">(</span><span class="s1">'bin'</span><span class="p">,</span> <span class="s1">'nvcc'</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cflags</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">cflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cflags</span><span class="p">[</span><span class="s1">'nvcc'</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cflags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">cflags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cflags</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">cflags</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="n">cflags</span> <span class="o">=</span> <span class="n">win_cuda_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'-std=c++17'</span><span class="p">,</span> <span class="s1">'--use-local-env'</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">COMMON_MSVC_FLAGS</span><span class="p">:</span>
                            <span class="n">cflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'-Xcompiler'</span><span class="p">,</span> <span class="n">flag</span><span class="p">]</span> <span class="o">+</span> <span class="n">cflags</span>
                        <span class="k">for</span> <span class="n">ignore_warning</span> <span class="ow">in</span> <span class="n">MSVC_IGNORE_CUDAFE_WARNINGS</span><span class="p">:</span>
                            <span class="n">cflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'-Xcudafe'</span><span class="p">,</span> <span class="s1">'--diag_suppress='</span> <span class="o">+</span> <span class="n">ignore_warning</span><span class="p">]</span> <span class="o">+</span> <span class="n">cflags</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">nvcc</span><span class="p">,</span> <span class="s1">'-c'</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="s1">'-o'</span><span class="p">,</span> <span class="n">obj</span><span class="p">]</span> <span class="o">+</span> <span class="n">include_list</span> <span class="o">+</span> <span class="n">cflags</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cflags</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">cflags</span> <span class="o">=</span> <span class="n">COMMON_MSVC_FLAGS</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cflags</span><span class="p">[</span><span class="s1">'cxx'</span><span class="p">]</span>
                        <span class="n">append_std17_if_no_std_present</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">+=</span> <span class="n">cflags</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cflags</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">cflags</span> <span class="o">=</span> <span class="n">COMMON_MSVC_FLAGS</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">cflags</span>
                        <span class="n">append_std17_if_no_std_present</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span>
                        <span class="n">cmd</span> <span class="o">+=</span> <span class="n">cflags</span>

                <span class="k">return</span> <span class="n">original_spawn</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">spawn</span> <span class="o">=</span> <span class="n">spawn</span>
                <span class="k">return</span> <span class="n">original_compile</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">macros</span><span class="p">,</span>
                                        <span class="n">include_dirs</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">extra_preargs</span><span class="p">,</span>
                                        <span class="n">extra_postargs</span><span class="p">,</span> <span class="n">depends</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">spawn</span> <span class="o">=</span> <span class="n">original_spawn</span>

        <span class="k">def</span> <span class="nf">win_wrap_ninja_compile</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span>
                                   <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">macros</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">include_dirs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">debug</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">extra_preargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">extra_postargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">depends</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
            <span class="n">output_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

            <span class="c1"># Note [Absolute include_dirs]</span>
            <span class="c1"># Convert relative path in self.compiler.include_dirs to absolute path if any.</span>
            <span class="c1"># For ninja build, the build location is not local, but instead, the build happens</span>
            <span class="c1"># in a script-created build folder. Thus, relative paths lose their correctness.</span>
            <span class="c1"># To be consistent with jit extension, we allow user to enter relative include_dirs</span>
            <span class="c1"># in setuptools.setup, and we convert the relative path to absolute path here.</span>
            <span class="n">convert_to_absolute_paths_inplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">include_dirs</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">objects</span><span class="p">,</span> <span class="n">extra_postargs</span><span class="p">,</span> <span class="n">pp_opts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">_setup_compile</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">macros</span><span class="p">,</span>
                                             <span class="n">include_dirs</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span>
                                             <span class="n">depends</span><span class="p">,</span> <span class="n">extra_postargs</span><span class="p">)</span>
            <span class="n">common_cflags</span> <span class="o">=</span> <span class="n">extra_preargs</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="n">cflags</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="n">cflags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compile_options_debug</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cflags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compile_options</span><span class="p">)</span>
            <span class="n">common_cflags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">COMMON_MSVC_FLAGS</span><span class="p">)</span>
            <span class="n">cflags</span> <span class="o">=</span> <span class="n">cflags</span> <span class="o">+</span> <span class="n">common_cflags</span> <span class="o">+</span> <span class="n">pp_opts</span>
            <span class="n">with_cuda</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_cuda_file</span><span class="p">,</span> <span class="n">sources</span><span class="p">))</span>

            <span class="c1"># extra_postargs can be either:</span>
            <span class="c1"># - a dict mapping cxx/nvcc to extra flags</span>
            <span class="c1"># - a list of extra flags.</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">post_cflags</span> <span class="o">=</span> <span class="n">extra_postargs</span><span class="p">[</span><span class="s1">'cxx'</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">post_cflags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">)</span>
            <span class="n">append_std17_if_no_std_present</span><span class="p">(</span><span class="n">post_cflags</span><span class="p">)</span>

            <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">cuda_cflags</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
                <span class="n">cuda_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'-std=c++17'</span><span class="p">,</span> <span class="s1">'--use-local-env'</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">common_cflag</span> <span class="ow">in</span> <span class="n">common_cflags</span><span class="p">:</span>
                    <span class="n">cuda_cflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-Xcompiler'</span><span class="p">)</span>
                    <span class="n">cuda_cflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">common_cflag</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ignore_warning</span> <span class="ow">in</span> <span class="n">MSVC_IGNORE_CUDAFE_WARNINGS</span><span class="p">:</span>
                    <span class="n">cuda_cflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-Xcudafe'</span><span class="p">)</span>
                    <span class="n">cuda_cflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'--diag_suppress='</span> <span class="o">+</span> <span class="n">ignore_warning</span><span class="p">)</span>
                <span class="n">cuda_cflags</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pp_opts</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="n">extra_postargs</span><span class="p">[</span><span class="s1">'nvcc'</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">)</span>
                <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="n">win_cuda_flags</span><span class="p">(</span><span class="n">cuda_post_cflags</span><span class="p">)</span>

            <span class="n">cflags</span> <span class="o">=</span> <span class="n">_nt_quote_args</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span>
            <span class="n">post_cflags</span> <span class="o">=</span> <span class="n">_nt_quote_args</span><span class="p">(</span><span class="n">post_cflags</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
                <span class="n">cuda_cflags</span> <span class="o">=</span> <span class="n">_nt_quote_args</span><span class="p">(</span><span class="n">cuda_cflags</span><span class="p">)</span>
                <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="n">_nt_quote_args</span><span class="p">(</span><span class="n">cuda_post_cflags</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">'nvcc_dlink'</span> <span class="ow">in</span> <span class="n">extra_postargs</span><span class="p">:</span>
                <span class="n">cuda_dlink_post_cflags</span> <span class="o">=</span> <span class="n">win_cuda_flags</span><span class="p">(</span><span class="n">extra_postargs</span><span class="p">[</span><span class="s1">'nvcc_dlink'</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cuda_dlink_post_cflags</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">_write_ninja_file_and_compile_objects</span><span class="p">(</span>
                <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
                <span class="n">objects</span><span class="o">=</span><span class="n">objects</span><span class="p">,</span>
                <span class="n">cflags</span><span class="o">=</span><span class="n">cflags</span><span class="p">,</span>
                <span class="n">post_cflags</span><span class="o">=</span><span class="n">post_cflags</span><span class="p">,</span>
                <span class="n">cuda_cflags</span><span class="o">=</span><span class="n">cuda_cflags</span><span class="p">,</span>
                <span class="n">cuda_post_cflags</span><span class="o">=</span><span class="n">cuda_post_cflags</span><span class="p">,</span>
                <span class="n">cuda_dlink_post_cflags</span><span class="o">=</span><span class="n">cuda_dlink_post_cflags</span><span class="p">,</span>
                <span class="n">sycl_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sycl_post_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sycl_dlink_post_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">build_directory</span><span class="o">=</span><span class="n">output_dir</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">with_cuda</span><span class="o">=</span><span class="n">with_cuda</span><span class="p">,</span>
                <span class="n">with_sycl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># Return *all* object filenames, not just the ones we just built.</span>
            <span class="k">return</span> <span class="n">objects</span>

        <span class="c1"># Monkey-patch the _compile or compile method.</span>
        <span class="c1"># https://github.com/python/cpython/blob/dc0284ee8f7a270b6005467f26d8e5773d76e959/Lib/distutils/ccompiler.py#L511</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compiler_type</span> <span class="o">==</span> <span class="s1">'msvc'</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ninja</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="n">win_wrap_ninja_compile</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="n">win_wrap_single_compile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ninja</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="n">unix_wrap_ninja_compile</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">_compile</span> <span class="o">=</span> <span class="n">unix_wrap_single_compile</span>

        <span class="n">build_ext</span><span class="o">.</span><span class="n">build_extensions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_ext_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext_name</span><span class="p">):</span>
        <span class="c1"># Get the original shared library name. For Python 3, this name will be</span>
        <span class="c1"># suffixed with "&lt;SOABI&gt;.so", where &lt;SOABI&gt; will be something like</span>
        <span class="c1"># cpython-37m-x86_64-linux-gnu.</span>
        <span class="n">ext_filename</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_ext_filename</span><span class="p">(</span><span class="n">ext_name</span><span class="p">)</span>
        <span class="c1"># If `no_python_abi_suffix` is `True`, we omit the Python 3 ABI</span>
        <span class="c1"># component. This makes building shared libraries with setuptools that</span>
        <span class="c1"># aren't Python modules nicer.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_python_abi_suffix</span><span class="p">:</span>
            <span class="c1"># The parts will be e.g. ["my_extension", "cpython-37m-x86_64-linux-gnu", "so"].</span>
            <span class="n">ext_filename_parts</span> <span class="o">=</span> <span class="n">ext_filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
            <span class="c1"># Omit the second to last element.</span>
            <span class="n">without_abi</span> <span class="o">=</span> <span class="n">ext_filename_parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ext_filename_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">ext_filename</span> <span class="o">=</span> <span class="s1">'.'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">without_abi</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ext_filename</span>

    <span class="k">def</span> <span class="nf">_check_abi</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TorchVersion</span><span class="p">]:</span>
        <span class="c1"># On some platforms, like Windows, compiler_cxx is not available.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="p">,</span> <span class="s1">'compiler_cxx'</span><span class="p">):</span>
            <span class="n">compiler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiler</span><span class="o">.</span><span class="n">compiler_cxx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compiler</span> <span class="o">=</span> <span class="n">get_cxx_compiler</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="n">get_compiler_abi_compatibility_and_version</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
        <span class="c1"># Warn user if VC env is activated but `DISTUILS_USE_SDK` is not set.</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="ow">and</span> <span class="s1">'VSCMD_ARG_TGT_ARCH'</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="ow">and</span> <span class="s1">'DISTUTILS_USE_SDK'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'It seems that the VC environment is activated but DISTUTILS_USE_SDK is not set.'</span>
                   <span class="s1">'This may lead to multiple activations of the VC env.'</span>
                   <span class="s1">'Please set `DISTUTILS_USE_SDK=1` and try again.'</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">version</span>

    <span class="k">def</span> <span class="nf">_add_compile_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
        <span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>

    <span class="c1"># Simple hipify, replace the first occurrence of CUDA with HIP</span>
    <span class="c1"># in flags starting with "-" and containing "CUDA", but exclude -I flags</span>
    <span class="k">def</span> <span class="nf">_hipify_compile_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">'nvcc'</span> <span class="ow">in</span> <span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">:</span>
            <span class="n">modified_flags</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">[</span><span class="s1">'nvcc'</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"-"</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">"CUDA"</span> <span class="ow">in</span> <span class="n">flag</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"-I"</span><span class="p">):</span>
                    <span class="c1"># check/split flag into flag and value</span>
                    <span class="n">parts</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"="</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">flag_part</span><span class="p">,</span> <span class="n">value_part</span> <span class="o">=</span> <span class="n">parts</span>
                        <span class="c1"># replace fist instance of "CUDA" with "HIP" only in the flag and not flag value</span>
                        <span class="n">modified_flag_part</span> <span class="o">=</span> <span class="n">flag_part</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"CUDA"</span><span class="p">,</span> <span class="s2">"HIP"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">modified_flag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">modified_flag_part</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value_part</span><span class="si">}</span><span class="s2">"</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># replace fist instance of "CUDA" with "HIP" in flag</span>
                        <span class="n">modified_flag</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"CUDA"</span><span class="p">,</span> <span class="s2">"HIP"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">modified_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">modified_flag</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Modified flag: </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">modified_flag</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">modified_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
            <span class="n">extension</span><span class="o">.</span><span class="n">extra_compile_args</span><span class="p">[</span><span class="s1">'nvcc'</span><span class="p">]</span> <span class="o">=</span> <span class="n">modified_flags</span>

    <span class="k">def</span> <span class="nf">_define_torch_extension_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
        <span class="c1"># pybind11 doesn't support dots in the names</span>
        <span class="c1"># so in order to support extensions in the packages</span>
        <span class="c1"># like torch._C, we take the last part of the string</span>
        <span class="c1"># as the library name</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">extension</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">define</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'-DTORCH_EXTENSION_NAME=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">'</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_compile_flag</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="n">define</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_gnu_cpp_abi_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extension</span><span class="p">):</span>
        <span class="c1"># use the same CXX ABI as what PyTorch was compiled with</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_compile_flag</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="s1">'-D_GLIBCXX_USE_CXX11_ABI='</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_GLIBCXX_USE_CXX11_ABI</span><span class="p">)))</span></div>


<div class="viewcode-block" id="CppExtension"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.CppExtension">[docs]</a><span class="k">def</span> <span class="nf">CppExtension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Create a :class:`setuptools.Extension` for C++.</span>

<span class="sd">    Convenience method that creates a :class:`setuptools.Extension` with the</span>
<span class="sd">    bare minimum (but often sufficient) arguments to build a C++ extension.</span>

<span class="sd">    All arguments are forwarded to the :class:`setuptools.Extension`</span>
<span class="sd">    constructor. Full list arguments can be found at</span>
<span class="sd">    https://setuptools.pypa.io/en/latest/userguide/ext_modules.html#extension-api-reference</span>

<span class="sd">    .. warning::</span>
<span class="sd">        The PyTorch python API (as provided in libtorch_python) cannot be built</span>
<span class="sd">        with the flag ``py_limited_api=True``.  When this flag is passed, it is</span>
<span class="sd">        the user's responsibility in their library to not use APIs from</span>
<span class="sd">        libtorch_python (in particular pytorch/python bindings) and to only use</span>
<span class="sd">        APIs from libtorch (aten objects, operators and the dispatcher). For</span>
<span class="sd">        example, to give access to custom ops from python, the library should</span>
<span class="sd">        register the ops through the dispatcher.</span>

<span class="sd">        Contrary to CPython setuptools, who does not define -DPy_LIMITED_API</span>
<span class="sd">        as a compile flag when py_limited_api is specified as an option for</span>
<span class="sd">        the "bdist_wheel" command in ``setup``, PyTorch does! We will specify</span>
<span class="sd">        -DPy_LIMITED_API=min_supported_cpython to best enforce consistency,</span>
<span class="sd">        safety, and sanity in order to encourage best practices. To target a</span>
<span class="sd">        different version, set min_supported_cpython to the hexcode of the</span>
<span class="sd">        CPython version of choice.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_CPP_EXT)</span>
<span class="sd">        &gt;&gt;&gt; from setuptools import setup</span>
<span class="sd">        &gt;&gt;&gt; from torch.utils.cpp_extension import BuildExtension, CppExtension</span>
<span class="sd">        &gt;&gt;&gt; setup(</span>
<span class="sd">        ...     name='extension',</span>
<span class="sd">        ...     ext_modules=[</span>
<span class="sd">        ...         CppExtension(</span>
<span class="sd">        ...             name='extension',</span>
<span class="sd">        ...             sources=['extension.cpp'],</span>
<span class="sd">        ...             extra_compile_args=['-g'],</span>
<span class="sd">        ...             extra_link_args=['-Wl,--no-as-needed', '-lm'])</span>
<span class="sd">        ...     ],</span>
<span class="sd">        ...     cmdclass={</span>
<span class="sd">        ...         'build_ext': BuildExtension</span>
<span class="sd">        ...     })</span>
<span class="sd">    """</span>
    <span class="n">include_dirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'include_dirs'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">include_dirs</span> <span class="o">+=</span> <span class="n">include_paths</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'include_dirs'</span><span class="p">]</span> <span class="o">=</span> <span class="n">include_dirs</span>

    <span class="n">library_dirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'library_dirs'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">library_dirs</span> <span class="o">+=</span> <span class="n">library_paths</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'library_dirs'</span><span class="p">]</span> <span class="o">=</span> <span class="n">library_dirs</span>

    <span class="n">libraries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'libraries'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'c10'</span><span class="p">)</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch'</span><span class="p">)</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch_cpu'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'py_limited_api'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># torch_python uses more than the python limited api</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch_python'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"sleef"</span><span class="p">)</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'libraries'</span><span class="p">]</span> <span class="o">=</span> <span class="n">libraries</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'c++'</span>
    <span class="k">return</span> <span class="n">setuptools</span><span class="o">.</span><span class="n">Extension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CUDAExtension"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.CUDAExtension">[docs]</a><span class="k">def</span> <span class="nf">CUDAExtension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Create a :class:`setuptools.Extension` for CUDA/C++.</span>

<span class="sd">    Convenience method that creates a :class:`setuptools.Extension` with the</span>
<span class="sd">    bare minimum (but often sufficient) arguments to build a CUDA/C++</span>
<span class="sd">    extension. This includes the CUDA include path, library path and runtime</span>
<span class="sd">    library.</span>

<span class="sd">    All arguments are forwarded to the :class:`setuptools.Extension`</span>
<span class="sd">    constructor. Full list arguments can be found at</span>
<span class="sd">    https://setuptools.pypa.io/en/latest/userguide/ext_modules.html#extension-api-reference</span>

<span class="sd">    .. warning::</span>
<span class="sd">        The PyTorch python API (as provided in libtorch_python) cannot be built</span>
<span class="sd">        with the flag ``py_limited_api=True``.  When this flag is passed, it is</span>
<span class="sd">        the user's responsibility in their library to not use APIs from</span>
<span class="sd">        libtorch_python (in particular pytorch/python bindings) and to only use</span>
<span class="sd">        APIs from libtorch (aten objects, operators and the dispatcher). For</span>
<span class="sd">        example, to give access to custom ops from python, the library should</span>
<span class="sd">        register the ops through the dispatcher.</span>

<span class="sd">        Contrary to CPython setuptools, who does not define -DPy_LIMITED_API</span>
<span class="sd">        as a compile flag when py_limited_api is specified as an option for</span>
<span class="sd">        the "bdist_wheel" command in ``setup``, PyTorch does! We will specify</span>
<span class="sd">        -DPy_LIMITED_API=min_supported_cpython to best enforce consistency,</span>
<span class="sd">        safety, and sanity in order to encourage best practices. To target a</span>
<span class="sd">        different version, set min_supported_cpython to the hexcode of the</span>
<span class="sd">        CPython version of choice.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_CPP_EXT)</span>
<span class="sd">        &gt;&gt;&gt; from setuptools import setup</span>
<span class="sd">        &gt;&gt;&gt; from torch.utils.cpp_extension import BuildExtension, CUDAExtension</span>
<span class="sd">        &gt;&gt;&gt; setup(</span>
<span class="sd">        ...     name='cuda_extension',</span>
<span class="sd">        ...     ext_modules=[</span>
<span class="sd">        ...         CUDAExtension(</span>
<span class="sd">        ...                 name='cuda_extension',</span>
<span class="sd">        ...                 sources=['extension.cpp', 'extension_kernel.cu'],</span>
<span class="sd">        ...                 extra_compile_args={'cxx': ['-g'],</span>
<span class="sd">        ...                                     'nvcc': ['-O2']},</span>
<span class="sd">        ...                 extra_link_args=['-Wl,--no-as-needed', '-lcuda'])</span>
<span class="sd">        ...     ],</span>
<span class="sd">        ...     cmdclass={</span>
<span class="sd">        ...         'build_ext': BuildExtension</span>
<span class="sd">        ...     })</span>

<span class="sd">    Compute capabilities:</span>

<span class="sd">    By default the extension will be compiled to run on all archs of the cards visible during the</span>
<span class="sd">    building process of the extension, plus PTX. If down the road a new card is installed the</span>
<span class="sd">    extension may need to be recompiled. If a visible card has a compute capability (CC) that's</span>
<span class="sd">    newer than the newest version for which your nvcc can build fully-compiled binaries, PyTorch</span>
<span class="sd">    will make nvcc fall back to building kernels with the newest version of PTX your nvcc does</span>
<span class="sd">    support (see below for details on PTX).</span>

<span class="sd">    You can override the default behavior using `TORCH_CUDA_ARCH_LIST` to explicitly specify which</span>
<span class="sd">    CCs you want the extension to support:</span>

<span class="sd">    ``TORCH_CUDA_ARCH_LIST="6.1 8.6" python build_my_extension.py``</span>
<span class="sd">    ``TORCH_CUDA_ARCH_LIST="5.2 6.0 6.1 7.0 7.5 8.0 8.6+PTX" python build_my_extension.py``</span>

<span class="sd">    The +PTX option causes extension kernel binaries to include PTX instructions for the specified</span>
<span class="sd">    CC. PTX is an intermediate representation that allows kernels to runtime-compile for any CC &gt;=</span>
<span class="sd">    the specified CC (for example, 8.6+PTX generates PTX that can runtime-compile for any GPU with</span>
<span class="sd">    CC &gt;= 8.6). This improves your binary's forward compatibility. However, relying on older PTX to</span>
<span class="sd">    provide forward compat by runtime-compiling for newer CCs can modestly reduce performance on</span>
<span class="sd">    those newer CCs. If you know exact CC(s) of the GPUs you want to target, you're always better</span>
<span class="sd">    off specifying them individually. For example, if you want your extension to run on 8.0 and 8.6,</span>
<span class="sd">    "8.0+PTX" would work functionally because it includes PTX that can runtime-compile for 8.6, but</span>
<span class="sd">    "8.0 8.6" would be better.</span>

<span class="sd">    Note that while it's possible to include all supported archs, the more archs get included the</span>
<span class="sd">    slower the building process will be, as it will build a separate kernel image for each arch.</span>

<span class="sd">    Note that CUDA-11.5 nvcc will hit internal compiler error while parsing torch/extension.h on Windows.</span>
<span class="sd">    To workaround the issue, move python binding logic to pure C++ file.</span>

<span class="sd">    Example use:</span>
<span class="sd">        #include &lt;ATen/ATen.h&gt;</span>
<span class="sd">        at::Tensor SigmoidAlphaBlendForwardCuda(....)</span>

<span class="sd">    Instead of:</span>
<span class="sd">        #include &lt;torch/extension.h&gt;</span>
<span class="sd">        torch::Tensor SigmoidAlphaBlendForwardCuda(...)</span>

<span class="sd">    Currently open issue for nvcc bug: https://github.com/pytorch/pytorch/issues/69460</span>
<span class="sd">    Complete workaround code example: https://github.com/facebookresearch/pytorch3d/commit/cb170ac024a949f1f9614ffe6af1c38d972f7d48</span>

<span class="sd">    Relocatable device code linking:</span>

<span class="sd">    If you want to reference device symbols across compilation units (across object files),</span>
<span class="sd">    the object files need to be built with `relocatable device code` (-rdc=true or -dc).</span>
<span class="sd">    An exception to this rule is "dynamic parallelism" (nested kernel launches)  which is not used a lot anymore.</span>
<span class="sd">    `Relocatable device code` is less optimized so it needs to be used only on object files that need it.</span>
<span class="sd">    Using `-dlto` (Device Link Time Optimization) at the device code compilation step and `dlink` step</span>
<span class="sd">    helps reduce the protentional perf degradation of `-rdc`.</span>
<span class="sd">    Note that it needs to be used at both steps to be useful.</span>

<span class="sd">    If you have `rdc` objects you need to have an extra `-dlink` (device linking) step before the CPU symbol linking step.</span>
<span class="sd">    There is also a case where `-dlink` is used without `-rdc`:</span>
<span class="sd">    when an extension is linked against a static lib containing rdc-compiled objects</span>
<span class="sd">    like the [NVSHMEM library](https://developer.nvidia.com/nvshmem).</span>

<span class="sd">    Note: Ninja is required to build a CUDA Extension with RDC linking.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_CPP_EXT)</span>
<span class="sd">        &gt;&gt;&gt; CUDAExtension(</span>
<span class="sd">        ...        name='cuda_extension',</span>
<span class="sd">        ...        sources=['extension.cpp', 'extension_kernel.cu'],</span>
<span class="sd">        ...        dlink=True,</span>
<span class="sd">        ...        dlink_libraries=["dlink_lib"],</span>
<span class="sd">        ...        extra_compile_args={'cxx': ['-g'],</span>
<span class="sd">        ...                            'nvcc': ['-O2', '-rdc=true']})</span>
<span class="sd">    """</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'library_dirs'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">library_dirs</span> <span class="o">+=</span> <span class="n">library_paths</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s2">"cuda"</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'library_dirs'</span><span class="p">]</span> <span class="o">=</span> <span class="n">library_dirs</span>

    <span class="n">libraries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'libraries'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'c10'</span><span class="p">)</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch'</span><span class="p">)</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch_cpu'</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'py_limited_api'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># torch_python uses more than the python limited api</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch_python'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'amdhip64'</span><span class="p">)</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'c10_hip'</span><span class="p">)</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch_hip'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'cudart'</span><span class="p">)</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'c10_cuda'</span><span class="p">)</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch_cuda'</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'libraries'</span><span class="p">]</span> <span class="o">=</span> <span class="n">libraries</span>

    <span class="n">include_dirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'include_dirs'</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
        <span class="n">build_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="n">hipify_result</span> <span class="o">=</span> <span class="n">hipify_python</span><span class="o">.</span><span class="n">hipify</span><span class="p">(</span>
            <span class="n">project_directory</span><span class="o">=</span><span class="n">build_dir</span><span class="p">,</span>
            <span class="n">output_directory</span><span class="o">=</span><span class="n">build_dir</span><span class="p">,</span>
            <span class="n">header_include_dirs</span><span class="o">=</span><span class="n">include_dirs</span><span class="p">,</span>
            <span class="n">includes</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_dir</span><span class="p">,</span> <span class="s1">'*'</span><span class="p">)],</span>  <span class="c1"># limit scope to build_dir only</span>
            <span class="n">extra_files</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">],</span>
            <span class="n">show_detailed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">is_pytorch_extension</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">hipify_extra_files_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># don't hipify everything in includes path</span>
        <span class="p">)</span>

        <span class="n">hipified_sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
            <span class="n">s_abs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">hipified_s_abs</span> <span class="o">=</span> <span class="p">(</span><span class="n">hipify_result</span><span class="p">[</span><span class="n">s_abs</span><span class="p">]</span><span class="o">.</span><span class="n">hipified_path</span> <span class="k">if</span> <span class="p">(</span><span class="n">s_abs</span> <span class="ow">in</span> <span class="n">hipify_result</span> <span class="ow">and</span>
                              <span class="n">hipify_result</span><span class="p">[</span><span class="n">s_abs</span><span class="p">]</span><span class="o">.</span><span class="n">hipified_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">s_abs</span><span class="p">)</span>
            <span class="c1"># setup() arguments must *always* be /-separated paths relative to the setup.py directory,</span>
            <span class="c1"># *never* absolute paths</span>
            <span class="n">hipified_sources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">hipified_s_abs</span><span class="p">,</span> <span class="n">build_dir</span><span class="p">))</span>

        <span class="n">sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hipified_sources</span><span class="p">)</span>

    <span class="n">include_dirs</span> <span class="o">+=</span> <span class="n">include_paths</span><span class="p">(</span><span class="n">device_type</span><span class="o">=</span><span class="s2">"cuda"</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'include_dirs'</span><span class="p">]</span> <span class="o">=</span> <span class="n">include_dirs</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'language'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'c++'</span>

    <span class="n">dlink_libraries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'dlink_libraries'</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">dlink</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'dlink'</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">dlink_libraries</span>
    <span class="k">if</span> <span class="n">dlink</span><span class="p">:</span>
        <span class="n">extra_compile_args</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'extra_compile_args'</span><span class="p">,</span> <span class="p">{})</span>

        <span class="n">extra_compile_args_dlink</span> <span class="o">=</span> <span class="n">extra_compile_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'nvcc_dlink'</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">extra_compile_args_dlink</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'-dlink'</span><span class="p">]</span>
        <span class="n">extra_compile_args_dlink</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'-L</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">library_dirs</span><span class="p">]</span>
        <span class="n">extra_compile_args_dlink</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'-l</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dlink_libraries</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">TorchVersion</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="s1">'11.2'</span><span class="p">:</span>
            <span class="n">extra_compile_args_dlink</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'-dlto'</span><span class="p">]</span>   <span class="c1"># Device Link Time Optimization started from cuda 11.2</span>

        <span class="n">extra_compile_args</span><span class="p">[</span><span class="s1">'nvcc_dlink'</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_compile_args_dlink</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">'extra_compile_args'</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_compile_args</span>

    <span class="k">return</span> <span class="n">setuptools</span><span class="o">.</span><span class="n">Extension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="SyclExtension"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.SyclExtension">[docs]</a><span class="k">def</span> <span class="nf">SyclExtension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">"""</span>
<span class="sd">    Creates a :class:`setuptools.Extension` for SYCL/C++.</span>

<span class="sd">    Convenience method that creates a :class:`setuptools.Extension` with the</span>
<span class="sd">    bare minimum (but often sufficient) arguments to build a SYCL/C++</span>
<span class="sd">    extension.</span>

<span class="sd">    All arguments are forwarded to the :class:`setuptools.Extension`</span>
<span class="sd">    constructor.</span>

<span class="sd">    .. warning::</span>
<span class="sd">        The PyTorch python API (as provided in libtorch_python) cannot be built</span>
<span class="sd">        with the flag ``py_limited_api=True``.  When this flag is passed, it is</span>
<span class="sd">        the user's responsibility in their library to not use APIs from</span>
<span class="sd">        libtorch_python (in particular pytorch/python bindings) and to only use</span>
<span class="sd">        APIs from libtorch (aten objects, operators and the dispatcher). For</span>
<span class="sd">        example, to give access to custom ops from python, the library should</span>
<span class="sd">        register the ops through the dispatcher.</span>

<span class="sd">        Contrary to CPython setuptools, who does not define -DPy_LIMITED_API</span>
<span class="sd">        as a compile flag when py_limited_api is specified as an option for</span>
<span class="sd">        the "bdist_wheel" command in ``setup``, PyTorch does! We will specify</span>
<span class="sd">        -DPy_LIMITED_API=min_supported_cpython to best enforce consistency,</span>
<span class="sd">        safety, and sanity in order to encourage best practices. To target a</span>
<span class="sd">        different version, set min_supported_cpython to the hexcode of the</span>
<span class="sd">        CPython version of choice.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_CPP_EXT)</span>
<span class="sd">        &gt;&gt;&gt; from torch.utils.cpp_extension import BuildExtension, SyclExtension</span>
<span class="sd">        &gt;&gt;&gt; setup(</span>
<span class="sd">        ...     name='xpu_extension',</span>
<span class="sd">        ...     ext_modules=[</span>
<span class="sd">        ...     SyclExtension(</span>
<span class="sd">        ...                 name='xpu_extension',</span>
<span class="sd">        ...                 sources=['extension.cpp', 'extension_kernel.cpp'],</span>
<span class="sd">        ...                 extra_compile_args={'cxx': ['-g', '-std=c++20', '-fPIC']})</span>
<span class="sd">        ...     ],</span>
<span class="sd">        ...     cmdclass={</span>
<span class="sd">        ...         'build_ext': BuildExtension</span>
<span class="sd">        ...     })</span>

<span class="sd">    By default the extension will be compiled to run on all archs of the cards visible during the</span>
<span class="sd">    building process of the extension. If down the road a new card is installed the</span>
<span class="sd">    extension may need to be recompiled. You can override the default behavior using</span>
<span class="sd">    `TORCH_XPU_ARCH_LIST` to explicitly specify which device architectures you want the extension</span>
<span class="sd">    to support:</span>

<span class="sd">    ``TORCH_XPU_ARCH_LIST="pvc,xe-lpg" python build_my_extension.py``</span>

<span class="sd">    Note that while it's possible to include all supported archs, the more archs get included the</span>
<span class="sd">    slower the building process will be, as it will build a separate kernel image for each arch.</span>

<span class="sd">    Note: Ninja is required to build SyclExtension.</span>
<span class="sd">    """</span>
    <span class="n">library_dirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"library_dirs"</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">library_dirs</span> <span class="o">+=</span> <span class="n">library_paths</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">"library_dirs"</span><span class="p">]</span> <span class="o">=</span> <span class="n">library_dirs</span>

    <span class="n">libraries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"libraries"</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"c10"</span><span class="p">)</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"c10_xpu"</span><span class="p">)</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"torch"</span><span class="p">)</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"torch_cpu"</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'py_limited_api'</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># torch_python uses more than the python limited api</span>
        <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"torch_python"</span><span class="p">)</span>
    <span class="n">libraries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"torch_xpu"</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">"libraries"</span><span class="p">]</span> <span class="o">=</span> <span class="n">libraries</span>

    <span class="n">include_dirs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"include_dirs"</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">include_dirs</span> <span class="o">+=</span> <span class="n">include_paths</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s2">"include_dirs"</span><span class="p">]</span> <span class="o">=</span> <span class="n">include_dirs</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s2">"language"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"c++"</span>

    <span class="k">return</span> <span class="n">setuptools</span><span class="o">.</span><span class="n">Extension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="include_paths"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.include_paths">[docs]</a><span class="k">def</span> <span class="nf">include_paths</span><span class="p">(</span><span class="n">device_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"cpu"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Get the include paths required to build a C++ or CUDA or SYCL extension.</span>

<span class="sd">    Args:</span>
<span class="sd">        device_type: Defaults to "cpu".</span>
<span class="sd">    Returns:</span>
<span class="sd">        A list of include path strings.</span>
<span class="sd">    """</span>
    <span class="n">lib_include</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TORCH_PATH</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">)</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">lib_include</span><span class="p">,</span>
        <span class="c1"># Remove this once torch/torch.h is officially no longer supported for C++ extensions.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lib_include</span><span class="p">,</span> <span class="s1">'torch'</span><span class="p">,</span> <span class="s1">'csrc'</span><span class="p">,</span> <span class="s1">'api'</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"cuda"</span> <span class="ow">and</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lib_include</span><span class="p">,</span> <span class="s1">'THH'</span><span class="p">))</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_join_rocm_home</span><span class="p">(</span><span class="s1">'include'</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"cuda"</span><span class="p">:</span>
        <span class="n">cuda_home_include</span> <span class="o">=</span> <span class="n">_join_cuda_home</span><span class="p">(</span><span class="s1">'include'</span><span class="p">)</span>
        <span class="c1"># if we have the Debian/Ubuntu packages for cuda, we get /usr as cuda home.</span>
        <span class="c1"># but gcc doesn't like having /usr/include passed explicitly</span>
        <span class="k">if</span> <span class="n">cuda_home_include</span> <span class="o">!=</span> <span class="s1">'/usr/include'</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda_home_include</span><span class="p">)</span>

        <span class="c1"># Support CUDA_INC_PATH env variable supported by CMake files</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cuda_inc_path</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"CUDA_INC_PATH"</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">and</span> \
                <span class="n">cuda_inc_path</span> <span class="o">!=</span> <span class="s1">'/usr/include'</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda_inc_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CUDNN_HOME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUDNN_HOME</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"xpu"</span><span class="p">:</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_join_sycl_home</span><span class="p">(</span><span class="s1">'include'</span><span class="p">))</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_join_sycl_home</span><span class="p">(</span><span class="s1">'include'</span><span class="p">,</span> <span class="s1">'sycl'</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">paths</span></div>


<span class="k">def</span> <span class="nf">library_paths</span><span class="p">(</span><span class="n">device_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"cpu"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Get the library paths required to build a C++ or CUDA extension.</span>

<span class="sd">    Args:</span>
<span class="sd">        device_type: Defaults to "cpu".</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of library path strings.</span>
<span class="sd">    """</span>
    <span class="c1"># We need to link against libtorch.so</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">TORCH_LIB_PATH</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"cuda"</span> <span class="ow">and</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
        <span class="n">lib_dir</span> <span class="o">=</span> <span class="s1">'lib'</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_join_rocm_home</span><span class="p">(</span><span class="n">lib_dir</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">HIP_HOME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HIP_HOME</span><span class="p">,</span> <span class="s1">'lib'</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"cuda"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">lib_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'lib'</span><span class="p">,</span> <span class="s1">'x64'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lib_dir</span> <span class="o">=</span> <span class="s1">'lib64'</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_join_cuda_home</span><span class="p">(</span><span class="n">lib_dir</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_join_cuda_home</span><span class="p">(</span><span class="s1">'lib'</span><span class="p">))):</span>
                <span class="c1"># 64-bit CUDA may be installed in 'lib' (see e.g. gh-16955)</span>
                <span class="c1"># Note that it's also possible both don't exist (see</span>
                <span class="c1"># _find_cuda_home) - in that case we stay with 'lib64'.</span>
                <span class="n">lib_dir</span> <span class="o">=</span> <span class="s1">'lib'</span>

        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_join_cuda_home</span><span class="p">(</span><span class="n">lib_dir</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">CUDNN_HOME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUDNN_HOME</span><span class="p">,</span> <span class="n">lib_dir</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">"xpu"</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">lib_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">'lib'</span><span class="p">,</span> <span class="s1">'x64'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lib_dir</span> <span class="o">=</span> <span class="s1">'lib64'</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_join_sycl_home</span><span class="p">(</span><span class="n">lib_dir</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_join_sycl_home</span><span class="p">(</span><span class="s1">'lib'</span><span class="p">))):</span>
                <span class="n">lib_dir</span> <span class="o">=</span> <span class="s1">'lib'</span>

        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_join_sycl_home</span><span class="p">(</span><span class="n">lib_dir</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">paths</span>


<div class="viewcode-block" id="load"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.load">[docs]</a><span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
         <span class="n">sources</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
         <span class="n">extra_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">extra_cuda_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">extra_sycl_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">extra_ldflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">extra_include_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">build_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
         <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">with_cuda</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">with_sycl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
         <span class="n">is_python_module</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">is_standalone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
         <span class="n">keep_intermediates</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Load a PyTorch C++ extension just-in-time (JIT).</span>

<span class="sd">    To load an extension, a Ninja build file is emitted, which is used to</span>
<span class="sd">    compile the given sources into a dynamic library. This library is</span>
<span class="sd">    subsequently loaded into the current Python process as a module and</span>
<span class="sd">    returned from this function, ready for use.</span>

<span class="sd">    By default, the directory to which the build file is emitted and the</span>
<span class="sd">    resulting library compiled to is ``&lt;tmp&gt;/torch_extensions/&lt;name&gt;``, where</span>
<span class="sd">    ``&lt;tmp&gt;`` is the temporary folder on the current platform and ``&lt;name&gt;``</span>
<span class="sd">    the name of the extension. This location can be overridden in two ways.</span>
<span class="sd">    First, if the ``TORCH_EXTENSIONS_DIR`` environment variable is set, it</span>
<span class="sd">    replaces ``&lt;tmp&gt;/torch_extensions`` and all extensions will be compiled</span>
<span class="sd">    into subfolders of this directory. Second, if the ``build_directory``</span>
<span class="sd">    argument to this function is supplied, it overrides the entire path, i.e.</span>
<span class="sd">    the library will be compiled into that folder directly.</span>

<span class="sd">    To compile the sources, the default system compiler (``c++``) is used,</span>
<span class="sd">    which can be overridden by setting the ``CXX`` environment variable. To pass</span>
<span class="sd">    additional arguments to the compilation process, ``extra_cflags`` or</span>
<span class="sd">    ``extra_ldflags`` can be provided. For example, to compile your extension</span>
<span class="sd">    with optimizations, pass ``extra_cflags=['-O3']``. You can also use</span>
<span class="sd">    ``extra_cflags`` to pass further include directories.</span>

<span class="sd">    CUDA support with mixed compilation is provided. Simply pass CUDA source</span>
<span class="sd">    files (``.cu`` or ``.cuh``) along with other sources. Such files will be</span>
<span class="sd">    detected and compiled with nvcc rather than the C++ compiler. This includes</span>
<span class="sd">    passing the CUDA lib64 directory as a library directory, and linking</span>
<span class="sd">    ``cudart``. You can pass additional flags to nvcc via</span>
<span class="sd">    ``extra_cuda_cflags``, just like with ``extra_cflags`` for C++. Various</span>
<span class="sd">    heuristics for finding the CUDA install directory are used, which usually</span>
<span class="sd">    work fine. If not, setting the ``CUDA_HOME`` environment variable is the</span>
<span class="sd">    safest option.</span>

<span class="sd">    SYCL support with mixed compilation is provided. Simply pass SYCL source</span>
<span class="sd">    files (``.sycl``) along with other sources. Such files will be detected</span>
<span class="sd">    and compiled with SYCL compiler (such as Intel DPC++ Compiler) rather</span>
<span class="sd">    than the C++ compiler. You can pass additional flags to SYCL compiler</span>
<span class="sd">    via ``extra_sycl_cflags``, just like with ``extra_cflags`` for C++.</span>
<span class="sd">    SYCL compiler is expected to be found via system PATH environment</span>
<span class="sd">    variable.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the extension to build. This MUST be the same as the</span>
<span class="sd">            name of the pybind11 module!</span>
<span class="sd">        sources: A list of relative or absolute paths to C++ source files.</span>
<span class="sd">        extra_cflags: optional list of compiler flags to forward to the build.</span>
<span class="sd">        extra_cuda_cflags: optional list of compiler flags to forward to nvcc</span>
<span class="sd">            when building CUDA sources.</span>
<span class="sd">        extra_sycl_cflags: optional list of compiler flags to forward to SYCL</span>
<span class="sd">            compiler when building SYCL sources.</span>
<span class="sd">        extra_ldflags: optional list of linker flags to forward to the build.</span>
<span class="sd">        extra_include_paths: optional list of include directories to forward</span>
<span class="sd">            to the build.</span>
<span class="sd">        build_directory: optional path to use as build workspace.</span>
<span class="sd">        verbose: If ``True``, turns on verbose logging of load steps.</span>
<span class="sd">        with_cuda: Determines whether CUDA headers and libraries are added to</span>
<span class="sd">            the build. If set to ``None`` (default), this value is</span>
<span class="sd">            automatically determined based on the existence of ``.cu`` or</span>
<span class="sd">            ``.cuh`` in ``sources``. Set it to `True`` to force CUDA headers</span>
<span class="sd">            and libraries to be included.</span>
<span class="sd">        with_sycl: Determines whether SYCL headers and libraries are added to</span>
<span class="sd">            the build. If set to ``None`` (default), this value is</span>
<span class="sd">            automatically determined based on the existence of ``.sycl`` in</span>
<span class="sd">            ``sources``. Set it to `True`` to force SYCL headers and</span>
<span class="sd">            libraries to be included.</span>
<span class="sd">        is_python_module: If ``True`` (default), imports the produced shared</span>
<span class="sd">            library as a Python module. If ``False``, behavior depends on</span>
<span class="sd">            ``is_standalone``.</span>
<span class="sd">        is_standalone: If ``False`` (default) loads the constructed extension</span>
<span class="sd">            into the process as a plain dynamic library. If ``True``, build a</span>
<span class="sd">            standalone executable.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If ``is_python_module`` is ``True``:</span>
<span class="sd">            Returns the loaded PyTorch extension as a Python module.</span>

<span class="sd">        If ``is_python_module`` is ``False`` and ``is_standalone`` is ``False``:</span>
<span class="sd">            Returns nothing. (The shared library is loaded into the process as</span>
<span class="sd">            a side effect.)</span>

<span class="sd">        If ``is_standalone`` is ``True``.</span>
<span class="sd">            Return the path to the executable. (On Windows, TORCH_LIB_PATH is</span>
<span class="sd">            added to the PATH environment variable as a side effect.)</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +SKIP</span>
<span class="sd">        &gt;&gt;&gt; from torch.utils.cpp_extension import load</span>
<span class="sd">        &gt;&gt;&gt; module = load(</span>
<span class="sd">        ...     name='extension',</span>
<span class="sd">        ...     sources=['extension.cpp', 'extension_kernel.cu'],</span>
<span class="sd">        ...     extra_cflags=['-O2'],</span>
<span class="sd">        ...     verbose=True)</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">_jit_compile</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="p">[</span><span class="n">sources</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">sources</span><span class="p">,</span>
        <span class="n">extra_cflags</span><span class="p">,</span>
        <span class="n">extra_cuda_cflags</span><span class="p">,</span>
        <span class="n">extra_sycl_cflags</span><span class="p">,</span>
        <span class="n">extra_ldflags</span><span class="p">,</span>
        <span class="n">extra_include_paths</span><span class="p">,</span>
        <span class="n">build_directory</span> <span class="ow">or</span> <span class="n">_get_build_directory</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">verbose</span><span class="p">),</span>
        <span class="n">verbose</span><span class="p">,</span>
        <span class="n">with_cuda</span><span class="p">,</span>
        <span class="n">with_sycl</span><span class="p">,</span>
        <span class="n">is_python_module</span><span class="p">,</span>
        <span class="n">is_standalone</span><span class="p">,</span>
        <span class="n">keep_intermediates</span><span class="o">=</span><span class="n">keep_intermediates</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">_get_pybind11_abi_build_flags</span><span class="p">():</span>
    <span class="c1"># Note [Pybind11 ABI constants]</span>
    <span class="c1">#</span>
    <span class="c1"># Pybind11 before 2.4 used to build an ABI strings using the following pattern:</span>
    <span class="c1"># f"__pybind11_internals_v{PYBIND11_INTERNALS_VERSION}{PYBIND11_INTERNALS_KIND}{PYBIND11_BUILD_TYPE}__"</span>
    <span class="c1"># Since 2.4 compier type, stdlib and build abi parameters are also encoded like this:</span>
    <span class="c1"># f"__pybind11_internals_v{PYBIND11_INTERNALS_VERSION}{PYBIND11_INTERNALS_KIND}{PYBIND11_COMPILER_TYPE}{PYBIND11_STDLIB}{PYBIND11_BUILD_ABI}{PYBIND11_BUILD_TYPE}__"</span>
    <span class="c1">#</span>
    <span class="c1"># This was done in order to further narrow down the chances of compiler ABI incompatibility</span>
    <span class="c1"># that can cause a hard to debug segfaults.</span>
    <span class="c1"># For PyTorch extensions we want to relax those restrictions and pass compiler, stdlib and abi properties</span>
    <span class="c1"># captured during PyTorch native library compilation in torch/csrc/Module.cpp</span>

    <span class="n">abi_cflags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">"COMPILER_TYPE"</span><span class="p">,</span> <span class="s2">"STDLIB"</span><span class="p">,</span> <span class="s2">"BUILD_ABI"</span><span class="p">]:</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"_PYBIND11_</span><span class="si">{</span><span class="n">pname</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">abi_cflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-DPYBIND11_</span><span class="si">{</span><span class="n">pname</span><span class="si">}</span><span class="s1">=</span><span class="se">\\</span><span class="s1">"</span><span class="si">{</span><span class="n">pval</span><span class="si">}</span><span class="se">\\</span><span class="s1">"'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">abi_cflags</span>

<span class="k">def</span> <span class="nf">_get_glibcxx_abi_build_flags</span><span class="p">():</span>
    <span class="n">glibcxx_abi_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'-D_GLIBCXX_USE_CXX11_ABI='</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_GLIBCXX_USE_CXX11_ABI</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">glibcxx_abi_cflags</span>

<span class="k">def</span> <span class="nf">check_compiler_is_gcc</span><span class="p">(</span><span class="n">compiler</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_LINUX</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">env</span><span class="p">[</span><span class="s1">'LC_ALL'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'C'</span>  <span class="c1"># Don't localize output</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">compiler</span><span class="p">,</span> <span class="s1">'-v'</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">SUBPROCESS_DECODE_ARGS</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">version_string</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="n">compiler</span><span class="p">,</span> <span class="s1">'--version'</span><span class="p">],</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">SUBPROCESS_DECODE_ARGS</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="c1"># Check for 'gcc' or 'g++' for sccache wrapper</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">"^COLLECT_GCC=(.*)$"</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">version_string</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">compiler_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="c1"># On RHEL/CentOS c++ is a gcc compiler wrapper</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">compiler_path</span><span class="p">)</span> <span class="o">==</span> <span class="s1">'c++'</span> <span class="ow">and</span> <span class="s1">'gcc version'</span> <span class="ow">in</span> <span class="n">version_string</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">_check_and_build_extension_h_precompiler_headers</span><span class="p">(</span>
        <span class="n">extra_cflags</span><span class="p">,</span>
        <span class="n">extra_include_paths</span><span class="p">,</span>
        <span class="n">is_standalone</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">'''</span>
<span class="sd">    Precompiled Headers(PCH) can pre-build the same headers and reduce build time for pytorch load_inline modules.</span>
<span class="sd">    GCC offical manual: https://gcc.gnu.org/onlinedocs/gcc-4.0.4/gcc/Precompiled-Headers.html</span>
<span class="sd">    PCH only works when built pch file(header.h.gch) and build target have the same build parameters. So, We need</span>
<span class="sd">    add a signature file to record PCH file parameters. If the build parameters(signature) changed, it should rebuild</span>
<span class="sd">    PCH file.</span>

<span class="sd">    Note:</span>
<span class="sd">    1. Windows and MacOS have different PCH mechanism. We only support Linux currently.</span>
<span class="sd">    2. It only works on GCC/G++.</span>
<span class="sd">    '''</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_LINUX</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">compiler</span> <span class="o">=</span> <span class="n">get_cxx_compiler</span><span class="p">()</span>

    <span class="n">b_is_gcc</span> <span class="o">=</span> <span class="n">check_compiler_is_gcc</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b_is_gcc</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">head_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TORCH_PATH</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">,</span> <span class="s1">'torch'</span><span class="p">,</span> <span class="s1">'extension.h'</span><span class="p">)</span>
    <span class="n">head_file_pch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TORCH_PATH</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">,</span> <span class="s1">'torch'</span><span class="p">,</span> <span class="s1">'extension.h.gch'</span><span class="p">)</span>
    <span class="n">head_file_signature</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TORCH_PATH</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">,</span> <span class="s1">'torch'</span><span class="p">,</span> <span class="s1">'extension.h.sign'</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">listToString</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="c1"># initialize an empty string</span>
        <span class="n">string</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">string</span>

        <span class="c1"># traverse in the string</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">+=</span> <span class="p">(</span><span class="n">element</span> <span class="o">+</span> <span class="s1">' '</span><span class="p">)</span>
        <span class="c1"># return string</span>
        <span class="k">return</span> <span class="n">string</span>

    <span class="k">def</span> <span class="nf">format_precompiler_header_cmd</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">head_file</span><span class="p">,</span> <span class="n">head_file_pch</span><span class="p">,</span> <span class="n">common_cflags</span><span class="p">,</span> <span class="n">torch_include_dirs</span><span class="p">,</span> <span class="n">extra_cflags</span><span class="p">,</span> <span class="n">extra_include_paths</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">"[ \n]+"</span><span class="p">,</span>
            <span class="s2">" "</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">"""</span>
<span class="s2">                </span><span class="si">{</span><span class="n">compiler</span><span class="si">}</span><span class="s2"> -x c++-header </span><span class="si">{</span><span class="n">head_file</span><span class="si">}</span><span class="s2"> -o </span><span class="si">{</span><span class="n">head_file_pch</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">torch_include_dirs</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">extra_include_paths</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">extra_cflags</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">common_cflags</span><span class="si">}</span>
<span class="s2">            """</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">command_to_signature</span><span class="p">(</span><span class="n">cmd</span><span class="p">):</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">'_'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">signature</span>

    <span class="k">def</span> <span class="nf">check_pch_signature_in_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">signature</span><span class="p">):</span>
        <span class="n">b_exist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b_exist</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="c1"># read all content of a file</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># check if string present in a file</span>
            <span class="k">return</span> <span class="n">signature</span> <span class="o">==</span> <span class="n">content</span>

    <span class="k">def</span> <span class="nf">_create_if_not_exist</span><span class="p">(</span><span class="n">path_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_dir</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">Path</span><span class="p">(</span><span class="n">path_dir</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># Guard against race condition</span>
                <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Fail to create path </span><span class="si">{</span><span class="n">path_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

    <span class="k">def</span> <span class="nf">write_pch_signature_to_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">pch_sign</span><span class="p">):</span>
        <span class="n">_create_if_not_exist</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file_path</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pch_sign</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build_precompile_header</span><span class="p">(</span><span class="n">pch_cmd</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">pch_cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Compile PreCompile Header fail, command: </span><span class="si">{</span><span class="n">pch_cmd</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>

    <span class="n">extra_cflags_str</span> <span class="o">=</span> <span class="n">listToString</span><span class="p">(</span><span class="n">extra_cflags</span><span class="p">)</span>
    <span class="n">extra_include_paths_str</span> <span class="o">=</span> <span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">"-I</span><span class="si">{</span><span class="n">include</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">include</span> <span class="ow">in</span> <span class="n">extra_include_paths</span><span class="p">]</span> <span class="k">if</span> <span class="n">extra_include_paths</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="p">)</span>

    <span class="n">lib_include</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TORCH_PATH</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">)</span>
    <span class="n">torch_include_dirs</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">f</span><span class="s2">"-I </span><span class="si">{</span><span class="n">lib_include</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span>
        <span class="c1"># Python.h</span>
        <span class="s2">"-I </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sysconfig</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s2">"include"</span><span class="p">)),</span>
        <span class="c1"># torch/all.h</span>
        <span class="s2">"-I </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lib_include</span><span class="p">,</span> <span class="s1">'torch'</span><span class="p">,</span> <span class="s1">'csrc'</span><span class="p">,</span> <span class="s1">'api'</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">)),</span>
    <span class="p">]</span>

    <span class="n">torch_include_dirs_str</span> <span class="o">=</span> <span class="n">listToString</span><span class="p">(</span><span class="n">torch_include_dirs</span><span class="p">)</span>

    <span class="n">common_cflags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_standalone</span><span class="p">:</span>
        <span class="n">common_cflags</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'-DTORCH_API_INCLUDE_EXTENSION_H'</span><span class="p">]</span>

    <span class="n">common_cflags</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'-std=c++17'</span><span class="p">,</span> <span class="s1">'-fPIC'</span><span class="p">]</span>
    <span class="n">common_cflags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_get_pybind11_abi_build_flags</span><span class="p">()]</span>
    <span class="n">common_cflags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_get_glibcxx_abi_build_flags</span><span class="p">()]</span>
    <span class="n">common_cflags_str</span> <span class="o">=</span> <span class="n">listToString</span><span class="p">(</span><span class="n">common_cflags</span><span class="p">)</span>

    <span class="n">pch_cmd</span> <span class="o">=</span> <span class="n">format_precompiler_header_cmd</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">head_file</span><span class="p">,</span> <span class="n">head_file_pch</span><span class="p">,</span> <span class="n">common_cflags_str</span><span class="p">,</span> <span class="n">torch_include_dirs_str</span><span class="p">,</span> <span class="n">extra_cflags_str</span><span class="p">,</span> <span class="n">extra_include_paths_str</span><span class="p">)</span>
    <span class="n">pch_sign</span> <span class="o">=</span> <span class="n">command_to_signature</span><span class="p">(</span><span class="n">pch_cmd</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">head_file_pch</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">build_precompile_header</span><span class="p">(</span><span class="n">pch_cmd</span><span class="p">)</span>
        <span class="n">write_pch_signature_to_file</span><span class="p">(</span><span class="n">head_file_signature</span><span class="p">,</span> <span class="n">pch_sign</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b_same_sign</span> <span class="o">=</span> <span class="n">check_pch_signature_in_file</span><span class="p">(</span><span class="n">head_file_signature</span><span class="p">,</span> <span class="n">pch_sign</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b_same_sign</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">build_precompile_header</span><span class="p">(</span><span class="n">pch_cmd</span><span class="p">)</span>
            <span class="n">write_pch_signature_to_file</span><span class="p">(</span><span class="n">head_file_signature</span><span class="p">,</span> <span class="n">pch_sign</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">remove_extension_h_precompiler_headers</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">_remove_if_file_exists</span><span class="p">(</span><span class="n">path_file</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_file</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path_file</span><span class="p">)</span>

    <span class="n">head_file_pch</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TORCH_PATH</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">,</span> <span class="s1">'torch'</span><span class="p">,</span> <span class="s1">'extension.h.gch'</span><span class="p">)</span>
    <span class="n">head_file_signature</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TORCH_PATH</span><span class="p">,</span> <span class="s1">'include'</span><span class="p">,</span> <span class="s1">'torch'</span><span class="p">,</span> <span class="s1">'extension.h.sign'</span><span class="p">)</span>

    <span class="n">_remove_if_file_exists</span><span class="p">(</span><span class="n">head_file_pch</span><span class="p">)</span>
    <span class="n">_remove_if_file_exists</span><span class="p">(</span><span class="n">head_file_signature</span><span class="p">)</span>

<div class="viewcode-block" id="load_inline"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.load_inline">[docs]</a><span class="k">def</span> <span class="nf">load_inline</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                <span class="n">cpp_sources</span><span class="p">,</span>
                <span class="n">cuda_sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">sycl_sources</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">functions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">extra_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">extra_cuda_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">extra_sycl_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">extra_ldflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">extra_include_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">build_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">with_cuda</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">with_sycl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">is_python_module</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">with_pytorch_error_handling</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">keep_intermediates</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">use_pch</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">'''</span>
<span class="sd">    Load a PyTorch C++ extension just-in-time (JIT) from string sources.</span>

<span class="sd">    This function behaves exactly like :func:`load`, but takes its sources as</span>
<span class="sd">    strings rather than filenames. These strings are stored to files in the</span>
<span class="sd">    build directory, after which the behavior of :func:`load_inline` is</span>
<span class="sd">    identical to :func:`load`.</span>

<span class="sd">    See `the</span>
<span class="sd">    tests &lt;https://github.com/pytorch/pytorch/blob/master/test/test_cpp_extensions_jit.py&gt;`_</span>
<span class="sd">    for good examples of using this function.</span>

<span class="sd">    Sources may omit two required parts of a typical non-inline C++ extension:</span>
<span class="sd">    the necessary header includes, as well as the (pybind11) binding code. More</span>
<span class="sd">    precisely, strings passed to ``cpp_sources`` are first concatenated into a</span>
<span class="sd">    single ``.cpp`` file. This file is then prepended with ``#include</span>
<span class="sd">    &lt;torch/extension.h&gt;``.</span>

<span class="sd">    Furthermore, if the ``functions`` argument is supplied, bindings will be</span>
<span class="sd">    automatically generated for each function specified. ``functions`` can</span>
<span class="sd">    either be a list of function names, or a dictionary mapping from function</span>
<span class="sd">    names to docstrings. If a list is given, the name of each function is used</span>
<span class="sd">    as its docstring.</span>

<span class="sd">    The sources in ``cuda_sources`` are concatenated into a separate ``.cu``</span>
<span class="sd">    file and  prepended with ``torch/types.h``, ``cuda.h`` and</span>
<span class="sd">    ``cuda_runtime.h`` includes. The ``.cpp`` and ``.cu`` files are compiled</span>
<span class="sd">    separately, but ultimately linked into a single library. Note that no</span>
<span class="sd">    bindings are generated for functions in ``cuda_sources`` per se. To bind</span>
<span class="sd">    to a CUDA kernel, you must create a C++ function that calls it, and either</span>
<span class="sd">    declare or define this C++ function in one of the ``cpp_sources`` (and</span>
<span class="sd">    include its name in ``functions``).</span>

<span class="sd">    The sources in ``sycl_sources`` are concatenated into a separate ``.sycl``</span>
<span class="sd">    file and  prepended with ``torch/types.h``, ``sycl/sycl.hpp`` includes.</span>
<span class="sd">    The ``.cpp`` and ``.sycl`` files are compiled separately, but ultimately</span>
<span class="sd">    linked into a single library. Note that no bindings are generated for</span>
<span class="sd">    functions in ``sycl_sources`` per se. To bind to a SYCL kernel, you must</span>
<span class="sd">    create a C++ function that calls it, and either declare or define this</span>
<span class="sd">    C++ function in one of the ``cpp_sources`` (and include its name</span>
<span class="sd">    in ``functions``).</span>

<span class="sd">    See :func:`load` for a description of arguments omitted below.</span>

<span class="sd">    Args:</span>
<span class="sd">        cpp_sources: A string, or list of strings, containing C++ source code.</span>
<span class="sd">        cuda_sources: A string, or list of strings, containing CUDA source code.</span>
<span class="sd">        sycl_sources: A string, or list of strings, containing SYCL source code.</span>
<span class="sd">        functions: A list of function names for which to generate function</span>
<span class="sd">            bindings. If a dictionary is given, it should map function names to</span>
<span class="sd">            docstrings (which are otherwise just the function names).</span>
<span class="sd">        with_cuda: Determines whether CUDA headers and libraries are added to</span>
<span class="sd">            the build. If set to ``None`` (default), this value is</span>
<span class="sd">            automatically determined based on whether ``cuda_sources`` is</span>
<span class="sd">            provided. Set it to ``True`` to force CUDA headers</span>
<span class="sd">            and libraries to be included.</span>
<span class="sd">        with_sycl: Determines whether SYCL headers and libraries are added to</span>
<span class="sd">            the build. If set to ``None`` (default), this value is</span>
<span class="sd">            automatically determined based on whether ``sycl_sources`` is</span>
<span class="sd">            provided. Set it to ``True`` to force SYCL headers</span>
<span class="sd">            and libraries to be included.</span>
<span class="sd">        with_pytorch_error_handling: Determines whether pytorch error and</span>
<span class="sd">            warning macros are handled by pytorch instead of pybind. To do</span>
<span class="sd">            this, each function ``foo`` is called via an intermediary ``_safe_foo``</span>
<span class="sd">            function. This redirection might cause issues in obscure cases</span>
<span class="sd">            of cpp. This flag should be set to ``False`` when this redirect</span>
<span class="sd">            causes issues.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; # xdoctest: +REQUIRES(env:TORCH_DOCTEST_CPP_EXT)</span>
<span class="sd">        &gt;&gt;&gt; from torch.utils.cpp_extension import load_inline</span>
<span class="sd">        &gt;&gt;&gt; source = """</span>
<span class="sd">        at::Tensor sin_add(at::Tensor x, at::Tensor y) {</span>
<span class="sd">          return x.sin() + y.sin();</span>
<span class="sd">        }</span>
<span class="sd">        """</span>
<span class="sd">        &gt;&gt;&gt; module = load_inline(name='inline_extension',</span>
<span class="sd">        ...                      cpp_sources=[source],</span>
<span class="sd">        ...                      functions=['sin_add'])</span>

<span class="sd">    .. note::</span>
<span class="sd">        Since load_inline will just-in-time compile the source code, please ensure</span>
<span class="sd">        that you have the right toolchains installed in the runtime. For example,</span>
<span class="sd">        when loading C++, make sure a C++ compiler is available. If you're loading</span>
<span class="sd">        a CUDA extension, you will need to additionally install the corresponding CUDA</span>
<span class="sd">        toolkit (nvcc and any other dependencies your code has). Compiling toolchains</span>
<span class="sd">        are not included when you install torch and must be additionally installed.</span>

<span class="sd">        During compiling, by default, the Ninja backend uses #CPUS + 2 workers to build</span>
<span class="sd">        the extension. This may use up too many resources on some systems. One</span>
<span class="sd">        can control the number of workers by setting the `MAX_JOBS` environment</span>
<span class="sd">        variable to a non-negative number.</span>
<span class="sd">    '''</span>
    <span class="n">build_directory</span> <span class="o">=</span> <span class="n">build_directory</span> <span class="ow">or</span> <span class="n">_get_build_directory</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cpp_sources</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cpp_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">cpp_sources</span><span class="p">]</span>
    <span class="n">cuda_sources</span> <span class="o">=</span> <span class="n">cuda_sources</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cuda_sources</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">cuda_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">cuda_sources</span><span class="p">]</span>
    <span class="n">sycl_sources</span> <span class="o">=</span> <span class="n">sycl_sources</span> <span class="ow">or</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sycl_sources</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">sycl_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">sycl_sources</span><span class="p">]</span>

    <span class="n">cpp_sources</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'#include &lt;torch/extension.h&gt;'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_pch</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># Using PreCompile Header('torch/extension.h') to reduce compile time.</span>
        <span class="n">_check_and_build_extension_h_precompiler_headers</span><span class="p">(</span><span class="n">extra_cflags</span><span class="p">,</span> <span class="n">extra_include_paths</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">remove_extension_h_precompiler_headers</span><span class="p">()</span>

    <span class="c1"># If `functions` is supplied, we create the pybind11 bindings for the user.</span>
    <span class="c1"># Here, `functions` is (or becomes, after some processing) a map from</span>
    <span class="c1"># function names to function docstrings.</span>
    <span class="k">if</span> <span class="n">functions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">module_def</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">module_def</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'PYBIND11_MODULE(TORCH_EXTENSION_NAME, m) {'</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">functions</span> <span class="o">=</span> <span class="p">[</span><span class="n">functions</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Make the function docstring the same as the function name.</span>
            <span class="n">functions</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">}</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">functions</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Expected 'functions' to be a list or dict, but was </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">function_name</span><span class="p">,</span> <span class="n">docstring</span> <span class="ow">in</span> <span class="n">functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">with_pytorch_error_handling</span><span class="p">:</span>
                <span class="n">module_def</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'m.def("</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1">", torch::wrap_pybind_function(</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1">), "</span><span class="si">{</span><span class="n">docstring</span><span class="si">}</span><span class="s1">");'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">module_def</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'m.def("</span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1">", </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s1">, "</span><span class="si">{</span><span class="n">docstring</span><span class="si">}</span><span class="s1">");'</span><span class="p">)</span>
        <span class="n">module_def</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'}'</span><span class="p">)</span>
        <span class="n">cpp_sources</span> <span class="o">+=</span> <span class="n">module_def</span>

    <span class="n">cpp_source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_directory</span><span class="p">,</span> <span class="s1">'main.cpp'</span><span class="p">)</span>
    <span class="n">_maybe_write</span><span class="p">(</span><span class="n">cpp_source_path</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cpp_sources</span><span class="p">))</span>

    <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">cpp_source_path</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cuda_sources</span><span class="p">:</span>
        <span class="n">cuda_sources</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'#include &lt;torch/types.h&gt;'</span><span class="p">)</span>
        <span class="n">cuda_sources</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'#include &lt;cuda.h&gt;'</span><span class="p">)</span>
        <span class="n">cuda_sources</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">'#include &lt;cuda_runtime.h&gt;'</span><span class="p">)</span>

        <span class="n">cuda_source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_directory</span><span class="p">,</span> <span class="s1">'cuda.cu'</span><span class="p">)</span>
        <span class="n">_maybe_write</span><span class="p">(</span><span class="n">cuda_source_path</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cuda_sources</span><span class="p">))</span>

        <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda_source_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sycl_sources</span><span class="p">:</span>
        <span class="n">sycl_sources</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'#include &lt;torch/types.h&gt;'</span><span class="p">)</span>
        <span class="n">sycl_sources</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'#include &lt;sycl/sycl.hpp&gt;'</span><span class="p">)</span>

        <span class="n">sycl_source_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_directory</span><span class="p">,</span> <span class="s1">'sycl.sycl'</span><span class="p">)</span>
        <span class="n">_maybe_write</span><span class="p">(</span><span class="n">sycl_source_path</span><span class="p">,</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sycl_sources</span><span class="p">))</span>

        <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sycl_source_path</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_jit_compile</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">sources</span><span class="p">,</span>
        <span class="n">extra_cflags</span><span class="p">,</span>
        <span class="n">extra_cuda_cflags</span><span class="p">,</span>
        <span class="n">extra_sycl_cflags</span><span class="p">,</span>
        <span class="n">extra_ldflags</span><span class="p">,</span>
        <span class="n">extra_include_paths</span><span class="p">,</span>
        <span class="n">build_directory</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">,</span>
        <span class="n">with_cuda</span><span class="p">,</span>
        <span class="n">with_sycl</span><span class="p">,</span>
        <span class="n">is_python_module</span><span class="p">,</span>
        <span class="n">is_standalone</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">keep_intermediates</span><span class="o">=</span><span class="n">keep_intermediates</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_jit_compile</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                 <span class="n">sources</span><span class="p">,</span>
                 <span class="n">extra_cflags</span><span class="p">,</span>
                 <span class="n">extra_cuda_cflags</span><span class="p">,</span>
                 <span class="n">extra_sycl_cflags</span><span class="p">,</span>
                 <span class="n">extra_ldflags</span><span class="p">,</span>
                 <span class="n">extra_include_paths</span><span class="p">,</span>
                 <span class="n">build_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                 <span class="n">with_cuda</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
                 <span class="n">with_sycl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
                 <span class="n">is_python_module</span><span class="p">,</span>
                 <span class="n">is_standalone</span><span class="p">,</span>
                 <span class="n">keep_intermediates</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_python_module</span> <span class="ow">and</span> <span class="n">is_standalone</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"`is_python_module` and `is_standalone` are mutually exclusive."</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_cuda</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">with_cuda</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_cuda_file</span><span class="p">,</span> <span class="n">sources</span><span class="p">))</span>
    <span class="n">with_cudnn</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="s1">'cudnn'</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">extra_ldflags</span> <span class="ow">or</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="n">with_sycl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">with_sycl</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_sycl_file</span><span class="p">,</span> <span class="n">sources</span><span class="p">))</span>
    <span class="n">old_version</span> <span class="o">=</span> <span class="n">JIT_EXTENSION_VERSIONER</span><span class="o">.</span><span class="n">get_version</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">JIT_EXTENSION_VERSIONER</span><span class="o">.</span><span class="n">bump_version_if_changed</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">sources</span><span class="p">,</span>
        <span class="n">build_arguments</span><span class="o">=</span><span class="p">[</span><span class="n">extra_cflags</span><span class="p">,</span> <span class="n">extra_cuda_cflags</span><span class="p">,</span> <span class="n">extra_ldflags</span><span class="p">,</span> <span class="n">extra_include_paths</span><span class="p">],</span>
        <span class="n">build_directory</span><span class="o">=</span><span class="n">build_directory</span><span class="p">,</span>
        <span class="n">with_cuda</span><span class="o">=</span><span class="n">with_cuda</span><span class="p">,</span>
        <span class="n">with_sycl</span><span class="o">=</span><span class="n">with_sycl</span><span class="p">,</span>
        <span class="n">is_python_module</span><span class="o">=</span><span class="n">is_python_module</span><span class="p">,</span>
        <span class="n">is_standalone</span><span class="o">=</span><span class="n">is_standalone</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="n">old_version</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'The input conditions for extension module </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1"> have changed. '</span> <span class="o">+</span>
                  <span class="sa">f</span><span class="s1">'Bumping to version </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1"> and re-building as </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1">...'</span><span class="p">,</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_v</span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1">'</span>

    <span class="n">baton</span> <span class="o">=</span> <span class="n">FileBaton</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_directory</span><span class="p">,</span> <span class="s1">'lock'</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">baton</span><span class="o">.</span><span class="n">try_acquire</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="n">old_version</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">GeneratedFileCleaner</span><span class="p">(</span><span class="n">keep_intermediates</span><span class="o">=</span><span class="n">keep_intermediates</span><span class="p">)</span> <span class="k">as</span> <span class="n">clean_ctx</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span> <span class="ow">and</span> <span class="p">(</span><span class="n">with_cuda</span> <span class="ow">or</span> <span class="n">with_cudnn</span><span class="p">):</span>
                        <span class="n">hipify_result</span> <span class="o">=</span> <span class="n">hipify_python</span><span class="o">.</span><span class="n">hipify</span><span class="p">(</span>
                            <span class="n">project_directory</span><span class="o">=</span><span class="n">build_directory</span><span class="p">,</span>
                            <span class="n">output_directory</span><span class="o">=</span><span class="n">build_directory</span><span class="p">,</span>
                            <span class="n">header_include_dirs</span><span class="o">=</span><span class="p">(</span><span class="n">extra_include_paths</span> <span class="k">if</span> <span class="n">extra_include_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[]),</span>
                            <span class="n">extra_files</span><span class="o">=</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">],</span>
                            <span class="n">ignores</span><span class="o">=</span><span class="p">[</span><span class="n">_join_rocm_home</span><span class="p">(</span><span class="s1">'*'</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_TORCH_PATH</span><span class="p">,</span> <span class="s1">'*'</span><span class="p">)],</span>  <span class="c1"># no need to hipify ROCm or PyTorch headers</span>
                            <span class="n">show_detailed</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                            <span class="n">show_progress</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                            <span class="n">is_pytorch_extension</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">clean_ctx</span><span class="o">=</span><span class="n">clean_ctx</span>
                        <span class="p">)</span>

                        <span class="n">hipified_sources</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                            <span class="n">s_abs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                            <span class="n">hipified_sources</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hipify_result</span><span class="p">[</span><span class="n">s_abs</span><span class="p">]</span><span class="o">.</span><span class="n">hipified_path</span> <span class="k">if</span> <span class="n">s_abs</span> <span class="ow">in</span> <span class="n">hipify_result</span> <span class="k">else</span> <span class="n">s_abs</span><span class="p">)</span>

                        <span class="n">sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hipified_sources</span><span class="p">)</span>

                    <span class="n">_write_ninja_file_and_build_library</span><span class="p">(</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
                        <span class="n">extra_cflags</span><span class="o">=</span><span class="n">extra_cflags</span> <span class="ow">or</span> <span class="p">[],</span>
                        <span class="n">extra_cuda_cflags</span><span class="o">=</span><span class="n">extra_cuda_cflags</span> <span class="ow">or</span> <span class="p">[],</span>
                        <span class="n">extra_sycl_cflags</span><span class="o">=</span><span class="n">extra_sycl_cflags</span> <span class="ow">or</span> <span class="p">[],</span>
                        <span class="n">extra_ldflags</span><span class="o">=</span><span class="n">extra_ldflags</span> <span class="ow">or</span> <span class="p">[],</span>
                        <span class="n">extra_include_paths</span><span class="o">=</span><span class="n">extra_include_paths</span> <span class="ow">or</span> <span class="p">[],</span>
                        <span class="n">build_directory</span><span class="o">=</span><span class="n">build_directory</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                        <span class="n">with_cuda</span><span class="o">=</span><span class="n">with_cuda</span><span class="p">,</span>
                        <span class="n">with_sycl</span><span class="o">=</span><span class="n">with_sycl</span><span class="p">,</span>
                        <span class="n">is_standalone</span><span class="o">=</span><span class="n">is_standalone</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'No modifications detected for re-loaded extension '</span>
                      <span class="sa">f</span><span class="s1">'module </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">, skipping build step...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">baton</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">baton</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Loading extension module </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_standalone</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_get_exec_path</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">build_directory</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_import_module_from_library</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">build_directory</span><span class="p">,</span> <span class="n">is_python_module</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_write_ninja_file_and_compile_objects</span><span class="p">(</span>
        <span class="n">sources</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">objects</span><span class="p">,</span>
        <span class="n">cflags</span><span class="p">,</span>
        <span class="n">post_cflags</span><span class="p">,</span>
        <span class="n">cuda_cflags</span><span class="p">,</span>
        <span class="n">cuda_post_cflags</span><span class="p">,</span>
        <span class="n">cuda_dlink_post_cflags</span><span class="p">,</span>
        <span class="n">sycl_cflags</span><span class="p">,</span>
        <span class="n">sycl_post_cflags</span><span class="p">,</span>
        <span class="n">sycl_dlink_post_cflags</span><span class="p">,</span>
        <span class="n">build_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">with_cuda</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
        <span class="n">with_sycl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">verify_ninja_availability</span><span class="p">()</span>

    <span class="n">compiler</span> <span class="o">=</span> <span class="n">get_cxx_compiler</span><span class="p">()</span>

    <span class="n">get_compiler_abi_compatibility_and_version</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_cuda</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">with_cuda</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_cuda_file</span><span class="p">,</span> <span class="n">sources</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">with_sycl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">with_sycl</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_sycl_file</span><span class="p">,</span> <span class="n">sources</span><span class="p">))</span>
    <span class="n">build_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_directory</span><span class="p">,</span> <span class="s1">'build.ninja'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Emitting ninja build file </span><span class="si">{</span><span class="n">build_file_path</span><span class="si">}</span><span class="s1">...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="c1"># Create build_directory if it does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">build_directory</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Creating directory </span><span class="si">{</span><span class="n">build_directory</span><span class="si">}</span><span class="s1">...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="c1"># This is like mkdir -p, i.e. will also create parent directories.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">build_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">_write_ninja_file</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">build_file_path</span><span class="p">,</span>
        <span class="n">cflags</span><span class="o">=</span><span class="n">cflags</span><span class="p">,</span>
        <span class="n">post_cflags</span><span class="o">=</span><span class="n">post_cflags</span><span class="p">,</span>
        <span class="n">cuda_cflags</span><span class="o">=</span><span class="n">cuda_cflags</span><span class="p">,</span>
        <span class="n">cuda_post_cflags</span><span class="o">=</span><span class="n">cuda_post_cflags</span><span class="p">,</span>
        <span class="n">cuda_dlink_post_cflags</span><span class="o">=</span><span class="n">cuda_dlink_post_cflags</span><span class="p">,</span>
        <span class="n">sycl_cflags</span><span class="o">=</span><span class="n">sycl_cflags</span><span class="p">,</span>
        <span class="n">sycl_post_cflags</span><span class="o">=</span><span class="n">sycl_post_cflags</span><span class="p">,</span>
        <span class="n">sycl_dlink_post_cflags</span><span class="o">=</span><span class="n">sycl_dlink_post_cflags</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
        <span class="n">objects</span><span class="o">=</span><span class="n">objects</span><span class="p">,</span>
        <span class="n">ldflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">library_target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">with_cuda</span><span class="o">=</span><span class="n">with_cuda</span><span class="p">,</span>
        <span class="n">with_sycl</span><span class="o">=</span><span class="n">with_sycl</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Compiling objects...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">_run_ninja_build</span><span class="p">(</span>
        <span class="n">build_directory</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">,</span>
        <span class="c1"># It would be better if we could tell users the name of the extension</span>
        <span class="c1"># that failed to build but there isn't a good way to get it here.</span>
        <span class="n">error_prefix</span><span class="o">=</span><span class="s1">'Error compiling objects for extension'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_write_ninja_file_and_build_library</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">sources</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">extra_cflags</span><span class="p">,</span>
        <span class="n">extra_cuda_cflags</span><span class="p">,</span>
        <span class="n">extra_sycl_cflags</span><span class="p">,</span>
        <span class="n">extra_ldflags</span><span class="p">,</span>
        <span class="n">extra_include_paths</span><span class="p">,</span>
        <span class="n">build_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">with_cuda</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
        <span class="n">with_sycl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
        <span class="n">is_standalone</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">verify_ninja_availability</span><span class="p">()</span>

    <span class="n">compiler</span> <span class="o">=</span> <span class="n">get_cxx_compiler</span><span class="p">()</span>

    <span class="n">get_compiler_abi_compatibility_and_version</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_cuda</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">with_cuda</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_cuda_file</span><span class="p">,</span> <span class="n">sources</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">with_sycl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">with_sycl</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_sycl_file</span><span class="p">,</span> <span class="n">sources</span><span class="p">))</span>
    <span class="n">extra_ldflags</span> <span class="o">=</span> <span class="n">_prepare_ldflags</span><span class="p">(</span>
        <span class="n">extra_ldflags</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">with_cuda</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">,</span>
        <span class="n">is_standalone</span><span class="p">)</span>
    <span class="n">build_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">build_directory</span><span class="p">,</span> <span class="s1">'build.ninja'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Emitting ninja build file </span><span class="si">{</span><span class="n">build_file_path</span><span class="si">}</span><span class="s1">...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="c1"># Create build_directory if it does not exist</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">build_directory</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Creating directory </span><span class="si">{</span><span class="n">build_directory</span><span class="si">}</span><span class="s1">...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="c1"># This is like mkdir -p, i.e. will also create parent directories.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">build_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># NOTE: Emitting a new ninja build file does not cause re-compilation if</span>
    <span class="c1"># the sources did not change, so it's ok to re-emit (and it's fast).</span>
    <span class="n">_write_ninja_file_to_build_library</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">build_file_path</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
        <span class="n">extra_cflags</span><span class="o">=</span><span class="n">extra_cflags</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">extra_cuda_cflags</span><span class="o">=</span><span class="n">extra_cuda_cflags</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">extra_sycl_cflags</span><span class="o">=</span><span class="n">extra_sycl_cflags</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">extra_ldflags</span><span class="o">=</span><span class="n">extra_ldflags</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">extra_include_paths</span><span class="o">=</span><span class="n">extra_include_paths</span> <span class="ow">or</span> <span class="p">[],</span>
        <span class="n">with_cuda</span><span class="o">=</span><span class="n">with_cuda</span><span class="p">,</span>
        <span class="n">with_sycl</span><span class="o">=</span><span class="n">with_sycl</span><span class="p">,</span>
        <span class="n">is_standalone</span><span class="o">=</span><span class="n">is_standalone</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Building extension module </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">_run_ninja_build</span><span class="p">(</span>
        <span class="n">build_directory</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">,</span>
        <span class="n">error_prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Error building extension '</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>


<div class="viewcode-block" id="is_ninja_available"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.is_ninja_available">[docs]</a><span class="k">def</span> <span class="nf">is_ninja_available</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""Return ``True`` if the `ninja &lt;https://ninja-build.org/&gt;`_ build system is available on the system, ``False`` otherwise."""</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s1">'ninja --version'</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="verify_ninja_availability"><a class="viewcode-back" href="../../../cpp_extension.html#torch.utils.cpp_extension.verify_ninja_availability">[docs]</a><span class="k">def</span> <span class="nf">verify_ninja_availability</span><span class="p">():</span>
<span class="w">    </span><span class="sd">"""Raise ``RuntimeError`` if `ninja &lt;https://ninja-build.org/&gt;`_ build system is not available on the system, does nothing otherwise."""</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ninja_available</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Ninja is required to load C++ extensions"</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_prepare_ldflags</span><span class="p">(</span><span class="n">extra_ldflags</span><span class="p">,</span> <span class="n">with_cuda</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">is_standalone</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">python_lib_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">base_exec_prefix</span><span class="p">,</span> <span class="s1">'libs'</span><span class="p">)</span>

        <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'c10.lib'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'c10_cuda.lib'</span><span class="p">)</span>
        <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch_cpu.lib'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch_cuda.lib'</span><span class="p">)</span>
            <span class="c1"># /INCLUDE is used to ensure torch_cuda is linked against in a project that relies on it.</span>
            <span class="c1"># Related issue: https://github.com/pytorch/pytorch/issues/31611</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-INCLUDE:?warp_size@cuda@at@@YAHXZ'</span><span class="p">)</span>
        <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch.lib'</span><span class="p">)</span>
        <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'/LIBPATH:</span><span class="si">{</span><span class="n">TORCH_LIB_PATH</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_standalone</span><span class="p">:</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'torch_python.lib'</span><span class="p">)</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'/LIBPATH:</span><span class="si">{</span><span class="n">python_lib_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-L</span><span class="si">{</span><span class="n">TORCH_LIB_PATH</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-lc10'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-lc10_hip'</span> <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span> <span class="k">else</span> <span class="s1">'-lc10_cuda'</span><span class="p">)</span>
        <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-ltorch_cpu'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-ltorch_hip'</span> <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span> <span class="k">else</span> <span class="s1">'-ltorch_cuda'</span><span class="p">)</span>
        <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-ltorch'</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_standalone</span><span class="p">:</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-ltorch_python'</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_standalone</span><span class="p">:</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">"-Wl,-rpath,</span><span class="si">{</span><span class="n">TORCH_LIB_PATH</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'Detected CUDA files, patching ldflags'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'/LIBPATH:</span><span class="si">{</span><span class="n">_join_cuda_home</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">,</span><span class="w"> </span><span class="s2">"x64"</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'cudart.lib'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">CUDNN_HOME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'/LIBPATH:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUDNN_HOME</span><span class="p">,</span><span class="w"> </span><span class="s2">"lib"</span><span class="p">,</span><span class="w"> </span><span class="s2">"x64"</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
            <span class="n">extra_lib_dir</span> <span class="o">=</span> <span class="s2">"lib64"</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_join_cuda_home</span><span class="p">(</span><span class="n">extra_lib_dir</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_join_cuda_home</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">))):</span>
                <span class="c1"># 64-bit CUDA may be installed in "lib"</span>
                <span class="c1"># Note that it's also possible both don't exist (see _find_cuda_home) - in that case we stay with "lib64"</span>
                <span class="n">extra_lib_dir</span> <span class="o">=</span> <span class="s2">"lib"</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-L</span><span class="si">{</span><span class="n">_join_cuda_home</span><span class="p">(</span><span class="n">extra_lib_dir</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-lcudart'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">CUDNN_HOME</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-L</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUDNN_HOME</span><span class="p">,</span><span class="w"> </span><span class="s2">"lib64"</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-L</span><span class="si">{</span><span class="n">_join_rocm_home</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="n">extra_ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-lamdhip64'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">extra_ldflags</span>


<span class="k">def</span> <span class="nf">_get_cuda_arch_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Determine CUDA arch flags to use.</span>

<span class="sd">    For an arch, say "6.1", the added compile flag will be</span>
<span class="sd">    ``-gencode=arch=compute_61,code=sm_61``.</span>
<span class="sd">    For an added "+PTX", an additional</span>
<span class="sd">    ``-gencode=arch=compute_xx,code=compute_xx`` is added.</span>

<span class="sd">    See select_compute_arch.cmake for corresponding named and supported arches</span>
<span class="sd">    when building with CMake.</span>
<span class="sd">    """</span>
    <span class="c1"># If cflags is given, there may already be user-provided arch flags in it</span>
    <span class="c1"># (from `extra_compile_args`)</span>
    <span class="k">if</span> <span class="n">cflags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">cflags</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">'TORCH_EXTENSION_NAME'</span> <span class="ow">in</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">'arch'</span> <span class="ow">in</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Note: keep combined names ("arch1+arch2") above single names, otherwise</span>
    <span class="c1"># string replacement may not do the right thing</span>
    <span class="n">named_arches</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">'Kepler+Tesla'</span><span class="p">,</span> <span class="s1">'3.7'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Kepler'</span><span class="p">,</span> <span class="s1">'3.5+PTX'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Maxwell+Tegra'</span><span class="p">,</span> <span class="s1">'5.3'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Maxwell'</span><span class="p">,</span> <span class="s1">'5.0;5.2+PTX'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Pascal'</span><span class="p">,</span> <span class="s1">'6.0;6.1+PTX'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Volta+Tegra'</span><span class="p">,</span> <span class="s1">'7.2'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Volta'</span><span class="p">,</span> <span class="s1">'7.0+PTX'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Turing'</span><span class="p">,</span> <span class="s1">'7.5+PTX'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Ampere+Tegra'</span><span class="p">,</span> <span class="s1">'8.7'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Ampere'</span><span class="p">,</span> <span class="s1">'8.0;8.6+PTX'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Ada'</span><span class="p">,</span> <span class="s1">'8.9+PTX'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Hopper'</span><span class="p">,</span> <span class="s1">'9.0+PTX'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Blackwell+Tegra'</span><span class="p">,</span> <span class="s1">'10.1'</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">'Blackwell'</span><span class="p">,</span> <span class="s1">'10.0;12.0+PTX'</span><span class="p">),</span>
    <span class="p">])</span>

    <span class="n">supported_arches</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'3.5'</span><span class="p">,</span> <span class="s1">'3.7'</span><span class="p">,</span> <span class="s1">'5.0'</span><span class="p">,</span> <span class="s1">'5.2'</span><span class="p">,</span> <span class="s1">'5.3'</span><span class="p">,</span> <span class="s1">'6.0'</span><span class="p">,</span> <span class="s1">'6.1'</span><span class="p">,</span> <span class="s1">'6.2'</span><span class="p">,</span>
                        <span class="s1">'7.0'</span><span class="p">,</span> <span class="s1">'7.2'</span><span class="p">,</span> <span class="s1">'7.5'</span><span class="p">,</span> <span class="s1">'8.0'</span><span class="p">,</span> <span class="s1">'8.6'</span><span class="p">,</span> <span class="s1">'8.7'</span><span class="p">,</span> <span class="s1">'8.9'</span><span class="p">,</span> <span class="s1">'9.0'</span><span class="p">,</span> <span class="s1">'9.0a'</span><span class="p">,</span>
                        <span class="s1">'10.0'</span><span class="p">,</span> <span class="s1">'10.0a'</span><span class="p">,</span> <span class="s1">'10.1'</span><span class="p">,</span> <span class="s1">'10.1a'</span><span class="p">,</span> <span class="s1">'12.0'</span><span class="p">,</span> <span class="s1">'12.0a'</span><span class="p">]</span>
    <span class="n">valid_arch_strings</span> <span class="o">=</span> <span class="n">supported_arches</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="s2">"+PTX"</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">supported_arches</span><span class="p">]</span>

    <span class="c1"># The default is sm_30 for CUDA 9.x and 10.x</span>
    <span class="c1"># First check for an env var (same as used by the main setup.py)</span>
    <span class="c1"># Can be one or more architectures, e.g. "6.1" or "3.5;5.2;6.0;6.1;7.0+PTX"</span>
    <span class="c1"># See cmake/Modules_CUDA_fix/upstream/FindCUDA/select_compute_arch.cmake</span>
    <span class="n">_arch_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'TORCH_CUDA_ARCH_LIST'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># If not given, determine what's best for the GPU / CUDA version that can be found</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_arch_list</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">"TORCH_CUDA_ARCH_LIST is not set, all archs for visible cards are included for compilation. </span><span class="se">\n</span><span class="s2">"</span>
            <span class="s2">"If this is not desired, please set os.environ['TORCH_CUDA_ARCH_LIST']."</span><span class="p">)</span>
        <span class="n">arch_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># the assumption is that the extension should run on any of the currently visible cards,</span>
        <span class="c1"># which could be of different types - therefore all archs for visible cards should be included</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">device_count</span><span class="p">()):</span>
            <span class="n">capability</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_device_capability</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">supported_sm</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="s2">""</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">"\d+"</span><span class="p">,</span> <span class="n">arch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">)[</span><span class="mi">1</span><span class="p">])))</span>
                            <span class="k">for</span> <span class="n">arch</span> <span class="ow">in</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">get_arch_list</span><span class="p">()</span> <span class="k">if</span> <span class="s1">'sm_'</span> <span class="ow">in</span> <span class="n">arch</span><span class="p">]</span>
            <span class="n">max_supported_sm</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">sm</span> <span class="o">//</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sm</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="k">for</span> <span class="n">sm</span> <span class="ow">in</span> <span class="n">supported_sm</span><span class="p">)</span>
            <span class="c1"># Capability of the device may be higher than what's supported by the user's</span>
            <span class="c1"># NVCC, causing compilation error. User's NVCC is expected to match the one</span>
            <span class="c1"># used to build pytorch, so we use the maximum supported capability of pytorch</span>
            <span class="c1"># to clamp the capability.</span>
            <span class="n">capability</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_supported_sm</span><span class="p">,</span> <span class="n">capability</span><span class="p">)</span>
            <span class="n">arch</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">capability</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">capability</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span>
            <span class="k">if</span> <span class="n">arch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">arch_list</span><span class="p">:</span>
                <span class="n">arch_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arch</span><span class="p">)</span>
        <span class="n">arch_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">arch_list</span><span class="p">)</span>
        <span class="n">arch_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">'+PTX'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Deal with lists that are ' ' separated (only deal with ';' after)</span>
        <span class="n">_arch_list</span> <span class="o">=</span> <span class="n">_arch_list</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">';'</span><span class="p">)</span>
        <span class="c1"># Expand named arches</span>
        <span class="k">for</span> <span class="n">named_arch</span><span class="p">,</span> <span class="n">archval</span> <span class="ow">in</span> <span class="n">named_arches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_arch_list</span> <span class="o">=</span> <span class="n">_arch_list</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">named_arch</span><span class="p">,</span> <span class="n">archval</span><span class="p">)</span>

        <span class="n">arch_list</span> <span class="o">=</span> <span class="n">_arch_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">)</span>

    <span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arch</span> <span class="ow">in</span> <span class="n">arch_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arch</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_arch_strings</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Unknown CUDA arch (</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s2">) or GPU not supported"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle both single and double-digit architecture versions</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">arch</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'+'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Remove "+PTX" if present</span>
            <span class="n">major</span><span class="p">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'.'</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">major</span><span class="si">}{</span><span class="n">minor</span><span class="si">}</span><span class="s2">"</span>
            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-gencode=arch=compute_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s1">,code=sm_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">arch</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'+PTX'</span><span class="p">):</span>
                <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-gencode=arch=compute_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s1">,code=compute_</span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_rocm_arch_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="c1"># If cflags is given, there may already be user-provided arch flags in it</span>
    <span class="c1"># (from `extra_compile_args`)</span>
    <span class="k">if</span> <span class="n">cflags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">cflags</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">'amdgpu-target'</span> <span class="ow">in</span> <span class="n">flag</span> <span class="ow">or</span> <span class="s1">'offload-arch'</span> <span class="ow">in</span> <span class="n">flag</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="s1">'-fno-gpu-rdc'</span><span class="p">]</span>
    <span class="c1"># Use same defaults as used for building PyTorch</span>
    <span class="c1"># Allow env var to override, just like during initial cmake build.</span>
    <span class="n">_archs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'PYTORCH_ROCM_ARCH'</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_archs</span><span class="p">:</span>
        <span class="n">archFlags</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">_C</span><span class="o">.</span><span class="n">_cuda_getArchFlags</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">archFlags</span><span class="p">:</span>
            <span class="n">archs</span> <span class="o">=</span> <span class="n">archFlags</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">archs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">archs</span> <span class="o">=</span> <span class="n">_archs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">' '</span><span class="p">,</span> <span class="s1">';'</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">)</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'--offload-arch=</span><span class="si">{</span><span class="n">arch</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">arch</span> <span class="ow">in</span> <span class="n">archs</span><span class="p">]</span>
    <span class="n">flags</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'-fno-gpu-rdc'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">flags</span>

<span class="k">def</span> <span class="nf">_get_build_directory</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">root_extensions_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'TORCH_EXTENSIONS_DIR'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">root_extensions_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">root_extensions_directory</span> <span class="o">=</span> <span class="n">get_default_build_root</span><span class="p">()</span>
        <span class="n">cu_str</span> <span class="o">=</span> <span class="p">(</span><span class="s1">'cpu'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
                  <span class="sa">f</span><span class="s1">'cu</span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">"."</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'py</span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">major</span><span class="si">}{</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="o">.</span><span class="n">minor</span><span class="si">}{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span><span class="w"> </span><span class="s2">"abiflags"</span><span class="p">,</span><span class="w"> </span><span class="s2">""</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span>
        <span class="n">build_folder</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">python_version</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">cu_str</span><span class="si">}</span><span class="s1">'</span>

        <span class="n">root_extensions_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">root_extensions_directory</span><span class="p">,</span> <span class="n">build_folder</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Using </span><span class="si">{</span><span class="n">root_extensions_directory</span><span class="si">}</span><span class="s1"> as PyTorch extensions root...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="n">build_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_extensions_directory</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">build_directory</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Creating extension directory </span><span class="si">{</span><span class="n">build_directory</span><span class="si">}</span><span class="s1">...'</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="c1"># This is like mkdir -p, i.e. will also create parent directories.</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">build_directory</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">build_directory</span>


<span class="k">def</span> <span class="nf">_get_num_workers</span><span class="p">(</span><span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="n">max_jobs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'MAX_JOBS'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_jobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">max_jobs</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Using envvar MAX_JOBS (</span><span class="si">{</span><span class="n">max_jobs</span><span class="si">}</span><span class="s1">) as the number of workers...'</span><span class="p">,</span>
                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_jobs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Allowing ninja to set a default number of workers... '</span>
              <span class="s1">'(overridable by setting the environment variable MAX_JOBS=N)'</span><span class="p">,</span>
              <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_get_vc_env</span><span class="p">(</span><span class="n">vc_arch</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">distutils</span>
        <span class="k">return</span> <span class="n">distutils</span><span class="o">.</span><span class="n">_msvccompiler</span><span class="o">.</span><span class="n">_get_vc_env</span><span class="p">(</span><span class="n">vc_arch</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">setuptools._distutils</span> <span class="kn">import</span> <span class="n">_msvccompiler</span>
        <span class="k">return</span> <span class="n">_msvccompiler</span><span class="o">.</span><span class="n">_get_vc_env</span><span class="p">(</span><span class="n">vc_arch</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_run_ninja_build</span><span class="p">(</span><span class="n">build_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">error_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'ninja'</span><span class="p">,</span> <span class="s1">'-v'</span><span class="p">]</span>
    <span class="n">num_workers</span> <span class="o">=</span> <span class="n">_get_num_workers</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_workers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">'-j'</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_workers</span><span class="p">)])</span>
    <span class="n">env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Try to activate the vc env for the users</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="ow">and</span> <span class="s1">'VSCMD_ARG_TGT_ARCH'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">env</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">distutils</span>

        <span class="n">plat_name</span> <span class="o">=</span> <span class="n">distutils</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_platform</span><span class="p">()</span>
        <span class="n">plat_spec</span> <span class="o">=</span> <span class="n">PLAT_TO_VCVARS</span><span class="p">[</span><span class="n">plat_name</span><span class="p">]</span>
        <span class="n">vc_env</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_get_vc_env</span><span class="p">(</span><span class="n">plat_spec</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">env</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">uk</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">uk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vc_env</span><span class="p">:</span>
                <span class="n">vc_env</span><span class="p">[</span><span class="n">uk</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">vc_env</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="c1"># Warning: don't pass stdout=None to subprocess.run to get output.</span>
        <span class="c1"># subprocess.run assumes that sys.__stdout__ has not been modified and</span>
        <span class="c1"># attempts to write to it by default.  However, when we call _run_ninja_build</span>
        <span class="c1"># from ahead-of-time cpp extensions, the following happens:</span>
        <span class="c1"># 1) If the stdout encoding is not utf-8, setuptools detachs __stdout__.</span>
        <span class="c1">#    https://github.com/pypa/setuptools/blob/7e97def47723303fafabe48b22168bbc11bb4821/setuptools/dist.py#L1110</span>
        <span class="c1">#    (it probably shouldn't do this)</span>
        <span class="c1"># 2) subprocess.run (on POSIX, with no stdout override) relies on</span>
        <span class="c1">#    __stdout__ not being detached:</span>
        <span class="c1">#    https://github.com/python/cpython/blob/c352e6c7446c894b13643f538db312092b351789/Lib/subprocess.py#L1214</span>
        <span class="c1"># To work around this, we pass in the fileno directly and hope that</span>
        <span class="c1"># it is valid.</span>
        <span class="n">stdout_fileno</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">command</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">stdout_fileno</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="n">build_directory</span><span class="p">,</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Python 2 and 3 compatible way of getting the error object.</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="c1"># error.output contains the stdout and stderr of the build attempt.</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">error_prefix</span>
        <span class="c1"># `error` is a CalledProcessError (which has an `output`) attribute, but</span>
        <span class="c1"># mypy thinks it's Optional[BaseException] and doesn't narrow</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s1">'output'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">error</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>  <span class="c1"># type: ignore[union-attr]</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">": </span><span class="si">{</span><span class="n">error</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">SUBPROCESS_DECODE_ARGS</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>  <span class="c1"># type: ignore[union-attr]</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>


<span class="k">def</span> <span class="nf">_get_exec_path</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="ow">and</span> <span class="n">TORCH_LIB_PATH</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'PATH'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">):</span>
        <span class="n">torch_lib_in_path</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">TORCH_LIB_PATH</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'PATH'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">';'</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">torch_lib_in_path</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'PATH'</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">TORCH_LIB_PATH</span><span class="si">}</span><span class="s2">;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'PATH'</span><span class="p">,</span><span class="w"> </span><span class="s1">''</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">module_name</span><span class="si">}{</span><span class="n">EXEC_EXT</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_import_module_from_library</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">is_python_module</span><span class="p">):</span>
    <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">module_name</span><span class="si">}{</span><span class="n">LIB_EXT</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_python_module</span><span class="p">:</span>
        <span class="c1"># https://stackoverflow.com/questions/67631/how-to-import-a-module-given-the-full-path</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">spec_from_file_location</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">module_from_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="p">,</span> <span class="n">importlib</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">exec_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">module</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">load_library</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">filepath</span>


<span class="k">def</span> <span class="nf">_write_ninja_file_to_build_library</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                       <span class="n">name</span><span class="p">,</span>
                                       <span class="n">sources</span><span class="p">,</span>
                                       <span class="n">extra_cflags</span><span class="p">,</span>
                                       <span class="n">extra_cuda_cflags</span><span class="p">,</span>
                                       <span class="n">extra_sycl_cflags</span><span class="p">,</span>
                                       <span class="n">extra_ldflags</span><span class="p">,</span>
                                       <span class="n">extra_include_paths</span><span class="p">,</span>
                                       <span class="n">with_cuda</span><span class="p">,</span>
                                       <span class="n">with_sycl</span><span class="p">,</span>
                                       <span class="n">is_standalone</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">extra_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">extra_cflags</span><span class="p">]</span>
    <span class="n">extra_cuda_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">extra_cuda_cflags</span><span class="p">]</span>
    <span class="n">extra_sycl_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">extra_sycl_cflags</span><span class="p">]</span>
    <span class="n">extra_ldflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">extra_ldflags</span><span class="p">]</span>
    <span class="n">extra_include_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">extra_include_paths</span><span class="p">]</span>

    <span class="c1"># Turn into absolute paths so we can emit them into the ninja build</span>
    <span class="c1"># file wherever it is.</span>
    <span class="n">user_includes</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">extra_include_paths</span><span class="p">]</span>

    <span class="c1"># include_paths() gives us the location of torch/extension.h</span>
    <span class="c1"># TODO generalize with_cuda as specific device type.</span>
    <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
        <span class="n">system_includes</span> <span class="o">=</span> <span class="n">include_paths</span><span class="p">(</span><span class="s2">"cuda"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">system_includes</span> <span class="o">=</span> <span class="n">include_paths</span><span class="p">(</span><span class="s2">"cpu"</span><span class="p">)</span>
    <span class="c1"># sysconfig.get_path('include') gives us the location of Python.h</span>
    <span class="c1"># Explicitly specify 'posix_prefix' scheme on non-Windows platforms to workaround error on some MacOS</span>
    <span class="c1"># installations where default `get_path` points to non-existing `/Library/Python/M.m/include` folder</span>
    <span class="n">python_include_path</span> <span class="o">=</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="s1">'include'</span><span class="p">,</span> <span class="n">scheme</span><span class="o">=</span><span class="s1">'nt'</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="s1">'posix_prefix'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">python_include_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">system_includes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">python_include_path</span><span class="p">)</span>

    <span class="n">common_cflags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_standalone</span><span class="p">:</span>
        <span class="n">common_cflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-DTORCH_EXTENSION_NAME=</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">common_cflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-DTORCH_API_INCLUDE_EXTENSION_H'</span><span class="p">)</span>

    <span class="n">common_cflags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_get_pybind11_abi_build_flags</span><span class="p">()]</span>

    <span class="c1"># Windows does not understand `-isystem` and quotes flags later.</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">common_cflags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'-I</span><span class="si">{</span><span class="n">include</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">include</span> <span class="ow">in</span> <span class="n">user_includes</span> <span class="o">+</span> <span class="n">system_includes</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">common_cflags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'-I</span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">include</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">include</span> <span class="ow">in</span> <span class="n">user_includes</span><span class="p">]</span>
        <span class="n">common_cflags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'-isystem </span><span class="si">{</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">include</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span> <span class="k">for</span> <span class="n">include</span> <span class="ow">in</span> <span class="n">system_includes</span><span class="p">]</span>

    <span class="n">common_cflags</span> <span class="o">+=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">"</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_get_glibcxx_abi_build_flags</span><span class="p">()]</span>

    <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">cflags</span> <span class="o">=</span> <span class="n">common_cflags</span> <span class="o">+</span> <span class="n">COMMON_MSVC_FLAGS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'/std:c++17'</span><span class="p">]</span> <span class="o">+</span> <span class="n">extra_cflags</span>
        <span class="n">cflags</span> <span class="o">=</span> <span class="n">_nt_quote_args</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cflags</span> <span class="o">=</span> <span class="n">common_cflags</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'-fPIC'</span><span class="p">,</span> <span class="s1">'-std=c++17'</span><span class="p">]</span> <span class="o">+</span> <span class="n">extra_cflags</span>

    <span class="k">if</span> <span class="n">with_cuda</span> <span class="ow">and</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
        <span class="n">cuda_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'-DWITH_HIP'</span><span class="p">]</span> <span class="o">+</span> <span class="n">cflags</span> <span class="o">+</span> <span class="n">COMMON_HIP_FLAGS</span> <span class="o">+</span> <span class="n">COMMON_HIPCC_FLAGS</span>
        <span class="n">cuda_flags</span> <span class="o">+=</span> <span class="n">extra_cuda_cflags</span>
        <span class="n">cuda_flags</span> <span class="o">+=</span> <span class="n">_get_rocm_arch_flags</span><span class="p">(</span><span class="n">cuda_flags</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">with_cuda</span><span class="p">:</span>
        <span class="n">cuda_flags</span> <span class="o">=</span> <span class="n">common_cflags</span> <span class="o">+</span> <span class="n">COMMON_NVCC_FLAGS</span> <span class="o">+</span> <span class="n">_get_cuda_arch_flags</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">COMMON_MSVC_FLAGS</span><span class="p">:</span>
                <span class="n">cuda_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'-Xcompiler'</span><span class="p">,</span> <span class="n">flag</span><span class="p">]</span> <span class="o">+</span> <span class="n">cuda_flags</span>
            <span class="k">for</span> <span class="n">ignore_warning</span> <span class="ow">in</span> <span class="n">MSVC_IGNORE_CUDAFE_WARNINGS</span><span class="p">:</span>
                <span class="n">cuda_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'-Xcudafe'</span><span class="p">,</span> <span class="s1">'--diag_suppress='</span> <span class="o">+</span> <span class="n">ignore_warning</span><span class="p">]</span> <span class="o">+</span> <span class="n">cuda_flags</span>
            <span class="n">cuda_flags</span> <span class="o">=</span> <span class="n">cuda_flags</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'-std=c++17'</span><span class="p">]</span>
            <span class="n">cuda_flags</span> <span class="o">=</span> <span class="n">_nt_quote_args</span><span class="p">(</span><span class="n">cuda_flags</span><span class="p">)</span>
            <span class="n">cuda_flags</span> <span class="o">+=</span> <span class="n">_nt_quote_args</span><span class="p">(</span><span class="n">extra_cuda_cflags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cuda_flags</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">'--compiler-options'</span><span class="p">,</span> <span class="s2">"'-fPIC'"</span><span class="p">]</span>
            <span class="n">cuda_flags</span> <span class="o">+=</span> <span class="n">extra_cuda_cflags</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'-std='</span><span class="p">)</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">cuda_flags</span><span class="p">):</span>
                <span class="n">cuda_flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-std=c++17'</span><span class="p">)</span>
            <span class="n">cc_env</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"CC"</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cc_env</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cuda_flags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'-ccbin'</span><span class="p">,</span> <span class="n">cc_env</span><span class="p">]</span> <span class="o">+</span> <span class="n">cuda_flags</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cuda_flags</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">with_sycl</span><span class="p">:</span>
        <span class="n">sycl_cflags</span> <span class="o">=</span> <span class="n">cflags</span> <span class="o">+</span> <span class="n">_COMMON_SYCL_FLAGS</span>
        <span class="n">sycl_cflags</span> <span class="o">+=</span> <span class="n">extra_sycl_cflags</span>
        <span class="n">_append_sycl_std_if_no_std_present</span><span class="p">(</span><span class="n">sycl_cflags</span><span class="p">)</span>
        <span class="n">host_cflags</span> <span class="o">=</span> <span class="n">cflags</span>
        <span class="c1"># escaping quoted arguments to pass them thru SYCL compiler</span>
        <span class="n">host_cflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\\</span><span class="s1">"'</span><span class="p">,</span> <span class="s1">'</span><span class="se">\\\\</span><span class="s1">"'</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">host_cflags</span><span class="p">]</span>
        <span class="n">host_cflags</span> <span class="o">=</span> <span class="s1">' '</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">host_cflags</span><span class="p">)</span>
        <span class="n">sycl_cflags</span> <span class="o">+=</span> <span class="n">_wrap_sycl_host_flags</span><span class="p">(</span><span class="n">host_cflags</span><span class="p">)</span>
        <span class="n">sycl_dlink_post_cflags</span> <span class="o">=</span> <span class="n">_SYCL_DLINK_FLAGS</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sycl_cflags</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sycl_dlink_post_cflags</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">object_file_path</span><span class="p">(</span><span class="n">source_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># '/path/to/file.cpp' -&gt; 'file'</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">source_file</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_is_cuda_file</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">with_cuda</span><span class="p">:</span>
            <span class="c1"># Use a different object filename in case a C++ and CUDA file have</span>
            <span class="c1"># the same filename but different extension (.cpp vs. .cu).</span>
            <span class="n">target</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">.cuda.o'</span>
        <span class="k">elif</span> <span class="n">_is_sycl_file</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">with_sycl</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">.sycl.o'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s1">.o'</span>
        <span class="k">return</span> <span class="n">target</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">object_file_path</span><span class="p">(</span><span class="n">src</span><span class="p">)</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]</span>
    <span class="n">ldflags</span> <span class="o">=</span> <span class="p">([]</span> <span class="k">if</span> <span class="n">is_standalone</span> <span class="k">else</span> <span class="p">[</span><span class="n">SHARED_FLAG</span><span class="p">])</span> <span class="o">+</span> <span class="n">extra_ldflags</span>

    <span class="c1"># The darwin linker needs explicit consent to ignore unresolved symbols.</span>
    <span class="k">if</span> <span class="n">IS_MACOS</span><span class="p">:</span>
        <span class="n">ldflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'-undefined dynamic_lookup'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">ldflags</span> <span class="o">=</span> <span class="n">_nt_quote_args</span><span class="p">(</span><span class="n">ldflags</span><span class="p">)</span>

    <span class="n">ext</span> <span class="o">=</span> <span class="n">EXEC_EXT</span> <span class="k">if</span> <span class="n">is_standalone</span> <span class="k">else</span> <span class="n">LIB_EXT</span>
    <span class="n">library_target</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s1">'</span>

    <span class="n">_write_ninja_file</span><span class="p">(</span>
        <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
        <span class="n">cflags</span><span class="o">=</span><span class="n">cflags</span><span class="p">,</span>
        <span class="n">post_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cuda_cflags</span><span class="o">=</span><span class="n">cuda_flags</span><span class="p">,</span>
        <span class="n">cuda_post_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cuda_dlink_post_cflags</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sycl_cflags</span><span class="o">=</span><span class="n">sycl_cflags</span><span class="p">,</span>
        <span class="n">sycl_post_cflags</span><span class="o">=</span><span class="p">[],</span>
        <span class="n">sycl_dlink_post_cflags</span><span class="o">=</span><span class="n">sycl_dlink_post_cflags</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span>
        <span class="n">objects</span><span class="o">=</span><span class="n">objects</span><span class="p">,</span>
        <span class="n">ldflags</span><span class="o">=</span><span class="n">ldflags</span><span class="p">,</span>
        <span class="n">library_target</span><span class="o">=</span><span class="n">library_target</span><span class="p">,</span>
        <span class="n">with_cuda</span><span class="o">=</span><span class="n">with_cuda</span><span class="p">,</span>
        <span class="n">with_sycl</span><span class="o">=</span><span class="n">with_sycl</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_write_ninja_file</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                      <span class="n">cflags</span><span class="p">,</span>
                      <span class="n">post_cflags</span><span class="p">,</span>
                      <span class="n">cuda_cflags</span><span class="p">,</span>
                      <span class="n">cuda_post_cflags</span><span class="p">,</span>
                      <span class="n">cuda_dlink_post_cflags</span><span class="p">,</span>
                      <span class="n">sycl_cflags</span><span class="p">,</span>
                      <span class="n">sycl_post_cflags</span><span class="p">,</span>
                      <span class="n">sycl_dlink_post_cflags</span><span class="p">,</span>
                      <span class="n">sources</span><span class="p">,</span>
                      <span class="n">objects</span><span class="p">,</span>
                      <span class="n">ldflags</span><span class="p">,</span>
                      <span class="n">library_target</span><span class="p">,</span>
                      <span class="n">with_cuda</span><span class="p">,</span>
                      <span class="n">with_sycl</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">"""Write a ninja file that does the desired compiling and linking.</span>

<span class="sd">    `path`: Where to write this file</span>
<span class="sd">    `cflags`: list of flags to pass to $cxx. Can be None.</span>
<span class="sd">    `post_cflags`: list of flags to append to the $cxx invocation. Can be None.</span>
<span class="sd">    `cuda_cflags`: list of flags to pass to $nvcc. Can be None.</span>
<span class="sd">    `cuda_post_cflags`: list of flags to append to the $nvcc invocation. Can be None.</span>
<span class="sd">    `cuda_dlink_post_cflags`: list of flags to append to the $nvcc device code link invocation. Can be None.</span>
<span class="sd">    `sycl_cflags`: list of flags to pass to SYCL compiler. Can be None.</span>
<span class="sd">    `sycl_post_cflags`: list of flags to append to the SYCL compiler invocation. Can be None.</span>
<span class="sd">    `sycl_dlink_post_cflags`: list of flags to append to the SYCL compiler device code link invocation. Can be None.</span>
<span class="sd">e.</span>
<span class="sd">    `sources`: list of paths to source files</span>
<span class="sd">    `objects`: list of desired paths to objects, one per source.</span>
<span class="sd">    `ldflags`: list of flags to pass to linker. Can be None.</span>
<span class="sd">    `library_target`: Name of the output library. Can be None; in that case,</span>
<span class="sd">                      we do no linking.</span>
<span class="sd">    `with_cuda`: If we should be compiling with CUDA.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">sanitize_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">flags</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">flag</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">]</span>

    <span class="n">cflags</span> <span class="o">=</span> <span class="n">sanitize_flags</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span>
    <span class="n">post_cflags</span> <span class="o">=</span> <span class="n">sanitize_flags</span><span class="p">(</span><span class="n">post_cflags</span><span class="p">)</span>
    <span class="n">cuda_cflags</span> <span class="o">=</span> <span class="n">sanitize_flags</span><span class="p">(</span><span class="n">cuda_cflags</span><span class="p">)</span>
    <span class="n">cuda_post_cflags</span> <span class="o">=</span> <span class="n">sanitize_flags</span><span class="p">(</span><span class="n">cuda_post_cflags</span><span class="p">)</span>
    <span class="n">cuda_dlink_post_cflags</span> <span class="o">=</span> <span class="n">sanitize_flags</span><span class="p">(</span><span class="n">cuda_dlink_post_cflags</span><span class="p">)</span>
    <span class="n">sycl_cflags</span> <span class="o">=</span> <span class="n">sanitize_flags</span><span class="p">(</span><span class="n">sycl_cflags</span><span class="p">)</span>
    <span class="n">sycl_post_cflags</span> <span class="o">=</span> <span class="n">sanitize_flags</span><span class="p">(</span><span class="n">sycl_post_cflags</span><span class="p">)</span>
    <span class="n">sycl_dlink_post_cflags</span> <span class="o">=</span> <span class="n">sanitize_flags</span><span class="p">(</span><span class="n">sycl_dlink_post_cflags</span><span class="p">)</span>
    <span class="n">ldflags</span> <span class="o">=</span> <span class="n">sanitize_flags</span><span class="p">(</span><span class="n">ldflags</span><span class="p">)</span>

    <span class="c1"># Sanity checks...</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="n">compiler</span> <span class="o">=</span> <span class="n">get_cxx_compiler</span><span class="p">()</span>

    <span class="c1"># Version 1.3 is required for the `deps` directive.</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'ninja_required_version = 1.3'</span><span class="p">]</span>
    <span class="n">config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'cxx = </span><span class="si">{</span><span class="n">compiler</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_cuda</span> <span class="ow">or</span> <span class="n">cuda_dlink_post_cflags</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">"PYTORCH_NVCC"</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">nvcc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">"PYTORCH_NVCC"</span><span class="p">)</span>    <span class="c1"># user can set nvcc compiler with ccache using the environment variable here</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
                <span class="n">nvcc</span> <span class="o">=</span> <span class="n">_join_rocm_home</span><span class="p">(</span><span class="s1">'bin'</span><span class="p">,</span> <span class="s1">'hipcc'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nvcc</span> <span class="o">=</span> <span class="n">_join_cuda_home</span><span class="p">(</span><span class="s1">'bin'</span><span class="p">,</span> <span class="s1">'nvcc'</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'nvcc = </span><span class="si">{</span><span class="n">nvcc</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_sycl</span> <span class="ow">or</span> <span class="n">sycl_dlink_post_cflags</span><span class="p">:</span>
        <span class="n">sycl</span> <span class="o">=</span> <span class="s1">'icx'</span> <span class="k">if</span> <span class="n">IS_WINDOWS</span> <span class="k">else</span> <span class="s1">'icpx'</span>
        <span class="n">config</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'sycl = </span><span class="si">{</span><span class="n">sycl</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
        <span class="n">post_cflags</span> <span class="o">=</span> <span class="n">COMMON_HIP_FLAGS</span> <span class="o">+</span> <span class="n">post_cflags</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'cflags = </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cflags</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span>
    <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'post_cflags = </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">post_cflags</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'cuda_cflags = </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cuda_cflags</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'cuda_post_cflags = </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cuda_post_cflags</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'cuda_dlink_post_cflags = </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cuda_dlink_post_cflags</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">with_sycl</span><span class="p">:</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'sycl_cflags = </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sycl_cflags</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'sycl_post_cflags = </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sycl_post_cflags</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'sycl_dlink_post_cflags = </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sycl_dlink_post_cflags</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'ldflags = </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ldflags</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="c1"># Turn into absolute paths so we can emit them into the ninja build</span>
    <span class="c1"># file wherever it is.</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]</span>

    <span class="c1"># See https://ninja-build.org/build.ninja.html for reference.</span>
    <span class="n">compile_rule</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'rule compile'</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
        <span class="n">compile_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s1">'  command = cl /showIncludes $cflags -c $in /Fo$out $post_cflags'</span><span class="p">)</span>
        <span class="n">compile_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'  deps = msvc'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compile_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s1">'  command = $cxx -MMD -MF $out.d $cflags -c $in -o $out $post_cflags'</span><span class="p">)</span>
        <span class="n">compile_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'  depfile = $out.d'</span><span class="p">)</span>
        <span class="n">compile_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'  deps = gcc'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
        <span class="n">cuda_compile_rule</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'rule cuda_compile'</span><span class="p">]</span>
        <span class="n">nvcc_gendeps</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="c1"># --generate-dependencies-with-compile is not supported by ROCm</span>
        <span class="c1"># Nvcc flag `--generate-dependencies-with-compile` is not supported by sccache, which may increase build time.</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">cuda</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'TORCH_EXTENSION_SKIP_NVCC_GEN_DEPENDENCIES'</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">'1'</span><span class="p">:</span>
            <span class="n">cuda_compile_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'  depfile = $out.d'</span><span class="p">)</span>
            <span class="n">cuda_compile_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'  deps = gcc'</span><span class="p">)</span>
            <span class="c1"># Note: non-system deps with nvcc are only supported</span>
            <span class="c1"># on Linux so use --generate-dependencies-with-compile</span>
            <span class="c1"># to make this work on Windows too.</span>
            <span class="n">nvcc_gendeps</span> <span class="o">=</span> <span class="s1">'--generate-dependencies-with-compile --dependency-output $out.d'</span>
        <span class="n">cuda_compile_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">'  command = $nvcc </span><span class="si">{</span><span class="n">nvcc_gendeps</span><span class="si">}</span><span class="s1"> $cuda_cflags -c $in -o $out $cuda_post_cflags'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">with_sycl</span><span class="p">:</span>
        <span class="n">sycl_compile_rule</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'rule sycl_compile'</span><span class="p">]</span>
        <span class="c1"># SYCL compiler does not recognize .sycl extension automatically,</span>
        <span class="c1"># so we pass '-x c++' explicitly notifying compiler of file format</span>
        <span class="n">sycl_compile_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="s1">'  command = $sycl $sycl_cflags -c -x c++ $in -o $out $sycl_post_cflags'</span><span class="p">)</span>


    <span class="c1"># Emit one build rule per source to enable incremental build.</span>
    <span class="n">build</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">source_file</span><span class="p">,</span> <span class="n">object_file</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">objects</span><span class="p">):</span>
        <span class="n">is_cuda_source</span> <span class="o">=</span> <span class="n">_is_cuda_file</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">with_cuda</span>
        <span class="n">is_sycl_source</span> <span class="o">=</span> <span class="n">_is_sycl_file</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span> <span class="ow">and</span> <span class="n">with_sycl</span>
        <span class="k">if</span> <span class="n">is_cuda_source</span><span class="p">:</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="s1">'cuda_compile'</span>
        <span class="k">elif</span> <span class="n">is_sycl_source</span><span class="p">:</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="s1">'sycl_compile'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rule</span> <span class="o">=</span> <span class="s1">'compile'</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">source_file</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="s1">'$:'</span><span class="p">)</span>
            <span class="n">object_file</span> <span class="o">=</span> <span class="n">object_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="s1">'$:'</span><span class="p">)</span>
        <span class="n">source_file</span> <span class="o">=</span> <span class="n">source_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"$ "</span><span class="p">)</span>
        <span class="n">object_file</span> <span class="o">=</span> <span class="n">object_file</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="s2">"$ "</span><span class="p">)</span>
        <span class="n">build</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'build </span><span class="si">{</span><span class="n">object_file</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">rule</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">source_file</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cuda_dlink_post_cflags</span><span class="p">:</span>
        <span class="n">cuda_devlink_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">'dlink.o'</span><span class="p">)</span>
        <span class="n">cuda_devlink_rule</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'rule cuda_devlink'</span><span class="p">]</span>
        <span class="n">cuda_devlink_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'  command = $nvcc $in -o $out $cuda_dlink_post_cflags'</span><span class="p">)</span>
        <span class="n">cuda_devlink</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'build </span><span class="si">{</span><span class="n">cuda_devlink_out</span><span class="si">}</span><span class="s1">: cuda_devlink </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span>
        <span class="n">objects</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cuda_devlink_out</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cuda_devlink_rule</span><span class="p">,</span> <span class="n">cuda_devlink</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">sycl_dlink_post_cflags</span><span class="p">:</span>
        <span class="n">sycl_devlink_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">'sycl_dlink.o'</span><span class="p">)</span>
        <span class="n">sycl_devlink_rule</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'rule sycl_devlink'</span><span class="p">]</span>
        <span class="n">sycl_devlink_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'  command = $sycl $in -o $out $sycl_dlink_post_cflags'</span><span class="p">)</span>
        <span class="n">sycl_devlink</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'build </span><span class="si">{</span><span class="n">sycl_devlink_out</span><span class="si">}</span><span class="s1">: sycl_devlink </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span>
        <span class="n">objects</span> <span class="o">+=</span> <span class="p">[</span><span class="n">sycl_devlink_out</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sycl_devlink_rule</span><span class="p">,</span> <span class="n">sycl_devlink</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">library_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">link_rule</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'rule link'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">cl_paths</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">'where'</span><span class="p">,</span>
                                                <span class="s1">'cl'</span><span class="p">])</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="o">*</span><span class="n">SUBPROCESS_DECODE_ARGS</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'</span><span class="se">\r\n</span><span class="s1">'</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cl_paths</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cl_paths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">':'</span><span class="p">,</span> <span class="s1">'$:'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"MSVC is required to load C++ extensions"</span><span class="p">)</span>
            <span class="n">link_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">'  command = "</span><span class="si">{</span><span class="n">cl_path</span><span class="si">}</span><span class="s1">/link.exe" $in /nologo $ldflags /out:$out'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">link_rule</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'  command = $cxx $in $ldflags -o $out'</span><span class="p">)</span>

        <span class="n">link</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'build </span><span class="si">{</span><span class="n">library_target</span><span class="si">}</span><span class="s1">: link </span><span class="si">{</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span>

        <span class="n">default</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">'default </span><span class="si">{</span><span class="n">library_target</span><span class="si">}</span><span class="s1">'</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">link_rule</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

    <span class="c1"># 'Blocks' should be separated by newlines, for visual benefit.</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">compile_rule</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">with_cuda</span><span class="p">:</span>
        <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cuda_compile_rule</span><span class="p">)</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
    <span class="k">if</span> <span class="n">with_sycl</span><span class="p">:</span>
        <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sycl_compile_rule</span><span class="p">)</span>  <span class="c1"># type: ignore[possibly-undefined]</span>
    <span class="n">blocks</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cuda_devlink_rule</span><span class="p">,</span> <span class="n">sycl_devlink_rule</span><span class="p">,</span> <span class="n">link_rule</span><span class="p">,</span> <span class="n">build</span><span class="p">,</span> <span class="n">cuda_devlink</span><span class="p">,</span> <span class="n">sycl_devlink</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">default</span><span class="p">]</span>
    <span class="n">content</span> <span class="o">=</span> <span class="s2">"</span><span class="se">\n\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">)</span>
    <span class="c1"># Ninja requires a new lines at the end of the .ninja file</span>
    <span class="n">content</span> <span class="o">+=</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>
    <span class="n">_maybe_write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_join_cuda_home</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Join paths with CUDA_HOME, or raises an error if it CUDA_HOME is not set.</span>

<span class="sd">    This is basically a lazy way of raising an error for missing $CUDA_HOME</span>
<span class="sd">    only once we need to get any CUDA-specific path.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">CUDA_HOME</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">'CUDA_HOME environment variable is not set. '</span>
                      <span class="s1">'Please set it to your CUDA install root.'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CUDA_HOME</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_cuda_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">valid_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'.cu'</span><span class="p">,</span> <span class="s1">'.cuh'</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">IS_HIP_EXTENSION</span><span class="p">:</span>
        <span class="n">valid_ext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'.hip'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">valid_ext</span>

<span class="k">def</span> <span class="nf">_is_sycl_file</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">valid_ext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'.sycl'</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">valid_ext</span>
</pre>
        </div>
       </article>
      </div>
      <footer>
       <hr/>
       <div role="contentinfo">
        <p>
         © Copyright PyTorch Contributors.
        </p>
       </div>
       <div>
        Built with
        <a href="http://sphinx-doc.org/">
         Sphinx
        </a>
        using a
        <a href="https://github.com/rtfd/sphinx_rtd_theme">
         theme
        </a>
        provided by
        <a href="https://readthedocs.org">
         Read the Docs
        </a>
        .
       </div>
      </footer>
     </div>
     <script>
      var match = window.location.href.match(/\/_[a-zA-Z0-9_]*.html|_dynamo/gi);
var url = window.location.href.lastIndexOf(match[match.length-1]);

if (url)
  {
    var div = '<div class="admonition note"><p class="admonition-title">Note</p><p><i class="fa fa-exclamation-circle" aria-hidden="true">&nbsp</i> This page describes an internal API which is not intended to be used outside of the PyTorch codebase and can be modified or removed without notice.</p></div>'
    document.getElementById("pytorch-article").insertAdjacentHTML('afterBegin', div)
  }
     </script>
    </div>
    <div class="pytorch-content-right" id="pytorch-content-right">
     <div class="pytorch-right-menu" id="pytorch-right-menu">
      <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
      </div>
     </div>
    </div>
   </section>
  </div>
  <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js" type="text/javascript">
  </script>
  <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js">
  </script>
  <script src="../../../_static/jquery.js">
  </script>
  <script src="../../../_static/underscore.js">
  </script>
  <script src="../../../_static/_sphinx_javascript_frameworks_compat.js">
  </script>
  <script src="../../../_static/doctools.js">
  </script>
  <script src="../../../_static/sphinx_highlight.js">
  </script>
  <script src="../../../_static/clipboard.min.js">
  </script>
  <script src="../../../_static/copybutton.js">
  </script>
  <script src="../../../_static/js/vendor/popper.min.js" type="text/javascript">
  </script>
  <script src="../../../_static/js/vendor/bootstrap.min.js" type="text/javascript">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js">
  </script>
  <script src="../../../_static/js/theme.js" type="text/javascript">
  </script>
  <script type="text/javascript">
   jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
  <script script="" type="text/javascript">
   var collapsedSections = ['Developer Notes', 'Language Bindings', 'Libraries', 'Community'];
  </script>
  <img alt="" height="1" src="https://www.googleadservices.com/pagead/conversion/795629140/?label=txkmCPmdtosBENSssfsC&amp;guid=ON&amp;script=0" style="border-style:none;" width="1"/>
  <!-- Begin Footer -->
  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
   <div class="container">
    <div class="row">
     <div class="col-md-4 text-center">
      <h2>
       Docs
      </h2>
      <p>
       Access comprehensive developer documentation for PyTorch
      </p>
      <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">
       View Docs
      </a>
     </div>
     <div class="col-md-4 text-center">
      <h2>
       Tutorials
      </h2>
      <p>
       Get in-depth tutorials for beginners and advanced developers
      </p>
      <a class="with-right-arrow" href="https://pytorch.org/tutorials">
       View Tutorials
      </a>
     </div>
     <div class="col-md-4 text-center">
      <h2>
       Resources
      </h2>
      <p>
       Find development resources and get your questions answered
      </p>
      <a class="with-right-arrow" href="https://pytorch.org/resources">
       View Resources
      </a>
     </div>
    </div>
   </div>
  </div>
  <footer class="site-footer">
   <div class="container footer-container">
    <div class="footer-logo-wrapper">
     <a class="footer-logo" href="https://pytorch.org/">
     </a>
    </div>
    <div class="footer-links-wrapper">
     <div class="footer-links-col">
      <ul>
       <li class="list-title">
        <a href="https://pytorch.org/">
         PyTorch
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/get-started">
         Get Started
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/features">
         Features
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/ecosystem">
         Ecosystem
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/blog/">
         Blog
        </a>
       </li>
       <li>
        <a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">
         Contributing
        </a>
       </li>
      </ul>
     </div>
     <div class="footer-links-col">
      <ul>
       <li class="list-title">
        <a href="https://pytorch.org/resources">
         Resources
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/tutorials">
         Tutorials
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/docs/stable/index.html">
         Docs
        </a>
       </li>
       <li>
        <a href="https://discuss.pytorch.org" target="_blank">
         Discuss
        </a>
       </li>
       <li>
        <a href="https://github.com/pytorch/pytorch/issues" target="_blank">
         Github Issues
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">
         Brand Guidelines
        </a>
       </li>
      </ul>
     </div>
     <div class="footer-links-col">
      <ul>
       <li class="list-title">
        Stay up to date
       </li>
       <li>
        <a href="https://www.facebook.com/pytorch" target="_blank">
         Facebook
        </a>
       </li>
       <li>
        <a href="https://twitter.com/pytorch" target="_blank">
         Twitter
        </a>
       </li>
       <li>
        <a href="https://www.youtube.com/pytorch" target="_blank">
         YouTube
        </a>
       </li>
       <li>
        <a href="https://www.linkedin.com/company/pytorch" target="_blank">
         LinkedIn
        </a>
       </li>
      </ul>
     </div>
     <div class="footer-links-col">
      <ul>
       <li class="list-title">
        PyTorch Podcasts
       </li>
       <li>
        <a href="https://open.spotify.com/show/6UzHKeiy368jKfQMKKvJY5" target="_blank">
         Spotify
        </a>
       </li>
       <li>
        <a href="https://podcasts.apple.com/us/podcast/pytorch-developer-podcast/id1566080008" target="_blank">
         Apple
        </a>
       </li>
       <li>
        <a href="https://www.google.com/podcasts?feed=aHR0cHM6Ly9mZWVkcy5zaW1wbGVjYXN0LmNvbS9PQjVGa0lsOA%3D%3D" target="_blank">
         Google
        </a>
       </li>
       <li>
        <a href="https://music.amazon.com/podcasts/7a4e6f0e-26c2-49e9-a478-41bd244197d0/PyTorch-Developer-Podcast?" target="_blank">
         Amazon
        </a>
       </li>
      </ul>
     </div>
    </div>
    <div class="privacy-policy">
     <ul>
      <li class="privacy-policy-links">
       <a href="https://www.linuxfoundation.org/terms/" target="_blank">
        Terms
       </a>
      </li>
      <li class="privacy-policy-links">
       |
      </li>
      <li class="privacy-policy-links">
       <a href="https://www.linuxfoundation.org/privacy-policy/" target="_blank">
        Privacy
       </a>
      </li>
     </ul>
    </div>
    <div class="copyright">
     <p>
      © Copyright The Linux Foundation. The PyTorch Foundation is a project of The Linux Foundation.
          For web site terms of use, trademark policy and other policies applicable to The PyTorch Foundation please see
      <a href="https://www.linuxfoundation.org/policies/">
       www.linuxfoundation.org/policies/
      </a>
      . The PyTorch Foundation supports the PyTorch open source
          project, which has been established as PyTorch Project a Series of LF Projects, LLC. For policies applicable to the PyTorch Project a Series of LF Projects, LLC,
          please see
      <a href="https://www.lfprojects.org/policies/">
       www.lfprojects.org/policies/
      </a>
      .
     </p>
    </div>
   </div>
  </footer>
  <div class="cookie-banner-wrapper">
   <div class="container">
    <p class="gdpr-notice">
     To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebook’s Cookies Policy applies. Learn more, including about available controls:
     <a href="https://www.facebook.com/policies/cookies/">
      Cookies Policy
     </a>
     .
    </p>
    <img class="close-button" src="../../../_static/images/pytorch-x.svg"/>
   </div>
  </div>
  <!-- End Footer -->
  <!-- Begin Mobile Menu -->
  <div class="mobile-main-menu">
   <div class="container-fluid">
    <div class="container">
     <div class="mobile-main-menu-header-container">
      <a aria-label="PyTorch" class="header-logo" href="https://pytorch.org/">
      </a>
      <a class="main-menu-close-button" data-behavior="close-mobile-menu" href="#">
      </a>
     </div>
    </div>
   </div>
   <div class="mobile-main-menu-links-container">
    <div class="main-menu">
     <ul>
      <li class="resources-mobile-menu-title">
       <a>
        Learn
       </a>
      </li>
      <ul class="resources-mobile-menu-items">
       <li>
        <a href="https://pytorch.org/get-started">
         Get Started
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/tutorials">
         Tutorials
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/tutorials/beginner/basics/intro.html">
         Learn the Basics
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/tutorials/recipes/recipes_index.html">
         PyTorch Recipes
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/tutorials/beginner/introyt.html">
         Introduction to PyTorch - YouTube Series
        </a>
       </li>
      </ul>
      <li class="resources-mobile-menu-title">
       <a>
        Ecosystem
       </a>
      </li>
      <ul class="resources-mobile-menu-items">
       <li>
        <a href="https://pytorch.org/ecosystem">
         Tools
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/#community-module">
         Community
        </a>
       </li>
       <li>
        <a href="https://discuss.pytorch.org/">
         Forums
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/resources">
         Developer Resources
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/ecosystem/contributor-awards-2023">
         Contributor Awards - 2024
        </a>
       </li>
      </ul>
      <li class="resources-mobile-menu-title">
       <a>
        Edge
       </a>
      </li>
      <ul class="resources-mobile-menu-items">
       <li>
        <a href="https://pytorch.org/edge">
         About PyTorch Edge
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/executorch-overview">
         ExecuTorch
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/executorch/stable/index.html">
         ExecuTorch Documentation
        </a>
       </li>
      </ul>
      <li class="resources-mobile-menu-title">
       <a>
        Docs
       </a>
      </li>
      <ul class="resources-mobile-menu-items">
       <li>
        <a href="https://pytorch.org/docs/stable/index.html">
         PyTorch
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/pytorch-domains">
         PyTorch Domains
        </a>
       </li>
      </ul>
      <li class="resources-mobile-menu-title">
       <a>
        Blog &amp; News
       </a>
      </li>
      <ul class="resources-mobile-menu-items">
       <li>
        <a href="https://pytorch.org/blog/">
         PyTorch Blog
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/community-blog">
         Community Blog
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/videos">
         Videos
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/community-stories">
         Community Stories
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/events">
         Events
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/newsletter">
         Newsletter
        </a>
       </li>
      </ul>
      <li class="resources-mobile-menu-title">
       <a>
        About
       </a>
      </li>
      <ul class="resources-mobile-menu-items">
       <li>
        <a href="https://pytorch.org/foundation">
         PyTorch Foundation
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/governing-board">
         Governing Board
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/credits">
         Cloud Credit Program
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/tac">
         Technical Advisory Council
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/staff">
         Staff
        </a>
       </li>
       <li>
        <a href="https://pytorch.org/contact-us">
         Contact Us
        </a>
       </li>
      </ul>
     </ul>
    </div>
   </div>
  </div>
  <!-- End Mobile Menu -->
  <script src="../../../_static/js/vendor/anchor.min.js" type="text/javascript">
  </script>
  <script type="text/javascript">
   $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
 </body>
</html>
